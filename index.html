<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对簿AI ContractClarity - 专家级 AI 合同审查</title>
    <!-- 外部依赖库 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- OCR 文字识别库 -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- PDF 解析库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Word 文档解析库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Fraunces:wght@700;900&display=swap"
        rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            color: #1e293b;
            overflow-x: hidden;
        }

        /* ── 噪声纹理叠加层 ── */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1;
            opacity: 0.15;
        }

        /* ── 网格点阵背景 ── */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image: radial-gradient(rgba(99,102,241,0.12) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        /* ════════════════════════════════════════════════════════
        ★ 管理员控制台专属样式 (完全对齐原本代码)
        ════════════════════════════════════════════════════════ */
        .admin-panel-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: flex; align-items: flex-start; justify-content: center;
            padding: 40px 16px; overflow-y: auto;
        }
        .admin-panel-modal {
            width: 100%; max-width: 960px;
            background: linear-gradient(135deg, rgba(248,250,255,0.99), rgba(241,245,255,0.99));
            border: 1px solid rgba(99,102,241,0.3); border-radius: 24px;
            overflow: hidden;
            animation: modalIn 0.35s cubic-bezier(0.16,1,0.3,1) forwards;
        }
        .admin-tab { 
            padding: 8px 18px; border-radius: 10px; font-size: 12px; font-weight: 700;
            cursor: pointer; transition: all 0.2s; color: #64748b; background: transparent; border: none;
        }
        .admin-tab.active { background: rgba(99,102,241,0.15); color: #818cf8; }
        .admin-tab:hover:not(.active) { background: rgba(255,255,255,0.04); }

        .admin-user-row { 
            padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex; align-items: center; gap: 12px; transition: background 0.15s; 
        }
        .admin-user-row:hover { background: rgba(99,102,241,0.04); }

        .perm-chip { 
            display: inline-flex; padding: 1px 7px; border-radius: 6px; font-size: 9px;
            font-weight: 700; background: rgba(99,102,241,0.1); color: #818cf8;
            border: 1px solid rgba(99,102,241,0.15); margin: 1px; 
        }
        .security-stat-card {
            background: rgba(241,245,255,0.8); border: 1px solid rgba(0,0,0,0.08);
            border-radius: 14px; padding: 16px 20px; text-align: center;
        }
        .role-badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 10px; border-radius: 999px; font-size: 10px; font-weight: 900;
        }
        .role-admin { background: rgba(245,158,11,0.15); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
        .role-legal_staff { background: rgba(99,102,241,0.15); color: #818cf8; border: 1px solid rgba(99,102,241,0.3); }
        .role-employee { background: rgba(16,185,129,0.15); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }

        /* ── 动态背景 ── */
        .bg-orbs {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.12;
            animation: orbFloat 18s ease-in-out infinite;
        }
        .orb-1 { width: 700px; height: 700px; background: #3b82f6; top: -250px; left: -200px; animation-delay: 0s; opacity: 0.06; }
        .orb-2 { width: 550px; height: 550px; background: #a855f7; top: 30%; right: -150px; animation-delay: -6s; opacity: 0.05; }
        .orb-3 { width: 450px; height: 450px; background: #06b6d4; bottom: -100px; left: 30%; animation-delay: -12s; opacity: 0.05; }
        .orb-4 { width: 300px; height: 300px; background: #f472b6; top: 60%; left: 10%; animation-delay: -4s; opacity: 0.03; }
        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33%       { transform: translate(40px, -60px) scale(1.05); }
            66%       { transform: translate(-30px, 40px) scale(0.95); }
        }

        /* ── 扫描线动画 ── */
        @keyframes scanLine {
            0%   { transform: translateY(-100%); opacity: 0.6; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        .scan-line {
            position: fixed;
            left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(59,130,246,0.5), transparent);
            animation: scanLine 6s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        .display-font { font-family: 'Fraunces', serif; }

        .glass-card {
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 2rem;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.8) inset, 0 20px 60px -20px rgba(0,0,0,0.15);
        }
        .glass-card-light {
            background: rgba(255,255,255,0.65);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 1.5rem;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.7) inset;
        }

        .gradient-text {
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 45%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 20px rgba(99,102,241,0.3));
        }
        .gradient-text-green {
            background: linear-gradient(135deg, #34d399, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ── 风险等级 ── */
        .risk-极高, .risk-Critical, .risk-Très élevé, .risk-Sehr hoch, .risk-Muy alto {
            background: #ef4444; box-shadow: 0 0 30px rgba(239,68,68,0.4); color: white;
        }
        .risk-高, .risk-High, .risk-Élevé, .risk-Hoch, .risk-Alto {
            background: #f97316; box-shadow: 0 0 30px rgba(249,115,22,0.4); color: white;
        }
        .risk-中, .risk-Medium, .risk-Moyen, .risk-Mittel, .risk-Medio {
            background: #fbbf24; box-shadow: 0 0 30px rgba(251,191,36,0.4); color: #1e293b;
        }
        .risk-低, .risk-Low, .risk-Faible, .risk-Niedrig, .risk-Bajo {
            background: #10b981; box-shadow: 0 0 30px rgba(16,185,129,0.4); color: white;
        }

        .border-极高, .border-Critical { border-color: #ef4444 !important; border-width: 2px; }
        .border-高,  .border-High     { border-color: #f97316 !important; border-width: 2px; }
        .border-中,  .border-Medium   { border-color: #fbbf24 !important; border-width: 2px; }
        .border-低,  .border-Low      { border-color: #10b981 !important; border-width: 2px; }

        .highlight-极高, .highlight-Critical { background: rgba(239,68,68,0.3); border-bottom: 2px solid #ef4444; }
        .highlight-高,   .highlight-High     { background: rgba(249,115,22,0.3); border-bottom: 2px solid #f97316; }
        .highlight-中,   .highlight-Medium   { background: rgba(251,191,36,0.3); border-bottom: 2px solid #fbbf24; }
        .highlight-低,   .highlight-Low      { background: rgba(16,185,129,0.3); border-bottom: 2px solid #10b981; }

        /* ── 合同文本 ── */
        .text-view-box {
            height: 100%;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 2;
            color: #475569;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 2rem;
            border: 1px solid rgba(0,0,0,0.08);
        }

        .revised-contract-box {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 2;
            color: #334155;
            background: rgba(0,100,60,0.03);
            padding: 2rem;
            border-radius: 1.5rem;
            border: 1px solid rgba(16,185,129,0.15);
            font-size: 0.9rem;
        }

        /* ── 修订标记高亮 ── */
        .revised-contract-box .revision-marker {
            background: rgba(16,185,129,0.2);
            border-left: 3px solid #10b981;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            color: #6ee7b7;
            font-weight: 700;
        }

        /* ── 滚动条 ── */
        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        /* ── 标签按钮 ── */
        .tab-btn-active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            box-shadow: 0 8px 20px rgba(59,130,246,0.35), 0 0 0 1px rgba(255,255,255,0.1) inset;
        }

        /* ── 动画 ── */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .animate-up { animation: slideUp 0.6s ease-out forwards; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        @keyframes pulse-ring {
            0%   { transform: scale(1);   opacity: 0.8; }
            100% { transform: scale(1.8); opacity: 0; }
        }
        .pulse-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 2px solid #3b82f6;
            animation: pulse-ring 2s cubic-bezier(0.4,0,0.6,1) infinite;
        }

        /* ── 仪表盘 ── */
        .gauge-ring { transition: stroke-dasharray 2s ease-in-out; }

        /* ── 语言选择器 ── */
        .lang-selector {
            appearance: none;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(0,0,0,0.12);
            color: #334155;
            padding: 0.4rem 2rem 0.4rem 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            transition: all 0.2s;
        }
        .lang-selector:hover { border-color: rgba(99,102,241,0.6); }
        .lang-selector:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }

        /* ── Markdown 样式 ── */
        .negotiation-markdown strong { color: #2563eb !important; font-weight: 800; }

        /* ── 进度条 ── */
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .progress-bar { animation: progressPulse 1.5s ease-in-out infinite; }

        /* ── 字数条 ── */
        .char-bar-fill { transition: width 0.3s ease; }
        .char-bar-warn  { background: #f97316; }
        .char-bar-ok    { background: linear-gradient(90deg, #3b82f6, #8b5cf6); }
        .char-bar-error { background: #ef4444; }

        /* ── 卡片悬停 ── */
        .hover-lift { transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.25s ease; }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 24px 48px rgba(0,0,0,0.1), 0 0 0 1px rgba(99,102,241,0.1); }

        /* ── OCR 进행 ── */
        @keyframes typing {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0; }
        }
        .cursor-blink { animation: typing 0.8s steps(1) infinite; }

        /* ── 风险分布条 ── */
        .risk-bar { transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }

        /* ── 修订合同 Tab ── */
        .revision-note-card {
            border-left: 3px solid #10b981;
            padding: 0.75rem 1rem;
            background: rgba(16,185,129,0.05);
            border-radius: 0 0.75rem 0.75rem 0;
        }

        /* ── 文件上传拖拽 ── */
        .upload-zone { transition: all 0.3s ease; }
        .upload-zone.drag-over {
            border-color: rgba(99,102,241,0.8) !important;
            background: rgba(99,102,241,0.08) !important;
            transform: scale(1.01);
        }

        /* ══════════════════════════════════════════════════ */
        /* ── 登录页面 ──                                      */
        /* ══════════════════════════════════════════════════ */
        .login-input {
            width: 100%;
            background: rgba(255,255,255,0.85);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 1rem;
            padding: 0.95rem 1.25rem;
            color: #1e293b;
            font-size: 0.95rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05) inset;
        }
        .login-input:focus {
            border-color: rgba(99,102,241,0.55);
            background: rgba(99,102,241,0.06);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.12), 0 2px 8px rgba(0,0,0,0.2) inset;
        }
        .login-input::placeholder { color: rgba(71,85,105,0.5); }

        .social-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.7rem;
            border-radius: 0.875rem;
            border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.7);
            color: #475569;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .social-btn:hover { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.15); color: #1e293b; }

        /* ══════════════════════════════════════════════════ */
        /* ── 个人中心 ──                                      */
        /* ══════════════════════════════════════════════════ */
        .profile-nav-btn {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748b;
            font-weight: 600;
            font-size: 0.875rem;
            background: transparent;
            border: none;
        }
        .profile-nav-btn:hover { background: rgba(0,0,0,0.05); color: #334155; }
        .profile-nav-btn.active { background: rgba(99,102,241,0.15); color: #818cf8; }

        .stat-card {
            background: rgba(255,255,255,0.75);
            border: 1px solid rgba(0,0,0,0.07);
            border-radius: 1.5rem;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(0,0,0,0.12); }

        .history-card {
            background: rgba(255,255,255,0.75);
            border: 1px solid rgba(0,0,0,0.07);
            border-radius: 1.25rem;
            padding: 1.1rem 1.4rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
        }
        .history-card:hover { border-color: rgba(99,102,241,0.35); background: rgba(99,102,241,0.05); }

        .avatar-circle {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            flex-shrink: 0;
        }

        .toggle-track {
            width: 44px; height: 24px;
            border-radius: 12px;
            background: rgba(0,0,0,0.12);
            position: relative;
            cursor: pointer;
            transition: background 0.25s;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.08);
        }
        .toggle-track.on { background: #6366f1; border-color: #6366f1; }
        .toggle-knob {
            position: absolute;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: white;
            top: 2px; left: 2px;
            transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 4px rgba(0,0,0,0.4);
        }
        .toggle-track.on .toggle-knob { transform: translateX(20px); }

        .plan-badge-free { background: rgba(100,116,139,0.2); color: #94a3b8; border: 1px solid rgba(100,116,139,0.3); border-radius: 999px; }
        .plan-badge-pro  { background: rgba(251,191,36,0.15);  color: #fbbf24; border: 1px solid rgba(251,191,36,0.3);  border-radius: 999px; }
        .plan-badge-team { background: rgba(99,102,241,0.15);  color: #818cf8; border: 1px solid rgba(99,102,241,0.3);  border-radius: 999px; }

        .user-avatar-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem 0.35rem 0.35rem;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-avatar-btn:hover { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.15); }

        @keyframes modalIn {
            from { opacity: 0; transform: translateY(20px) scale(0.97); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-in { animation: modalIn 0.35s cubic-bezier(0.16,1,0.3,1) forwards; }

        .security-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.1rem 1.4rem;
            border-radius: 1rem;
            background: rgba(255,255,255,0.75);
            border: 1px solid rgba(0,0,0,0.06);
        }

        /* ── 合同历史 Risk pill ── */
        .risk-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.03em;
        }

        /* ── 骨架屏加载 ── */
        @keyframes skeletonShimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        .skeleton-block {
            background: linear-gradient(90deg,
                rgba(0,0,0,0.04) 25%,
                rgba(0,0,0,0.08) 50%,
                rgba(0,0,0,0.04) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.6s ease infinite;
            border-radius: 0.75rem;
        }

        /* ── 活动柱状图 ── */
        @keyframes chartGrow {
            from { transform: scaleY(0); opacity: 0; }
            to   { transform: scaleY(1); opacity: 1; }
        }
        .chart-bar-col {
            transform-origin: bottom;
            animation: chartGrow 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* ── 筛选/排序胶囊 ── */
        .filter-pill {
            padding: 0.3rem 0.9rem;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.65);
            border: 1px solid rgba(0,0,0,0.1);
            color: #475569;
            letter-spacing: 0.02em;
        }
        .filter-pill:hover { background: rgba(255,255,255,0.9); color: #334155; }
        .filter-pill.active {
            background: rgba(99,102,241,0.18);
            border-color: rgba(99,102,241,0.45);
            color: #818cf8;
        }
        .filter-pill.danger.active {
            background: rgba(239,68,68,0.15);
            border-color: rgba(239,68,68,0.4);
            color: #f87171;
        }

        /* ── 批量操作栏 ── */
        .batch-action-bar {
            position: sticky;
            top: 0;
            z-index: 20;
            background: rgba(240,244,255,0.97);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(99,102,241,0.35);
            border-radius: 1.25rem;
            padding: 0.85rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            animation: slideUp 0.2s ease-out;
        }

        /* ── 合同卡片选中态 ── */
        .history-card.selected {
            border-color: rgba(99,102,241,0.55) !important;
            background: rgba(99,102,241,0.06) !important;
        }
        .contract-cb {
            width: 17px; height: 17px;
            border-radius: 4px;
            border: 2px solid rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 10px;
            color: white;
        }
        .contract-cb.on { background: #6366f1; border-color: #6366f1; }

        /* ── 统计趋势箭头 ── */
        .stat-trend-up   { color: #34d399; font-size: 0.65rem; font-weight: 900; }
        .stat-trend-down { color: #f87171; font-size: 0.65rem; font-weight: 900; }
        .stat-trend-flat { color: #64748b; font-size: 0.65rem; font-weight: 900; }

        /* ── Donut 风险图 ── */
        .donut-seg { transition: stroke-dasharray 1s cubic-bezier(0.4,0,0.2,1); }

        /* ── 回到顶部 ── */
        .scroll-top-btn {
            position: fixed;
            bottom: 2.5rem;
            right: 2.5rem;
            width: 42px; height: 42px;
            border-radius: 50%;
            background: rgba(99,102,241,0.15);
            border: 1px solid rgba(99,102,241,0.35);
            color: #818cf8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 80;
            backdrop-filter: blur(12px);
            transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
        }
        .scroll-top-btn:hover {
            transform: translateY(-4px) scale(1.1);
            background: rgba(99,102,241,0.35);
            box-shadow: 0 8px 24px rgba(99,102,241,0.35);
        }

        /* ── 分类标签 ── */
        .cat-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.68rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            background: rgba(59,130,246,0.12);
            border: 1px solid rgba(59,130,246,0.2);
            color: #60a5fa;
        }

        /* ── Keyword 搜索高亮 ── */
        mark.search-hl {
            background: rgba(251,191,36,0.3);
            color: #fbbf24;
            border-radius: 2px;
            padding: 0 2px;
        }

        /* ── 分析卡片数字滚动 ── */
        @keyframes countUp {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .count-animate { animation: countUp 0.5s ease-out forwards; }

        /* ── Notification Toast ── */
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(16px) scale(0.95); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }
        .toast-item {
            animation: toastIn 0.3s cubic-bezier(0.16,1,0.3,1) forwards;
        }

        /* ── 快捷键徽章 ── */
        .kbd {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.1rem 0.4rem;
            background: rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.15);
            border-bottom-width: 2px;
            border-radius: 0.3rem;
            font-size: 0.65rem;
            font-weight: 800;
            color: #475569;
            font-family: 'Courier New', monospace;
        }

        /* ════════════════════════════════════════════════════════
           ★ 增强 A: 多模型交叉验证 UI 样式
           ════════════════════════════════════════════════════════ */
        /* 置信度徽章 */
        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            font-size: 0.65rem;
            font-weight: 900;
            letter-spacing: 0.04em;
        }
        .confidence-high   { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); color: #34d399; }
        .confidence-medium { background: rgba(251,191,36,0.12);  border: 1px solid rgba(251,191,36,0.28); color: #fbbf24; }
        .confidence-low    { background: rgba(239,68,68,0.12);   border: 1px solid rgba(239,68,68,0.25); color: #f87171; }

        /* 模型共识标签 */
        .consensus-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            font-size: 0.62rem;
            font-weight: 800;
            background: rgba(99,102,241,0.12);
            border: 1px solid rgba(99,102,241,0.22);
            color: #a5b4fc;
        }
        .consensus-all    { background: rgba(16,185,129,0.1);  border-color: rgba(16,185,129,0.25); color: #34d399; }
        .consensus-most   { background: rgba(251,191,36,0.1);  border-color: rgba(251,191,36,0.25); color: #fbbf24; }
        .consensus-single { background: rgba(148,163,184,0.1); border-color: rgba(148,163,184,0.2); color: #94a3b8; }

        /* 多模型审查团徽章 */
        .model-panel-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.65rem;
            font-weight: 800;
            background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.15));
            border: 1px solid rgba(139,92,246,0.25);
            color: #a78bfa;
        }

        /* ════════════════════════════════════════════════════════
           ★ 增强 A v4.0: 多智能体辩论仲裁 UI 样式
           ════════════════════════════════════════════════════════ */

        /* 辩论模式徽章（结果页头部） */
        .debate-mode-badge {
            display: inline-flex; align-items: center; gap: 0.35rem;
            padding: 0.22rem 0.75rem; border-radius: 999px;
            font-size: 0.65rem; font-weight: 900; letter-spacing: 0.05em;
            background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(239,68,68,0.06));
            border: 1px solid rgba(245,158,11,0.3); color: #f59e0b;
            animation: debate-pulse 3s ease-in-out infinite;
        }
        @keyframes debate-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0); }
            50% { box-shadow: 0 0 10px 2px rgba(245,158,11,0.15); }
        }

        /* 裁定调整徽章 */
        .verdict-upgraded   { background: rgba(239,68,68,0.12);   border: 1px solid rgba(239,68,68,0.3);   color: #f87171; }
        .verdict-downgraded { background: rgba(16,185,129,0.12);  border: 1px solid rgba(16,185,129,0.3);  color: #34d399; }
        .verdict-maintained { background: rgba(148,163,184,0.1);  border: 1px solid rgba(148,163,184,0.2); color: #94a3b8; }
        .verdict-badge {
            display: inline-flex; align-items: center; gap: 0.2rem;
            padding: 0.1rem 0.5rem; border-radius: 6px;
            font-size: 0.6rem; font-weight: 900;
        }

        /* 辩论对话气泡容器 */
        .debate-panel {
            background: linear-gradient(135deg, rgba(245,248,255,0.97), rgba(241,245,255,0.99));
            border: 1px solid rgba(99,102,241,0.2); border-radius: 1.5rem;
            overflow: hidden;
        }
        .debate-panel-header {
            background: linear-gradient(90deg, rgba(99,102,241,0.08), rgba(245,158,11,0.06));
            border-bottom: 1px solid rgba(0,0,0,0.06);
            padding: 0.75rem 1.25rem;
            display: flex; align-items: center; gap: 0.75rem;
        }
        /* 三方角色列 */
        .debate-col {
            display: flex; flex-direction: column; gap: 0.75rem;
        }
        .debate-bubble {
            border-radius: 1rem; padding: 0.9rem 1.1rem;
            font-size: 0.78rem; line-height: 1.65;
            position: relative;
        }
        .bubble-counsel-a {
            background: rgba(59,130,246,0.07);
            border: 1px solid rgba(59,130,246,0.2);
            border-top-left-radius: 0.25rem;
        }
        .bubble-counsel-b {
            background: rgba(239,68,68,0.07);
            border: 1px solid rgba(239,68,68,0.2);
            border-top-right-radius: 0.25rem;
        }
        .bubble-arbitrator {
            background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(168,85,247,0.08));
            border: 1px solid rgba(245,158,11,0.25);
            border-radius: 1rem;
        }
        .role-label {
            font-size: 0.58rem; font-weight: 900; text-transform: uppercase;
            letter-spacing: 0.08em; margin-bottom: 0.35rem;
            display: flex; align-items: center; gap: 0.3rem;
        }
        .role-label-a    { color: #60a5fa; }
        .role-label-b    { color: #f87171; }
        .role-label-arb  { color: #fbbf24; }

        /* 仲裁裁定卡片 */
        .verdict-card {
            background: linear-gradient(135deg, rgba(245,158,11,0.06), rgba(168,85,247,0.06));
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 1.25rem; padding: 1.1rem 1.4rem;
            margin-top: 0.5rem;
        }
        .verdict-point-upheld   { color: #34d399; font-size: 0.72rem; }
        .verdict-point-rejected { color: #f87171; font-size: 0.72rem; }

        /* 辩论摘要卡（顶部统计） */
        .debate-summary-bar {
            background: linear-gradient(90deg, rgba(245,158,11,0.06), rgba(99,102,241,0.06));
            border: 1px solid rgba(245,158,11,0.15); border-radius: 1rem;
            padding: 0.75rem 1.25rem;
            display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;
        }
        .debate-stat {
            display: flex; flex-direction: column; align-items: center;
        }
        .debate-stat-n    { font-size: 1.4rem; font-weight: 900; line-height: 1; }
        .debate-stat-lbl  { font-size: 0.6rem; color: #475569; font-weight: 700; margin-top: 0.1rem; }
        .upgrade-count    { color: #f87171; }
        .downgrade-count  { color: #34d399; }
        .maintain-count   { color: #94a3b8; }
        .debated-count    { color: #fbbf24; }

        /* 辩论加载动画（分析中）*/
        .debate-thinking {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.75rem; color: #fbbf24; font-weight: 700;
        }
        .debate-thinking .dot {
            width: 5px; height: 5px; border-radius: 50%;
            background: #fbbf24; animation: debate-dot 1.4s ease-in-out infinite;
        }
        .debate-thinking .dot:nth-child(2) { animation-delay: 0.2s; background: #60a5fa; }
        .debate-thinking .dot:nth-child(3) { animation-delay: 0.4s; background: #f87171; }
        @keyframes debate-dot {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        /* 轮次切换标签 */
        .round-tab {
            padding: 0.2rem 0.7rem; border-radius: 999px; font-size: 0.62rem;
            font-weight: 800; cursor: pointer; transition: all 0.15s;
            border: 1px solid rgba(0,0,0,0.1); color: #64748b;
        }
        .round-tab.active { background: rgba(99,102,241,0.15); color: #818cf8;
            border-color: rgba(99,102,241,0.3); }
        .round-tab:hover { color: #94a3b8; }

        /* 置信度进度条 */
        .confidence-bar-wrap {
            height: 4px;
            background: rgba(0,0,0,0.08);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 4px;
        }
        .confidence-bar-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
        }

        /* ════════════════════════════════════════════════════════
           ★ 增强 B: 动态知识库 UI 样式
           ════════════════════════════════════════════════════════ */
        /* 文档类型分布芯片 */
        .doc-type-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.12rem 0.5rem;
            border-radius: 0.4rem;
            font-size: 0.6rem;
            font-weight: 800;
        }
        .doc-type-法律法规 { background: rgba(59,130,246,0.1);  color: #60a5fa;  border: 1px solid rgba(59,130,246,0.2); }
        .doc-type-司法解释 { background: rgba(168,85,247,0.1);  color: #c084fc;  border: 1px solid rgba(168,85,247,0.2); }
        .doc-type-典型案例 { background: rgba(251,191,36,0.1);  color: #fbbf24;  border: 1px solid rgba(251,191,36,0.2); }
        .doc-type-部门规章 { background: rgba(16,185,129,0.1);  color: #34d399;  border: 1px solid rgba(16,185,129,0.2); }

        /* 案例分析区块 */
        .case-card {
            background: rgba(251,191,36,0.04);
            border: 1px solid rgba(251,191,36,0.15);
            border-radius: 1.5rem;
            padding: 1.5rem;
            transition: border-color 0.2s;
        }
        .case-card:hover { border-color: rgba(251,191,36,0.3); }
        .case-similarity-高   { color: #ef4444; font-weight: 900; }
        .case-similarity-中   { color: #f97316; font-weight: 900; }
        .case-similarity-低   { color: #10b981; font-weight: 900; }

        /* ════════════════════════════════════════════════════════
           ★ 增强 C: 律师审查 UI 样式
           ════════════════════════════════════════════════════════ */
        /* 律师审查建议横幅 */
        .lawyer-review-banner {
            background: linear-gradient(135deg, rgba(251,191,36,0.06), rgba(249,115,22,0.06));
            border: 1px solid rgba(251,191,36,0.22);
            border-radius: 1.5rem;
            padding: 1.1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideUp 0.4s ease-out forwards;
        }
        .lawyer-review-banner .banner-icon {
            width: 42px; height: 42px;
            border-radius: 0.875rem;
            background: rgba(251,191,36,0.12);
            border: 1px solid rgba(251,191,36,0.25);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .lawyer-review-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.55rem 1.25rem;
            border-radius: 0.875rem;
            font-size: 0.82rem;
            font-weight: 900;
            background: linear-gradient(135deg, #f59e0b, #ea580c);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 4px 14px rgba(245,158,11,0.3);
        }
        .lawyer-review-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(245,158,11,0.4); }
        .lawyer-review-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* 律师背书徽章 */
        .endorsement-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.65rem;
            font-weight: 900;
        }
        .endorsement-endorsed  { background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.25); color: #34d399; }
        .endorsement-amended   { background: rgba(251,191,36,0.12);  border: 1px solid rgba(251,191,36,0.25);  color: #fbbf24; }
        .endorsement-overridden { background: rgba(239,68,68,0.12);  border: 1px solid rgba(239,68,68,0.25);  color: #f87171; }

        /* 律师审查任务卡片 */
        .review-status-card {
            background: rgba(251,191,36,0.04);
            border: 1px solid rgba(251,191,36,0.15);
            border-radius: 1.5rem;
            padding: 1.5rem;
        }
        .review-status-pending    { border-color: rgba(99,102,241,0.2); background: rgba(99,102,241,0.04); }
        .review-status-assigned   { border-color: rgba(251,191,36,0.2); background: rgba(251,191,36,0.04); }
        .review-status-completed  { border-color: rgba(16,185,129,0.2);  background: rgba(16,185,129,0.04); }

        /* 律师审查申请弹窗 */
        .lawyer-modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: rgba(15,23,42,0.6);
            backdrop-filter: blur(16px);
        }
        .lawyer-modal {
            width: 100%;
            max-width: 500px;
            background: rgba(248,250,255,0.99);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 2rem;
            overflow: hidden;
            box-shadow: 0 40px 120px rgba(0,0,0,0.6);
            animation: modalIn 0.35s cubic-bezier(0.16,1,0.3,1) forwards;
        }

        /* ── 合同档案空态插画 ── */
        .empty-illus {
            width: 80px; height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            background: rgba(0,0,0,0.04);
            border: 2px dashed rgba(0,0,0,0.12);
            margin: 0 auto 1rem;
        }

        /* ── 概览图表容器 ── */
        .activity-chart {
            display: flex;
            align-items: flex-end;
            gap: 5px;
            height: 56px;
            padding: 0 4px;
        }
        .activity-chart-bar {
            flex: 1;
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
            transform-origin: bottom;
        }
        .activity-chart-bar:hover { opacity: 0.8; }

        /* ── 合同类别进度条 ── */
        .cat-progress-bar {
            height: 6px;
            border-radius: 999px;
            transition: width 1s cubic-bezier(0.4,0,0.2,1);
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }

        /* ── 头像 glow ── */
        .avatar-glow {
            box-shadow: 0 0 0 4px rgba(99,102,241,0.15), 0 0 0 8px rgba(99,102,241,0.07);
        }

        /* ── 页面标题过渡 ── */
        .page-title-in {
            animation: slideUp 0.3s ease-out both;
        }

        /* ── 快速扫描结果卡 ── */
        .quick-scan-card {
            background: rgba(16,185,129,0.04);
            border: 1px solid rgba(16,185,129,0.15);
            border-radius: 1.25rem;
            padding: 1rem 1.25rem;
            animation: slideUp 0.5s ease-out forwards;
        }

        /* ── API 健康状态点 ── */
        .api-dot-ok     { background: #10b981; box-shadow: 0 0 6px rgba(16,185,129,0.6); }
        .api-dot-error  { background: #ef4444; box-shadow: 0 0 6px rgba(239,68,68,0.6); }
        .api-dot-checking { background: #fbbf24; box-shadow: 0 0 6px rgba(251,191,36,0.6); }

        /* ── 缓存命中标识 ── */
        .cache-hit-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 900;
            letter-spacing: 0.05em;
            background: rgba(16,185,129,0.12);
            border: 1px solid rgba(16,185,129,0.3);
            color: #34d399;
        }

        /* ── 法律来源徽章 ── */
        .law-source-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            font-size: 0.65rem;
            font-weight: 800;
            background: rgba(99,102,241,0.12);
            border: 1px solid rgba(99,102,241,0.25);
            color: #818cf8;
            cursor: pointer;
            transition: all 0.15s;
        }
        .law-source-badge:hover { background: rgba(99,102,241,0.22); color: #a5b4fc; }

        /* ── 自动分类检测条 ── */
        .auto-detect-bar {
            background: rgba(251,191,36,0.06);
            border: 1px solid rgba(251,191,36,0.18);
            border-radius: 1rem;
            padding: 0.65rem 1.1rem;
            animation: slideUp 0.3s ease-out forwards;
        }

        /* ── 复制按钮微型 ── */
        .copy-micro {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.18rem 0.55rem;
            border-radius: 0.4rem;
            font-size: 0.6rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.15s;
            background: rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            color: #64748b;
        }
        .copy-micro:hover { background: rgba(255,255,255,0.1); color: #94a3b8; }
        .copy-micro.copied { background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); color: #34d399; }

        /* ── 法条来源显示 ── */
        .law-ref-text {
            font-family: 'Courier New', monospace;
            font-size: 0.78rem;
            color: #475569;
            background: rgba(99,102,241,0.07);
            border-left: 3px solid rgba(99,102,241,0.4);
            padding: 0.5rem 0.75rem;
            border-radius: 0 0.5rem 0.5rem 0;
            line-height: 1.6;
        }

        /* ════════════════════════════════════════════════════════
        ★ 管理面板 & 角色 样式 (从 v3.0 移植)
        ════════════════════════════════════════════════════════ */
        .role-badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 10px; border-radius: 999px; font-size: 10px; font-weight: 900;
            letter-spacing: 0.04em; text-transform: uppercase;
        }
        .role-admin       { background: rgba(245,158,11,0.15); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
        .role-legal_staff { background: rgba(99,102,241,0.15);  color: #818cf8; border: 1px solid rgba(99,102,241,0.3); }
        .role-employee    { background: rgba(16,185,129,0.15);  color: #34d399; border: 1px solid rgba(16,185,129,0.3); }

        /* 管理面板遮罩 */
        .admin-panel-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: flex; align-items: flex-start; justify-content: center;
            padding: 40px 16px; overflow-y: auto;
        }
        .admin-panel-modal {
            width: 100%; max-width: 960px;
            background: linear-gradient(135deg, rgba(248,250,255,0.99), rgba(241,245,255,0.99));
            border: 1px solid rgba(99,102,241,0.3); border-radius: 24px;
            overflow: hidden;
            animation: modalIn 0.35s cubic-bezier(0.16,1,0.3,1) forwards;
        }
        .admin-tab { padding: 8px 18px; border-radius: 10px; font-size: 12px; font-weight: 700;
            cursor: pointer; transition: all 0.2s; color: #64748b; }
        .admin-tab.active { background: rgba(99,102,241,0.15); color: #818cf8; }
        .admin-tab:hover { background: rgba(0,0,0,0.05); }

        .admin-user-row { padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex; align-items: center; gap: 12px; transition: background 0.15s; }
        .admin-user-row:hover { background: rgba(99,102,241,0.04); }

        .perm-chip { display: inline-flex; padding: 1px 7px; border-radius: 6px; font-size: 9px;
            font-weight: 700; background: rgba(99,102,241,0.1); color: #818cf8;
            border: 1px solid rgba(99,102,241,0.15); margin: 1px; }

        .security-stat-card {
            background: rgba(241,245,255,0.8); border: 1px solid rgba(0,0,0,0.08);
            border-radius: 14px; padding: 16px 20px; text-align: center;
        }

        /* ── 打印样式 ── */
        /* ════════════════════════════════════════════════════════
           ★ 视觉增强: 专业级界面优化
           ════════════════════════════════════════════════════════ */

        /* ── 分隔发光线 ── */
        .glow-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(99,102,241,0.4), rgba(168,85,247,0.4), transparent);
            margin: 2rem 0;
        }

        /* ── 主标题容器: 增加标题下方装饰 ── */
        header h1 {
            text-shadow: 0 0 80px rgba(99,102,241,0.15);
            letter-spacing: -0.03em;
        }

        /* ── 增强分类卡片 ── */
        .cat-card-labor    { --cat-accent: #60a5fa; --cat-bg: rgba(59,130,246,0.12); }
        .cat-card-property { --cat-accent: #34d399; --cat-bg: rgba(16,185,129,0.12); }
        .cat-card-service  { --cat-accent: #fb923c; --cat-bg: rgba(249,115,22,0.12); }
        .cat-card-finance  { --cat-accent: #fbbf24; --cat-bg: rgba(251,191,36,0.12); }
        .cat-card-digital  { --cat-accent: #a78bfa; --cat-bg: rgba(139,92,246,0.12); }
        .cat-card-family   { --cat-accent: #f472b6; --cat-bg: rgba(244,114,182,0.12); }
        .cat-card-business { --cat-accent: #2dd4bf; --cat-bg: rgba(45,212,191,0.12); }
        .cat-card-other    { --cat-accent: #94a3b8; --cat-bg: rgba(148,163,184,0.12); }

        /* ── 上传区域增强 ── */
        .upload-zone {
            position: relative;
            overflow: hidden;
        }
        .upload-zone::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 2rem;
            background: linear-gradient(135deg, rgba(59,130,246,0), rgba(99,102,241,0.1), rgba(168,85,247,0), rgba(99,102,241,0.1));
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }
        .upload-zone:hover::before,
        .upload-zone.drag-over::before {
            opacity: 1;
        }

        /* ── 按钮光晕效果 ── */
        .btn-primary {
            position: relative;
            overflow: hidden;
        }
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.4s ease;
            pointer-events: none;
        }
        .btn-primary:hover::after {
            transform: translate(-50%, -50%) scale(2);
        }

        /* ── 登录弹窗顶部装饰线 ── */
        .login-modal-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, #8b5cf6, #f472b6, transparent);
        }

        /* ── 评分仪表盘发光 ── */
        .risk-meter-glow {
            filter: drop-shadow(0 0 12px rgba(99,102,241,0.3));
        }

        /* ── 进度步骤增强 ── */
        .step-connector-done {
            background: linear-gradient(90deg, #10b981, #34d399) !important;
            box-shadow: 0 0 8px rgba(16,185,129,0.4);
        }

        /* ── 卡片入场动画 (stagger) ── */
        @keyframes cardReveal {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }
        .card-reveal { animation: cardReveal 0.5s cubic-bezier(0.16,1,0.3,1) both; }
        .card-reveal:nth-child(1) { animation-delay: 0.05s; }
        .card-reveal:nth-child(2) { animation-delay: 0.10s; }
        .card-reveal:nth-child(3) { animation-delay: 0.15s; }
        .card-reveal:nth-child(4) { animation-delay: 0.20s; }
        .card-reveal:nth-child(5) { animation-delay: 0.25s; }
        .card-reveal:nth-child(6) { animation-delay: 0.30s; }
        .card-reveal:nth-child(7) { animation-delay: 0.35s; }
        .card-reveal:nth-child(8) { animation-delay: 0.40s; }

        /* ── API 状态指示器增强 ── */
        @keyframes statusPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50%       { transform: scale(1.5); opacity: 0.7; }
        }

        /* ── 语言选择器增强 ── */
        .lang-selector {
            appearance: none;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(0,0,0,0.1);
            color: #334155;
            padding: 0.45rem 2rem 0.45rem 0.8rem;
            border-radius: 0.875rem;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            transition: all 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .lang-selector:hover { border-color: rgba(99,102,241,0.6); background-color: rgba(255,255,255,0.9); }
        .lang-selector:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.15); }

        /* ── 结果页标签增强 ── */
        .result-tab {
            position: relative;
            transition: color 0.2s, background 0.2s;
        }
        .result-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
        }

        /* ── 风险条颜色增强 ── */
        .risk-bar-极高 { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .risk-bar-高   { background: linear-gradient(90deg, #f97316, #ea580c); }
        .risk-bar-中   { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
        .risk-bar-低   { background: linear-gradient(90deg, #10b981, #059669); }

        /* ── 用户头像按钮增强 ── */
        .user-avatar-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0.7rem 0.3rem 0.3rem;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .user-avatar-btn:hover { 
            background: rgba(255,255,255,0.9); 
            border-color: rgba(0,0,0,0.14);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* ── 头部 badge 增强 ── */
        .header-badge {
            position: relative;
            overflow: hidden;
        }
        .header-badge::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 60%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: sheen 4s ease-in-out infinite;
        }
        @keyframes sheen {
            0% { left: -100%; }
            50%, 100% { left: 150%; }
        }

        /* ── 增强 Notification Toast ── */
        .toast-item {
            animation: toastIn 0.3s cubic-bezier(0.16,1,0.3,1) forwards;
            backdrop-filter: blur(24px);
            border-left: 3px solid rgba(99,102,241,0.6);
        }

        /* ── 扫描线增强 ── */
        .scan-line {
            position: fixed;
            left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(59,130,246,0.0) 20%, rgba(99,102,241,0.4) 50%, rgba(59,130,246,0.0) 80%, transparent 100%);
            animation: scanLine 8s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        /* ── 分析进度增强 ── */
        @keyframes progressGlow {
            0%, 100% { box-shadow: 0 0 8px rgba(59,130,246,0.3); }
            50% { box-shadow: 0 0 20px rgba(99,102,241,0.6); }
        }
        .progress-active-dot {
            animation: progressGlow 1.5s ease-in-out infinite;
        }

        /* ── 合同文本框增强 ── */
        .text-view-box {
            height: 100%;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 2;
            color: #475569;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 2rem;
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 0 0 1px rgba(255,255,255,0.8) inset;
        }

        /* ── 主操作按钮光晕 ── */
        button[style*="linear-gradient(135deg, #2563eb"]:hover,
        button[style*="linear-gradient(135deg, #3b82f6"]:hover {
            box-shadow: 0 12px 32px rgba(99,102,241,0.45) !important;
            transform: translateY(-1px);
        }

        @media (prefers-reduced-motion: reduce) {
            .orb, .scan-line, .header-badge::before { animation: none !important; }
        }

        @media print {
            .bg-orbs, .scan-line, .scroll-top-btn,
            header .flex.items-center.justify-between > :last-child,
            button { display: none !important; }
            body { background: white !important; color: #1e293b !important; }
            .glass-card, .glass-card-light { background: #f8fafc !important; border: 1px solid #e2e8f0 !important; }
            .gradient-text { -webkit-text-fill-color: #1e40af !important; }
            .text-slate-400, .text-slate-500 { color: #475569 !important; }
            @page { margin: 1.5cm; }
        }


        /* ══════════════════════════════════════════════════════════════
           🌙 DARK MODE OVERRIDES — applied when body has class "dark-mode"
           ══════════════════════════════════════════════════════════════ */
        body.dark-mode {
            background: #020617;
            color: #f1f5f9;
        }
        body.dark-mode::after {
            background-image: radial-gradient(rgba(99,102,241,0.06) 1px, transparent 1px);
        }
        body.dark-mode .orb-1 { opacity: 0.09; }
        body.dark-mode .orb-2 { opacity: 0.08; }
        body.dark-mode .orb-3 { opacity: 0.07; }
        body.dark-mode .orb-4 { opacity: 0.05; }
        body.dark-mode::before { opacity: 0.35; }

        /* Glass cards */
        body.dark-mode .glass-card {
            background: rgba(255,255,255,0.025) !important;
            border: 1px solid rgba(255,255,255,0.07) !important;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.03) inset, 0 20px 60px -20px rgba(0,0,0,0.5) !important;
        }
        body.dark-mode .glass-card-light {
            background: rgba(255,255,255,0.04) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.04) inset !important;
        }
        /* Contract text boxes */
        body.dark-mode .text-view-box {
            color: #94a3b8 !important;
            background: rgba(255,255,255,0.015) !important;
            border: 1px solid rgba(255,255,255,0.07) !important;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.03) inset !important;
        }
        body.dark-mode .revised-contract-box { color: #cbd5e1 !important; background: rgba(0,255,150,0.02) !important; }
        /* Scrollbars */
        body.dark-mode .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08) !important; }
        body.dark-mode .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2) !important; }
        /* Language selector */
        body.dark-mode .lang-selector {
            background: rgba(255,255,255,0.04) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            color: #cbd5e1 !important;
        }
        body.dark-mode .lang-selector:hover { border-color: rgba(99,102,241,0.45) !important; background-color: rgba(255,255,255,0.06) !important; }
        /* Login inputs */
        body.dark-mode .login-input {
            background: rgba(255,255,255,0.04) !important;
            border: 1px solid rgba(255,255,255,0.09) !important;
            color: #f1f5f9 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) inset !important;
        }
        body.dark-mode .login-input::placeholder { color: rgba(148,163,184,0.4) !important; }
        /* Social buttons */
        body.dark-mode .social-btn {
            border: 1px solid rgba(255,255,255,0.08) !important;
            background: rgba(255,255,255,0.03) !important;
            color: #94a3b8 !important;
        }
        body.dark-mode .social-btn:hover { background: rgba(255,255,255,0.07) !important; border-color: rgba(255,255,255,0.15) !important; color: #cbd5e1 !important; }
        /* Profile nav */
        body.dark-mode .profile-nav-btn:hover { background: rgba(255,255,255,0.05) !important; color: #94a3b8 !important; }
        /* Stat & history cards */
        body.dark-mode .stat-card { background: rgba(255,255,255,0.025) !important; border: 1px solid rgba(255,255,255,0.06) !important; }
        body.dark-mode .stat-card:hover { box-shadow: 0 16px 40px rgba(0,0,0,0.3) !important; }
        body.dark-mode .history-card { background: rgba(255,255,255,0.025) !important; border: 1px solid rgba(255,255,255,0.06) !important; }
        body.dark-mode .history-card:hover { border-color: rgba(99,102,241,0.35) !important; background: rgba(99,102,241,0.05) !important; }
        /* Toggle track */
        body.dark-mode .toggle-track { background: rgba(255,255,255,0.08) !important; border: 1px solid rgba(255,255,255,0.06) !important; }
        /* User avatar button */
        body.dark-mode .user-avatar-btn { background: rgba(255,255,255,0.04) !important; border: 1px solid rgba(255,255,255,0.08) !important; }
        body.dark-mode .user-avatar-btn:hover { background: rgba(255,255,255,0.08) !important; border-color: rgba(255,255,255,0.14) !important; }
        /* Security item */
        body.dark-mode .security-item { background: rgba(255,255,255,0.025) !important; border: 1px solid rgba(255,255,255,0.05) !important; }
        /* Skeleton */
        body.dark-mode .skeleton-block {
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.07) 50%, rgba(255,255,255,0.03) 75%) !important;
        }
        /* Filter pills */
        body.dark-mode .filter-pill { background: rgba(255,255,255,0.04) !important; border: 1px solid rgba(255,255,255,0.08) !important; color: #475569 !important; }
        body.dark-mode .filter-pill:hover { background: rgba(255,255,255,0.07) !important; color: #94a3b8 !important; }
        /* Batch action bar */
        body.dark-mode .batch-action-bar { background: rgba(10,18,40,0.94) !important; }
        /* Checkbox */
        body.dark-mode .contract-cb { border: 2px solid rgba(255,255,255,0.18) !important; background: rgba(255,255,255,0.03) !important; }
        /* KBD */
        body.dark-mode .kbd { background: rgba(255,255,255,0.07) !important; border: 1px solid rgba(255,255,255,0.12) !important; color: #64748b !important; }
        /* Confidence bar */
        body.dark-mode .confidence-bar-wrap { background: rgba(255,255,255,0.06) !important; }
        /* Copy micro */
        body.dark-mode .copy-micro { background: rgba(255,255,255,0.06) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: #64748b !important; }
        body.dark-mode .copy-micro:hover { background: rgba(255,255,255,0.1) !important; color: #94a3b8 !important; }
        /* Law ref text */
        body.dark-mode .law-ref-text { color: #94a3b8 !important; }
        /* Admin panel */
        body.dark-mode .admin-panel-modal { background: linear-gradient(135deg, rgba(15,15,28,0.99), rgba(20,20,38,0.99)) !important; }
        body.dark-mode .admin-user-row { border-bottom: 1px solid rgba(255,255,255,0.04) !important; }
        body.dark-mode .admin-user-row:hover { background: rgba(255,255,255,0.03) !important; }
        body.dark-mode .admin-tab:hover { background: rgba(255,255,255,0.04) !important; }
        body.dark-mode .security-stat-card { background: rgba(20,20,35,0.8) !important; border: 1px solid rgba(255,255,255,0.06) !important; }
        /* Lawyer modal */
        body.dark-mode .lawyer-modal-overlay { background: rgba(2,6,23,0.85) !important; }
        body.dark-mode .lawyer-modal { background: rgba(15,23,42,0.97) !important; border: 1px solid rgba(255,255,255,0.08) !important; }
        /* Debate panel */
        body.dark-mode .debate-panel { background: linear-gradient(135deg, rgba(10,10,25,0.95), rgba(15,15,35,0.98)) !important; }
        body.dark-mode .debate-panel-header { background: linear-gradient(90deg, rgba(99,102,241,0.1), rgba(245,158,11,0.07)) !important; border-bottom: 1px solid rgba(255,255,255,0.05) !important; }
        body.dark-mode .round-tab { border: 1px solid rgba(255,255,255,0.08) !important; color: #64748b !important; }
        /* Empty illustration */
        body.dark-mode .empty-illus { background: rgba(255,255,255,0.04) !important; border: 2px dashed rgba(255,255,255,0.1) !important; }
        /* Hover lift shadow */
        body.dark-mode .hover-lift:hover { box-shadow: 0 24px 48px rgba(0,0,0,0.4), 0 0 0 1px rgba(99,102,241,0.1) !important; }
        /* Header badge sheen */
        body.dark-mode .header-badge::before { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent) !important; }
        /* Negotiation markdown */
        body.dark-mode .negotiation-markdown strong { color: #60a5fa !important; }
        /* ── Undo Tailwind overrides in dark mode ── */
        body.dark-mode .text-slate-100 { color: #f1f5f9 !important; }
        body.dark-mode .text-slate-200 { color: #e2e8f0 !important; }
        body.dark-mode .text-slate-300 { color: #cbd5e1 !important; }
        body.dark-mode .text-slate-400 { color: #94a3b8 !important; }
        body.dark-mode .text-slate-500 { color: #64748b !important; }
        body.dark-mode .text-slate-600 { color: #475569 !important; }
        body.dark-mode .text-white     { color: #ffffff !important; }
        body.dark-mode .bg-slate-900   { background-color: #0f172a !important; }
        body.dark-mode .bg-slate-800   { background-color: #1e293b !important; }
        body.dark-mode .bg-slate-950   { background-color: #020617 !important; }

        /* ── Theme toggle button ── */
        .theme-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: rgba(99,102,241,0.12);
            border: 1px solid rgba(99,102,241,0.25);
            color: #818cf8;
            flex-shrink: 0;
        }
        .theme-toggle-btn:hover {
            background: rgba(99,102,241,0.22);
            border-color: rgba(99,102,241,0.5);
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 4px 14px rgba(99,102,241,0.3);
        }
        body.dark-mode .theme-toggle-btn {
            background: rgba(251,191,36,0.12);
            border: 1px solid rgba(251,191,36,0.25);
            color: #fbbf24;
        }
        body.dark-mode .theme-toggle-btn:hover {
            background: rgba(251,191,36,0.22);
            border-color: rgba(251,191,36,0.5);
            box-shadow: 0 4px 14px rgba(251,191,36,0.3);
        }

        /* ══ 甲方/乙方角色选择器增强 ══ */
        .party-selector {
            display: flex;
            position: relative;
            z-index: 10;
            gap: 4px;
            background: rgba(0, 0, 0, 0.05); /* 稍微深一点的底色，确保在浅色模式可见 */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 4px;
        }

        body.dark-mode .party-selector {
            background: rgba(255, 255, 255, 0.06);
        }

        .party-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer !important; /* 强制手型显示 */
            font-size: 0.85rem;
            font-weight: 800;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            color: #64748b;
            pointer-events: auto !important; /* 确保接收点击 */
        }

        /* 甲方激活态 */
        .party-btn.active-a {
            background: linear-gradient(135deg, #2563eb, #3b82f6) !important;
            color: #ffffff !important;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        /* 乙方激活态 */
        .party-btn.active-b {
            background: linear-gradient(135deg, #7c3aed, #a855f7) !important;
            color: #ffffff !important;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .party-btn:not(.active-a):not(.active-b):hover {
            background: rgba(0, 0, 0, 0.03);
            color: #334155;
        }

        body.dark-mode .party-btn:not(.active-a):not(.active-b):hover {
            background: rgba(255, 255, 255, 0.08);
            color: #cbd5e1;
        }
        .party-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 900;
            letter-spacing: 0.04em;
        }
        .party-badge-a {
            background: rgba(59,130,246,0.15);
            color: #60a5fa;
            border: 1px solid rgba(59,130,246,0.3);
        }
        .party-badge-b {
            background: rgba(168,85,247,0.15);
            color: #c084fc;
            border: 1px solid rgba(168,85,247,0.3);
        }
        .party-role-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            border-radius: 14px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 0;
        }
        .party-role-banner.party-a {
            background: linear-gradient(90deg, rgba(59,130,246,0.07), rgba(37,99,235,0.04));
            border-color: rgba(59,130,246,0.2);
        }
        .party-role-banner.party-b {
            background: linear-gradient(90deg, rgba(168,85,247,0.07), rgba(139,92,246,0.04));
            border-color: rgba(168,85,247,0.2);
        }

        /* ══ Light theme: override Tailwind text colors for readability ══ */
        .text-slate-100 { color: #1e293b !important; }
        .text-slate-200 { color: #334155 !important; }
        .text-slate-300 { color: #334155 !important; }
        .text-slate-400 { color: #475569 !important; }
        .text-slate-500 { color: #475569 !important; }
        .text-slate-600 { color: #334155 !important; }
        .text-white     { color: #0f172a !important; }
        /* Light bg for Tailwind dark bg utility classes */
        .bg-slate-900   { background-color: #f0f4f8 !important; }
        .bg-slate-800   { background-color: #f1f5f9 !important; }
        .bg-slate-950   { background-color: #eef2f7 !important; }
    </style>
</head>

<body>
    <!-- 动态背景装饰 -->
    <div class="bg-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="orb orb-4"></div>
    </div>

    <div id="root" style="position:relative;z-index:2;"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // ==================== 全局配置 ====================
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const API_BASE_URL     = "http://localhost:5000";
        const MAX_CHARACTERS   = 8000;   // 提高上限以支持更多文件内容
        const FILE_MAX_CHARS   = 8000;   // 文件内容上限
        const MIN_CHARACTERS   = 100;

        // ── 合同关键词 → 分类自动检测 ──────────────────────────
        const CATEGORY_KEYWORDS = {
            '劳动用工类':  ['劳动合同','工资','薪酬','社保','离职','试用期','工时','加班','雇员','雇主','劳动者','用人单位','劳动关系','工作年限','解除劳动'],
            '房产物业类':  ['房屋','租赁','产权','物业','房产','不动产','购房','抵押','租金','押金','房东','租客','房号','楼层','面积','装修','物业费'],
            '消费服务类':  ['服务费','售后','退款','质保','三包','用户协议','购买','消费者','商家','快递','电商','平台','订单','退换货'],
            '金融借贷类':  ['借款','贷款','利息','利率','还款','担保','抵押','质押','债务','债权','偿还','本金','逾期','罚息','信贷','融资'],
            '网络数字类':  ['隐私政策','数据','用户协议','知识产权','版权','软件','平台','互联网','网络','APP','服务条款','账号','个人信息','数字'],
            '婚姻家庭类':  ['婚姻','离婚','财产','子女','抚养','赡养','继承','遗嘱','夫妻','婚前','婚后','配偶','赔偿金','分割'],
            '经营合作类':  ['合伙','股权','投资','合资','分红','利润','经营','合作','代理','加盟','供应商','采购','销售','合同标的','甲方','乙方','丙方'],
        };

        // ─────────────────── 管理员控制台组件 (从 v3.0 移植) ───────────────────
        // ─────────────────── 完整的管理员控制台组件 (从 v3.0 完整移植) ───────────────────
        const AdminPanel = ({ onClose, currentUserId }) => {
            const { useState: useS, useEffect: useE } = React;
            const [activeTab, setActiveTab] = useS('users');
            const [users, setUsers]         = useS([]);
            const [auditLog, setAuditLog]   = useS([]);
            const [deployInfo, setDeployInfo] = useS(null);
            const [loading, setLoading]     = useS(true);
            const [editingUserId, setEditingUserId] = useS(null);
            const [newRole, setNewRole]     = useS('');
            const [search, setSearch]       = useS('');

            const ROLE_LABELS = { admin: '管理员', legal_staff: '法务人员', employee: '普通员工' };

            useE(() => { loadTab(activeTab); }, [activeTab]);

            const loadTab = async (tab) => {
                setLoading(true);
                try {
                    if (tab === 'users') {
                        const r = await apiGet(`/admin/users?per_page=50${search ? '&search='+encodeURIComponent(search) : ''}`);
                        if (r.ok) setUsers((await r.json()).users || []);
                    } else if (tab === 'audit') {
                        // v4.0 后端如果还没写这个接口，可以先展示空或简单实现
                        const r = await apiGet('/admin/audit-log'); 
                        if (r.ok) setAuditLog((await r.json()).logs || []);
                    } else if (tab === 'deploy') {
                        const r = await fetch(`${API_BASE_URL}/deploy/info`, { headers: {'bypass-tunnel-reminder':'true'} });
                        if (r.ok) setDeployInfo(await r.json());
                    }
                } catch(e) {}
                setLoading(false);
                setTimeout(() => lucide.createIcons(), 100);
            };

            const handleRoleChange = async (userId) => {
                const r = await apiPut(`/admin/users/${userId}/role`, { role: newRole });
                if (r.ok) { setEditingUserId(null); loadTab('users'); }
            };

            return (
                <div className="admin-panel-overlay" onClick={e => e.target === e.currentTarget && onClose()}>
                    <div className="admin-panel-modal">
                        <div className="flex items-center justify-between p-6 border-b border-white/5">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-amber-500/15 flex items-center justify-center">
                                    <i data-lucide="shield" className="w-5 h-5 text-amber-400"></i>
                                </div>
                                <div>
                                    <h2 className="text-lg font-black text-white">安全管理控制台</h2>
                                    <p className="text-xs text-slate-500">ContractClarity Admin Dashboard</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white/5 rounded-xl transition-colors text-slate-400"><i data-lucide="x" className="w-5 h-5"></i></button>
                        </div>

                        <div className="flex gap-2 p-4 border-b border-white/5">
                            {[{id:'users',l:'用户与角色',i:'users'}, {id:'audit',l:'安全审计',i:'activity'}, {id:'deploy',l:'部署配置',i:'server'}].map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`admin-tab flex items-center gap-2 ${activeTab===t.id?'active':''}`}>
                                    <i data-lucide={t.i} className="w-3.5 h-3.5"></i>{t.l}
                                </button>
                            ))}
                        </div>

                        <div className="p-6 max-h-[60vh] overflow-y-auto scrollbar-thin">
                            {loading ? (
                                <div className="text-center py-20 text-slate-600 animate-pulse font-bold">数据调取中...</div>
                            ) : activeTab === 'users' ? (
                                <div className="space-y-2">
                                    {users.map(u => (
                                        <div key={u.id} className="admin-user-row">
                                            <div className="w-9 h-9 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400 font-black shrink-0">{u.nickname?.[0] || 'U'}</div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-sm font-bold text-white">{u.nickname || u.phone}</span>
                                                    <span className={`role-badge role-${u.role}`}>{ROLE_LABELS[u.role] || u.role}</span>
                                                </div>
                                                <div className="text-[10px] text-slate-600 mt-1 font-mono uppercase">{u.id}</div>
                                            </div>
                                            <div className="shrink-0">
                                                {editingUserId === u.id ? (
                                                    <div className="flex items-center gap-2">
                                                        <select value={newRole} onChange={e => setNewRole(e.target.value)} className="text-xs bg-slate-900 border border-white/10 rounded px-2 py-1 text-white">
                                                            {Object.entries(ROLE_LABELS).map(([k,v])=><option key={k} value={k}>{v}</option>)}
                                                        </select>
                                                        <button onClick={()=>handleRoleChange(u.id)} className="text-xs text-emerald-400 font-black">更新</button>
                                                        <button onClick={()=>setEditingUserId(null)} className="text-xs text-slate-500">取消</button>
                                                    </div>
                                                ) : u.id !== currentUserId && (
                                                    <button onClick={()=>{setEditingUserId(u.id);setNewRole(u.role)}} className="text-xs px-3 py-1.5 rounded-lg bg-white/5 text-slate-400 hover:text-indigo-400 transition-all font-bold">变更角色</button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : activeTab === 'audit' ? (
                                <div className="space-y-2">
                                    {auditLog.length === 0 ? <div className="text-center py-10 text-slate-600">暂无安全审计记录</div> :
                                    auditLog.map(log => (
                                        <div key={log.id} className="p-3 rounded-xl bg-white/2 border border-white/5 flex flex-col gap-1">
                                            <div className="flex justify-between"><span className="text-xs font-black text-indigo-300">{log.action}</span><span className="text-[10px] text-slate-600">{log.created_at}</span></div>
                                            <div className="text-[10px] text-slate-400">操作人: {log.nickname || log.user_id} | 结果: {log.result}</div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="text-xs font-black text-slate-500 uppercase mb-3">系统环境清单</div>
                                    <pre className="text-[11px] text-indigo-500 font-mono bg-black/10 p-5 rounded-2xl border border-white/5 leading-relaxed">{JSON.stringify(deployInfo, null, 2)}</pre>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const autoDetectCategory = (text) => {
            if (!text || text.length < 50) return null;
            const scores = {};
            const lower = text.toLowerCase();
            Object.entries(CATEGORY_KEYWORDS).forEach(([cat, kws]) => {
                let score = 0;
                kws.forEach(kw => {
                    // Count occurrences, weighted by keyword length
                    const matches = (text.match(new RegExp(kw, 'g')) || []).length;
                    score += matches * Math.max(1, kw.length - 2);
                });
                if (score > 0) scores[cat] = score;
            });
            if (Object.keys(scores).length === 0) return null;
            return Object.entries(scores).sort((a, b) => b[1] - a[1])[0][0];
        };

        // ==================== 企业级 Auth API 工具层 ====================
        // JWT 存储键名
        const _ACCESS_KEY  = 'cc_access_token';
        const _REFRESH_KEY = 'cc_refresh_token';

        const getAccessToken  = () => localStorage.getItem(_ACCESS_KEY)  || '';
        const getRefreshToken = () => localStorage.getItem(_REFRESH_KEY) || '';
        const setTokens = (access, refresh) => {
            localStorage.setItem(_ACCESS_KEY,  access);
            if (refresh) localStorage.setItem(_REFRESH_KEY, refresh);
        };
        const clearTokens = () => {
            localStorage.removeItem(_ACCESS_KEY);
            localStorage.removeItem(_REFRESH_KEY);
        };

        // 封装 fetch，自动附加 Bearer token，处理 401 自动刷新
        let _refreshPromise = null; // 防止并发刷新
        const authFetch = async (url, options = {}) => {
            const makeHeaders = () => ({
                'Content-Type': 'application/json',
                'bypass-tunnel-reminder': 'true',
                'ngrok-skip-browser-warning': 'true',
                ...(options.headers || {}),
                ...(getAccessToken() ? { 'Authorization': 'Bearer ' + getAccessToken() } : {}),
            });
            let res = await fetch(API_BASE_URL + url, { ...options, headers: makeHeaders() });

            // access token 过期 → 尝试用 refresh token 换新的
            if (res.status === 401) {
                const body = await res.clone().json().catch(() => ({}));
                if (body.error === 'token_expired' && getRefreshToken()) {
                    if (!_refreshPromise) {
                        _refreshPromise = fetch(API_BASE_URL + '/auth/refresh', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'bypass-tunnel-reminder': 'true' },
                            body: JSON.stringify({ refresh_token: getRefreshToken() }),
                        }).then(async r => {
                            _refreshPromise = null;
                            if (!r.ok) { clearTokens(); return null; }
                            const d = await r.json();
                            setTokens(d.access_token, d.refresh_token);
                            return d.access_token;
                        }).catch(() => { _refreshPromise = null; clearTokens(); return null; });
                    }
                    const newToken = await _refreshPromise;
                    if (newToken) {
                        // 用新 token 重试原请求
                        res = await fetch(API_BASE_URL + url, { ...options, headers: makeHeaders() });
                    }
                }
            }
            return res;
        };

        // 便捷方法
        const apiGet    = (url)         => authFetch(url, { method: 'GET' });
        const apiPost   = (url, body)   => authFetch(url, { method: 'POST',   body: JSON.stringify(body)  });
        const apiPut    = (url, body)   => authFetch(url, { method: 'PUT',    body: JSON.stringify(body)  });
        const apiDelete = (url, body)   => authFetch(url, { method: 'DELETE', body: body ? JSON.stringify(body) : undefined });

        // 启动时从服务端验证 token 并加载用户（返回 null 表示未登录/token 无效）
        const fetchCurrentUser = async () => {
            if (!getAccessToken()) return null;
            try {
                const res = await apiGet('/auth/me');
                if (!res.ok) { clearTokens(); return null; }
                return await res.json();
            } catch { return null; }
        };

        // ==================== 语言配置 ====================
        const LANGUAGES = [
            { code: 'zh-CN', label: '🇨🇳 简体中文' },
            { code: 'zh-TW', label: '🇹🇼 繁體中文' },
            { code: 'en',    label: '🇬🇧 English' },
            { code: 'ja',    label: '🇯🇵 日本語' },
            { code: 'ko',    label: '🇰🇷 한국어' },
            { code: 'fr',    label: '🇫🇷 Français' },
            { code: 'de',    label: '🇩🇪 Deutsch' },
            { code: 'es',    label: '🇪🇸 Español' },
            { code: 'pt',    label: '🇧🇷 Português' },
            { code: 'ar',    label: '🇸🇦 العربية' },
            { code: 'ru',    label: '🇷🇺 Русский' },
        ];

        // ==================== 多语言 UI 字典 ====================
        const UI_STRINGS = {
          'zh-CN': {
            subtitle: '专家级 AI 合同审查', subtitle2: '实时法律库检索', subtitle3: '深度谈判博弈',
            step1_heading: '请选择您想要审查的合同类型',
            step1_desc: '精准的类型选择将匹配更专业的法律库索引',
            expand_all: '展开全部细节', collapse_all: '隐藏全部细节',
            back_btn: '返回重选类型', current_type: '当前类型：',
            upload_title: '上传合同文档', upload_formats: 'PDF · Word · 图片 · TXT',
            upload_ocr_tip: '🖼️ 图片自动 OCR + AI 优化',
            upload_max: n => `📏 最大 ${n.toLocaleString()} 字符`,
            or_paste: '或者直接粘贴文本', textarea_placeholder: '在此粘贴合同文本...',
            min_chars: n => `最少 ${n} 字`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` （还需 ${n} 字）`, chars_over: ' ⚠ 超出上限', chars_ok: ' ✓ 可以提交',
            start_review: '🔍 开始专家审查', input_first: '请先输入合同内容',
            analyzing_subtitle: 'AI 专家审查通常需要 3-5 分钟，请耐心等待',
            ocr_processing: '🤖 AI 正在优化 OCR 文本质量...', ocr_done: '✅ OCR 优化完成',
            cancel_btn: '取消审查',
            stages: ['文档解析', '多模型审查', '谈判策略', '修订合同', '案例分析'],
            tab_overview: '阅读原文', tab_risks: '风险解析', tab_negotiation: '博弈策略', tab_revised: '完整修订',
            tab_cases: '案例分析', tab_lawyer: '律师审查', tab_debate: '辩论记录',
            risk_dist: '风险分布', core_threats: n => `核心威胁 (${n})`,
            original_clause: '原文表述', legal_basis: '法律依据', problem_title: '问题剖析',
            action_title: '行动对策', revision_suggestion: '防御性条款修订建议', plain_explanation: '通俗解释',
            game_overview: '博弈全局观', call_script: '电话面谈脚本',
            opening_label: '开场 Opening', key_reasons_label: '核心理由 Key Reasons',
            style_strategies: '多风格谈判策略',
            copy_btn: '复制', copied_btn: '✓ 已复制', copy_full: '复制全文', copy_full2: '复制全文',
            email_section: '书面沟通邮件',
            revised_title: '完整修订合同',
            revised_desc: '已根据所有风险点生成修订版合同，修订处以【修订】标记。',
            revised_full_tab: '修订合同全文',
            revision_notes: n => `修订说明 (${n} 处)`,
            download_txt: '下载 .txt', no_revision: '修订合同内容生成中或暂不可用。',
            revision_item_label: i => `修订 ${i + 1}`,
            overall_risk: '总体风险', risk_clauses_label: '风险条款',
            export_report: '导出报告', restart_btn: '审查新合同',
            quick_nav_call: '电话面谈脚本', quick_nav_email: '书面沟通邮件',
            style_aggressive: '强硬 Aggressive', style_consultative: '协商 Consultative', style_compromise: '妥协 Compromise',
            risk_lv: { xh: '极高风险', h: '高风险', m: '中等风险', l: '低风险', s: '安全' },
            cat_names: { '劳动用工类':'劳动用工类','房产物业类':'房产物业类','消费服务类':'消费服务类','金融借贷类':'金融借贷类','网络数字类':'网络数字类','婚姻家庭类':'婚姻家庭类','经营合作类':'经营合作类','其他类':'其他类' },
            // ★ 增强 A
            multi_model_panel: n => `${n} 模型审查团`, confidence_label: '置信度',
            consensus_all: '全部一致', consensus_most: '多数认同', consensus_single: '仅单模型',
            // ★ 增强 A v4.0 辩论仲裁
            debate_mode_badge: '⚖ 三方辩论仲裁',
            debate_counsel_a: '甲方律师',   debate_counsel_b: '乙方律师',
            debate_arbitrator: '仲裁官裁定',
            debate_round: n => `第 ${n} 轮辩论`,
            debate_verdict_upgraded: '↑ 风险升级', debate_verdict_downgraded: '↓ 风险降级',
            debate_verdict_maintained: '= 评级维持',
            debate_key_upheld: '仲裁认可论点', debate_key_rejected: '仲裁驳回论点',
            debate_final_action: '仲裁后行动建议',
            debate_summary_title: '辩论仲裁摘要',
            debate_debated: '已辩论', debate_upgraded: '等级升级', debate_downgraded: '等级降级',
            debate_maintained: '评级维持', debate_skipped: '保留初稿',
            tab_debate: '辩论记录',
            // ★ 增强 B
            kb_updated: d => `知识库 ${d}`, doc_type_law: '法律法规', doc_type_judicial: '司法解释',
            doc_type_case: '典型案例', doc_type_regulation: '部门规章',
            case_analysis_title: '典型案例类比分析', case_similar: '相似案例', case_similarity: '相似度',
            case_outcome: '预测裁判结果', case_advice: '基于案例的建议', case_insight: '整体司法风险',
            no_case_analysis: '本次分析未检索到相关典型案例',
            // ★ 增强 C
            lawyer_review_suggest: (score) => `风险分 ${score} 分，建议申请律师专业审查`,
            request_lawyer_review: '申请律师审查', lawyer_review_requested: '✓ 审查申请已提交',
            lawyer_review_pending: '⏳ 等待律师接单', lawyer_review_assigned: '📋 律师审查中',
            lawyer_review_completed: '✅ 律师审查完成',
            lawyer_notes_placeholder: '请填写您希望律师重点审查的内容（选填）...',
            submit_review_request: '确认申请', cancel_btn2: '取消',
            endorsement_endorsed: '✅ 律师认可 AI 结论', endorsement_amended: '✏️ 律师已修订结论', endorsement_overridden: '⚠️ 律师推翻 AI 结论',
            lawyer_opinion_label: '律师专业意见', login_required_review: '请登录后申请律师审查',
          },
          'zh-TW': {
            subtitle: '專家級 AI 合約審查', subtitle2: '即時法律庫檢索', subtitle3: '深度談判博弈',
            step1_heading: '請選擇您想要審查的合約類型',
            step1_desc: '精準的類型選擇將匹配更專業的法律庫索引',
            expand_all: '展開全部細節', collapse_all: '隱藏全部細節',
            back_btn: '返回重選類型', current_type: '當前類型：',
            upload_title: '上傳合約文件', upload_formats: 'PDF · Word · 圖片 · TXT',
            upload_ocr_tip: '🖼️ 圖片自動 OCR + AI 優化',
            upload_max: n => `📏 最大 ${n.toLocaleString()} 字元`,
            or_paste: '或者直接貼上文字', textarea_placeholder: '在此貼上合約文字...',
            min_chars: n => `最少 ${n} 字`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` （還需 ${n} 字）`, chars_over: ' ⚠ 超出上限', chars_ok: ' ✓ 可以提交',
            start_review: '🔍 開始專家審查', input_first: '請先輸入合約內容',
            analyzing_subtitle: 'AI 專家審查通常需要 3-5 分鐘，請耐心等待',
            ocr_processing: '🤖 AI 正在優化 OCR 文字品質...', ocr_done: '✅ OCR 優化完成',
            cancel_btn: '取消審查',
            stages: ['文件解析', '風險審查', '談判策略', '修訂合約', '整合報告'],
            tab_overview: '閱讀原文', tab_risks: '風險解析', tab_negotiation: '博弈策略', tab_revised: '完整修訂',
            risk_dist: '風險分佈', core_threats: n => `核心威脅 (${n})`,
            original_clause: '原文表述', legal_basis: '法律依據', problem_title: '問題剖析',
            action_title: '行動對策', revision_suggestion: '防禦性條款修訂建議', plain_explanation: '通俗解釋',
            game_overview: '博弈全局觀', call_script: '電話面談腳本',
            opening_label: '開場 Opening', key_reasons_label: '核心理由 Key Reasons',
            style_strategies: '多風格談判策略',
            copy_btn: '複製', copied_btn: '✓ 已複製', copy_full: '複製全文', copy_full2: '複製全文',
            email_section: '書面溝通郵件',
            revised_title: '完整修訂合約',
            revised_desc: '已根據所有風險點生成修訂版合約，修訂處以【修訂】標記。',
            revised_full_tab: '修訂合約全文',
            revision_notes: n => `修訂說明 (${n} 處)`,
            download_txt: '下載 .txt', no_revision: '修訂合約內容生成中或暫不可用。',
            revision_item_label: i => `修訂 ${i + 1}`,
            overall_risk: '整體風險', risk_clauses_label: '風險條款',
            export_report: '匯出報告', restart_btn: '審查新合約',
            quick_nav_call: '電話面談腳本', quick_nav_email: '書面溝通郵件',
            style_aggressive: '強硬 Aggressive', style_consultative: '協商 Consultative', style_compromise: '妥協 Compromise',
            risk_lv: { xh: '極高風險', h: '高風險', m: '中等風險', l: '低風險', s: '安全' },
            cat_names: { '劳动用工类':'勞動用工類','房产物业类':'房產物業類','消费服务类':'消費服務類','金融借贷类':'金融借貸類','网络数字类':'網路數位類','婚姻家庭类':'婚姻家庭類','经营合作类':'經營合作類','其他类':'其他類' },
          },
          'en': {
            subtitle: 'Expert AI Contract Review', subtitle2: 'Real-time Legal DB Search', subtitle3: 'Deep Negotiation Strategy',
            step1_heading: 'Select Contract Type',
            step1_desc: 'The right category matches a more specialized legal database',
            expand_all: 'Expand All Details', collapse_all: 'Collapse All Details',
            back_btn: '← Back to Categories', current_type: 'Type: ',
            upload_title: 'Upload Contract Document', upload_formats: 'PDF · Word · Image · TXT',
            upload_ocr_tip: '🖼️ Auto OCR + AI Enhancement',
            upload_max: n => `📏 Max ${n.toLocaleString()} chars`,
            or_paste: 'Or paste text directly', textarea_placeholder: 'Paste contract text here...',
            min_chars: n => `Min ${n} chars`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (need ${n} more)`, chars_over: ' ⚠ Over limit', chars_ok: ' ✓ Ready',
            start_review: '🔍 Start Expert Review', input_first: 'Please enter contract text first',
            analyzing_subtitle: 'Expert AI review takes about 3-5 minutes, please wait',
            ocr_processing: '🤖 AI is enhancing OCR text quality...', ocr_done: '✅ OCR Enhancement Complete',
            cancel_btn: 'Cancel Review',
            stages: ['Parse Doc', 'Risk Review', 'Negotiation', 'Revision', 'Compile'],
            tab_overview: 'View Contract', tab_risks: 'Risk Analysis', tab_negotiation: 'Strategy', tab_revised: 'Revised Contract',
            risk_dist: 'Risk Distribution', core_threats: n => `Key Risks (${n})`,
            original_clause: 'Original Clause', legal_basis: 'Legal Basis', problem_title: 'Problem Analysis',
            action_title: 'Action Items', revision_suggestion: 'Suggested Defensive Wording', plain_explanation: 'Plain Language',
            game_overview: 'Negotiation Overview', call_script: 'Phone Call Script',
            opening_label: 'Opening', key_reasons_label: 'Key Reasons',
            style_strategies: 'Multi-Style Negotiation Strategies',
            copy_btn: 'Copy', copied_btn: '✓ Copied', copy_full: 'Copy All', copy_full2: 'Copy All',
            email_section: 'Written Communication Email',
            revised_title: 'Full Revised Contract',
            revised_desc: 'A revised contract has been generated based on all identified risks. Changes are marked with [REVISED].',
            revised_full_tab: 'Revised Contract Text',
            revision_notes: n => `Revision Notes (${n})`,
            download_txt: 'Download .txt', no_revision: 'Revised contract is being generated or unavailable.',
            revision_item_label: i => `Revision ${i + 1}`,
            overall_risk: 'Overall Risk', risk_clauses_label: 'Risk Clauses',
            export_report: 'Export Report', restart_btn: 'Review New Contract',
            quick_nav_call: 'Phone Call Script', quick_nav_email: 'Written Email',
            style_aggressive: 'Aggressive', style_consultative: 'Consultative', style_compromise: 'Compromise',
            risk_lv: { xh: 'Critical Risk', h: 'High Risk', m: 'Medium Risk', l: 'Low Risk', s: 'Safe' },
            cat_names: { '劳动用工类':'Employment','房产物业类':'Real Estate','消费服务类':'Consumer Services','金融借贷类':'Finance & Loans','网络数字类':'Digital & Internet','婚姻家庭类':'Family & Marriage','经营合作类':'Business Partnership','其他类':'Other' },
          },
          'ja': {
            subtitle: 'AI 専門家による契約レビュー', subtitle2: 'リアルタイム法律DBサーチ', subtitle3: '深度交渉戦略',
            step1_heading: 'レビューする契約の種類を選択してください',
            step1_desc: '正確なカテゴリ選択により、より専門的な法律データベースに対応します',
            expand_all: '詳細をすべて展開', collapse_all: '詳細をすべて折りたたむ',
            back_btn: '← カテゴリ選択に戻る', current_type: '種類：',
            upload_title: '契約書をアップロード', upload_formats: 'PDF · Word · 画像 · TXT',
            upload_ocr_tip: '🖼️ 自動 OCR + AI 最適化',
            upload_max: n => `📏 最大 ${n.toLocaleString()} 文字`,
            or_paste: 'またはテキストを直接貼り付け', textarea_placeholder: 'ここに契約文を貼り付け...',
            min_chars: n => `最低 ${n} 文字`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (あと ${n} 文字必要)`, chars_over: ' ⚠ 上限超過', chars_ok: ' ✓ 送信可能',
            start_review: '🔍 専門家レビュー開始', input_first: '契約内容を入力してください',
            analyzing_subtitle: 'AI 専門家レビューには約 3〜5 分かかります。しばらくお待ちください',
            ocr_processing: '🤖 AI が OCR テキストを最適化中...', ocr_done: '✅ OCR 最適化完了',
            cancel_btn: 'レビューをキャンセル',
            stages: ['文書解析', 'リスク審査', '交渉戦略', '修正契約', 'まとめ'],
            tab_overview: '原文を読む', tab_risks: 'リスク分析', tab_negotiation: '交渉戦略', tab_revised: '修正版契約',
            risk_dist: 'リスク分布', core_threats: n => `主要リスク (${n})`,
            original_clause: '原文条項', legal_basis: '法的根拠', problem_title: '問題分析',
            action_title: '対応策', revision_suggestion: '防衛的条項修正案', plain_explanation: 'わかりやすい解説',
            game_overview: '交渉の全体観', call_script: '電話交渉スクリプト',
            opening_label: '開場', key_reasons_label: '主な理由',
            style_strategies: 'マルチスタイル交渉戦略',
            copy_btn: 'コピー', copied_btn: '✓ コピー済', copy_full: '全文コピー', copy_full2: '全文コピー',
            email_section: '書面コミュニケーションメール',
            revised_title: '修正版契約書（全文）',
            revised_desc: '特定されたすべてのリスクに基づいて修正版契約を生成しました。変更箇所は【修訂】でマークされています。',
            revised_full_tab: '修正契約全文',
            revision_notes: n => `修正メモ (${n} 箇所)`,
            download_txt: '.txt ダウンロード', no_revision: '修正版契約の生成中または利用不可。',
            revision_item_label: i => `修正 ${i + 1}`,
            overall_risk: '総合リスク', risk_clauses_label: 'リスク条項',
            export_report: 'レポート出力', restart_btn: '新しい契約をレビュー',
            quick_nav_call: '電話スクリプト', quick_nav_email: 'メール草稿',
            style_aggressive: '強硬スタイル', style_consultative: '協議スタイル', style_compromise: '妥協スタイル',
            risk_lv: { xh: '超高リスク', h: '高リスク', m: '中リスク', l: '低リスク', s: '安全' },
            cat_names: { '劳动用工类':'労働・雇用','房产物业类':'不動産','消费服务类':'消費者サービス','金融借贷类':'金融・融資','网络数字类':'デジタル・ネット','婚姻家庭类':'婚姻・家族','经营合作类':'事業提携','其他类':'その他' },
          },
          'ko': {
            subtitle: 'AI 전문가 계약서 검토', subtitle2: '실시간 법률 DB 검색', subtitle3: '심층 협상 전략',
            step1_heading: '검토할 계약 유형을 선택하세요',
            step1_desc: '정확한 유형 선택은 더 전문적인 법률 데이터베이스와 매칭됩니다',
            expand_all: '모두 펼치기', collapse_all: '모두 접기',
            back_btn: '← 유형 선택으로 돌아가기', current_type: '유형：',
            upload_title: '계약서 업로드', upload_formats: 'PDF · Word · 이미지 · TXT',
            upload_ocr_tip: '🖼️ 자동 OCR + AI 최적화',
            upload_max: n => `📏 최대 ${n.toLocaleString()} 자`,
            or_paste: '또는 텍스트 직접 붙여넣기', textarea_placeholder: '여기에 계약서 텍스트를 붙여넣으세요...',
            min_chars: n => `최소 ${n} 자`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (${n} 자 더 필요)`, chars_over: ' ⚠ 한도 초과', chars_ok: ' ✓ 제출 가능',
            start_review: '🔍 전문가 검토 시작', input_first: '계약서 내용을 먼저 입력해주세요',
            analyzing_subtitle: 'AI 전문가 검토는 보통 3~5분 소요됩니다. 잠시 기다려 주세요',
            ocr_processing: '🤖 AI가 OCR 텍스트 품질을 최적화 중...', ocr_done: '✅ OCR 최적화 완료',
            cancel_btn: '검토 취소',
            stages: ['문서 파싱', '위험 검토', '협상 전략', '수정 계약', '보고서 정리'],
            tab_overview: '원문 보기', tab_risks: '위험 분석', tab_negotiation: '협상 전략', tab_revised: '수정 계약서',
            risk_dist: '위험 분포', core_threats: n => `핵심 위험 (${n})`,
            original_clause: '원문 조항', legal_basis: '법적 근거', problem_title: '문제 분석',
            action_title: '대응 방안', revision_suggestion: '방어적 조항 수정 제안', plain_explanation: '쉬운 설명',
            game_overview: '협상 전체 관점', call_script: '전화 협상 스크립트',
            opening_label: '오프닝', key_reasons_label: '핵심 이유',
            style_strategies: '다양한 협상 스타일 전략',
            copy_btn: '복사', copied_btn: '✓ 복사됨', copy_full: '전체 복사', copy_full2: '전체 복사',
            email_section: '서면 커뮤니케이션 이메일',
            revised_title: '전체 수정 계약서',
            revised_desc: '모든 위험 포인트를 기반으로 수정된 계약서가 생성되었습니다. 수정 사항은 【修訂】으로 표시됩니다.',
            revised_full_tab: '수정 계약서 전문',
            revision_notes: n => `수정 메모 (${n}건)`,
            download_txt: '.txt 다운로드', no_revision: '수정 계약서 내용이 생성 중이거나 사용할 수 없습니다.',
            revision_item_label: i => `수정 ${i + 1}`,
            overall_risk: '전체 위험', risk_clauses_label: '위험 조항',
            export_report: '보고서 내보내기', restart_btn: '새 계약서 검토',
            quick_nav_call: '전화 스크립트', quick_nav_email: '이메일 초안',
            style_aggressive: '강경 스타일', style_consultative: '협의 스타일', style_compromise: '타협 스타일',
            risk_lv: { xh: '초고위험', h: '고위험', m: '중위험', l: '저위험', s: '안전' },
            cat_names: { '劳动用工类':'고용·노동','房产物业类':'부동산','消费服务类':'소비자서비스','金融借贷类':'금융·대출','网络数字类':'디지털·인터넷','婚姻家庭类':'혼인·가족','经营合作类':'사업·파트너십','其他类':'기타' },
          },
          'fr': {
            subtitle: "Révision de contrat par IA experte", subtitle2: 'Recherche juridique en temps réel', subtitle3: 'Stratégie de négociation approfondie',
            step1_heading: 'Sélectionnez le type de contrat à réviser',
            step1_desc: 'Un type précis permet de cibler une base de données juridique spécialisée',
            expand_all: 'Développer tout', collapse_all: 'Réduire tout',
            back_btn: '← Retour aux catégories', current_type: 'Type : ',
            upload_title: 'Télécharger le contrat', upload_formats: 'PDF · Word · Image · TXT',
            upload_ocr_tip: '🖼️ OCR auto + amélioration IA',
            upload_max: n => `📏 Max ${n.toLocaleString()} caractères`,
            or_paste: 'Ou coller le texte directement', textarea_placeholder: 'Collez le texte du contrat ici...',
            min_chars: n => `Min ${n} caractères`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (${n} caractères manquants)`, chars_over: ' ⚠ Limite dépassée', chars_ok: ' ✓ Prêt à soumettre',
            start_review: '🔍 Démarrer la révision', input_first: 'Veuillez saisir le texte du contrat',
            analyzing_subtitle: "La révision prend généralement 3 à 5 minutes, veuillez patienter",
            ocr_processing: "🤖 L'IA améliore la qualité OCR...", ocr_done: '✅ Amélioration OCR terminée',
            cancel_btn: 'Annuler',
            stages: ['Analyse doc.', 'Risques', 'Négociation', 'Révision', 'Compilation'],
            tab_overview: 'Lire le contrat', tab_risks: 'Analyse des risques', tab_negotiation: 'Stratégie', tab_revised: 'Contrat révisé',
            risk_dist: 'Distribution des risques', core_threats: n => `Risques clés (${n})`,
            original_clause: 'Clause originale', legal_basis: 'Base légale', problem_title: "Analyse du problème",
            action_title: "Plan d'action", revision_suggestion: 'Reformulation défensive suggérée', plain_explanation: 'Explication simplifiée',
            game_overview: 'Vue globale de la négociation', call_script: "Script d'appel téléphonique",
            opening_label: 'Ouverture', key_reasons_label: 'Arguments clés',
            style_strategies: 'Stratégies de négociation multi-styles',
            copy_btn: 'Copier', copied_btn: '✓ Copié', copy_full: 'Tout copier', copy_full2: 'Tout copier',
            email_section: 'Email de communication écrite',
            revised_title: 'Contrat révisé complet',
            revised_desc: 'Un contrat révisé a été généré sur la base de tous les risques identifiés. Les modifications sont marquées [RÉVISÉ].',
            revised_full_tab: 'Texte du contrat révisé',
            revision_notes: n => `Notes de révision (${n})`,
            download_txt: 'Télécharger .txt', no_revision: 'Le contrat révisé est en cours de génération ou indisponible.',
            revision_item_label: i => `Révision ${i + 1}`,
            overall_risk: 'Risque global', risk_clauses_label: 'Clauses à risque',
            export_report: 'Exporter le rapport', restart_btn: 'Réviser un nouveau contrat',
            quick_nav_call: 'Script téléphonique', quick_nav_email: 'Email',
            style_aggressive: 'Agressif', style_consultative: 'Consultatif', style_compromise: 'Compromis',
            risk_lv: { xh: 'Risque critique', h: 'Risque élevé', m: 'Risque moyen', l: 'Risque faible', s: 'Sûr' },
            cat_names: { '劳动用工类':'Travail & Emploi','房产物业类':'Immobilier','消费服务类':'Services aux consommateurs','金融借贷类':'Finance & Prêts','网络数字类':'Numérique & Internet','婚姻家庭类':'Famille & Mariage','经营合作类':'Partenariat commercial','其他类':'Autres' },
          },
          'de': {
            subtitle: 'KI-Expertenprüfung von Verträgen', subtitle2: 'Echtzeit-Rechtsdatenbanksuche', subtitle3: 'Tiefgehende Verhandlungsstrategie',
            step1_heading: 'Wählen Sie den Vertragstyp aus',
            step1_desc: 'Eine genaue Kategorieauswahl passt besser zur Rechtsdatenbank',
            expand_all: 'Alle Details ausklappen', collapse_all: 'Alle Details einklappen',
            back_btn: '← Zurück zur Auswahl', current_type: 'Typ: ',
            upload_title: 'Vertrag hochladen', upload_formats: 'PDF · Word · Bild · TXT',
            upload_ocr_tip: '🖼️ Auto-OCR + KI-Verbesserung',
            upload_max: n => `📏 Max. ${n.toLocaleString()} Zeichen`,
            or_paste: 'Oder Text direkt einfügen', textarea_placeholder: 'Vertragstext hier einfügen...',
            min_chars: n => `Min. ${n} Zeichen`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (noch ${n} Zeichen)`, chars_over: ' ⚠ Limit überschritten', chars_ok: ' ✓ Bereit',
            start_review: '🔍 Expertenprüfung starten', input_first: 'Bitte Vertragstext eingeben',
            analyzing_subtitle: 'Die KI-Expertenprüfung dauert ca. 3–5 Minuten, bitte warten',
            ocr_processing: '🤖 KI verbessert OCR-Textqualität...', ocr_done: '✅ OCR-Verbesserung abgeschlossen',
            cancel_btn: 'Prüfung abbrechen',
            stages: ['Dok. Analyse', 'Risikop.', 'Verhandlung', 'Überarbeitung', 'Bericht'],
            tab_overview: 'Vertrag lesen', tab_risks: 'Risikoanalyse', tab_negotiation: 'Strategie', tab_revised: 'Revidierter Vertrag',
            risk_dist: 'Risikoverteilung', core_threats: n => `Hauptrisiken (${n})`,
            original_clause: 'Originalklausel', legal_basis: 'Rechtsgrundlage', problem_title: 'Problemanalyse',
            action_title: 'Maßnahmen', revision_suggestion: 'Defensiver Formulierungsvorschlag', plain_explanation: 'Einfache Erklärung',
            game_overview: 'Verhandlungsübersicht', call_script: 'Telefonskript',
            opening_label: 'Eröffnung', key_reasons_label: 'Hauptargumente',
            style_strategies: 'Multi-Style-Verhandlungsstrategien',
            copy_btn: 'Kopieren', copied_btn: '✓ Kopiert', copy_full: 'Alles kopieren', copy_full2: 'Alles kopieren',
            email_section: 'Schriftliche Kommunikations-E-Mail',
            revised_title: 'Vollständiger überarbeiteter Vertrag',
            revised_desc: 'Ein überarbeiteter Vertrag wurde auf Basis aller Risiken erstellt. Änderungen sind mit [ÜBERARBEITET] markiert.',
            revised_full_tab: 'Überarbeiteter Vertragstext',
            revision_notes: n => `Überarbeitungshinweise (${n})`,
            download_txt: '.txt herunterladen', no_revision: 'Überarbeiteter Vertrag wird generiert oder ist nicht verfügbar.',
            revision_item_label: i => `Änderung ${i + 1}`,
            overall_risk: 'Gesamtrisiko', risk_clauses_label: 'Risikoklauseln',
            export_report: 'Bericht exportieren', restart_btn: 'Neuen Vertrag prüfen',
            quick_nav_call: 'Telefonskript', quick_nav_email: 'E-Mail',
            style_aggressive: 'Aggressiv', style_consultative: 'Konsultativ', style_compromise: 'Kompromiss',
            risk_lv: { xh: 'Kritisches Risiko', h: 'Hohes Risiko', m: 'Mittleres Risiko', l: 'Niedriges Risiko', s: 'Sicher' },
            cat_names: { '劳动用工类':'Arbeit & Beschäftigung','房产物业类':'Immobilien','消费服务类':'Verbraucherdienstleistungen','金融借贷类':'Finanzen & Kredite','网络数字类':'Digital & Internet','婚姻家庭类':'Familie & Ehe','经营合作类':'Geschäftspartnerschaft','其他类':'Andere' },
          },
          'es': {
            subtitle: 'Revisión de contratos con IA experta', subtitle2: 'Búsqueda jurídica en tiempo real', subtitle3: 'Estrategia de negociación profunda',
            step1_heading: 'Seleccione el tipo de contrato a revisar',
            step1_desc: 'Una selección precisa permite acceder a bases de datos jurídicas especializadas',
            expand_all: 'Expandir todo', collapse_all: 'Contraer todo',
            back_btn: '← Volver a categorías', current_type: 'Tipo: ',
            upload_title: 'Subir contrato', upload_formats: 'PDF · Word · Imagen · TXT',
            upload_ocr_tip: '🖼️ OCR automático + mejora IA',
            upload_max: n => `📏 Máx. ${n.toLocaleString()} caracteres`,
            or_paste: 'O pegar texto directamente', textarea_placeholder: 'Pegue el texto del contrato aquí...',
            min_chars: n => `Mín. ${n} caracteres`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (faltan ${n} caracteres)`, chars_over: ' ⚠ Límite superado', chars_ok: ' ✓ Listo',
            start_review: '🔍 Iniciar revisión experta', input_first: 'Por favor ingrese el texto del contrato',
            analyzing_subtitle: 'La revisión experta suele tardar 3-5 minutos, por favor espere',
            ocr_processing: '🤖 La IA está mejorando la calidad OCR...', ocr_done: '✅ Mejora OCR completada',
            cancel_btn: 'Cancelar revisión',
            stages: ['Análisis doc.', 'Riesgos', 'Negociación', 'Revisión', 'Informe'],
            tab_overview: 'Leer contrato', tab_risks: 'Análisis de riesgos', tab_negotiation: 'Estrategia', tab_revised: 'Contrato revisado',
            risk_dist: 'Distribución de riesgos', core_threats: n => `Riesgos clave (${n})`,
            original_clause: 'Cláusula original', legal_basis: 'Base legal', problem_title: 'Análisis del problema',
            action_title: 'Medidas', revision_suggestion: 'Redacción defensiva sugerida', plain_explanation: 'Explicación sencilla',
            game_overview: 'Visión global de negociación', call_script: 'Guión de llamada telefónica',
            opening_label: 'Apertura', key_reasons_label: 'Argumentos clave',
            style_strategies: 'Estrategias de negociación multi-estilo',
            copy_btn: 'Copiar', copied_btn: '✓ Copiado', copy_full: 'Copiar todo', copy_full2: 'Copiar todo',
            email_section: 'Correo de comunicación escrita',
            revised_title: 'Contrato revisado completo',
            revised_desc: 'Se ha generado un contrato revisado basado en todos los riesgos identificados. Los cambios están marcados con [REVISADO].',
            revised_full_tab: 'Texto del contrato revisado',
            revision_notes: n => `Notas de revisión (${n})`,
            download_txt: 'Descargar .txt', no_revision: 'El contrato revisado se está generando o no está disponible.',
            revision_item_label: i => `Revisión ${i + 1}`,
            overall_risk: 'Riesgo global', risk_clauses_label: 'Cláusulas de riesgo',
            export_report: 'Exportar informe', restart_btn: 'Revisar nuevo contrato',
            quick_nav_call: 'Guión telefónico', quick_nav_email: 'Correo',
            style_aggressive: 'Agresivo', style_consultative: 'Consultivo', style_compromise: 'Compromiso',
            risk_lv: { xh: 'Riesgo crítico', h: 'Riesgo alto', m: 'Riesgo medio', l: 'Riesgo bajo', s: 'Seguro' },
            cat_names: { '劳动用工类':'Trabajo y Empleo','房产物业类':'Inmuebles','消费服务类':'Servicios al Consumidor','金融借贷类':'Finanzas y Préstamos','网络数字类':'Digital e Internet','婚姻家庭类':'Familia y Matrimonio','经营合作类':'Sociedad Empresarial','其他类':'Otros' },
          },
          'pt': {
            subtitle: 'Revisão de contratos com IA especializada', subtitle2: 'Pesquisa jurídica em tempo real', subtitle3: 'Estratégia de negociação profunda',
            step1_heading: 'Selecione o tipo de contrato para revisão',
            step1_desc: 'Uma seleção precisa permite acesso a bases de dados jurídicas especializadas',
            expand_all: 'Expandir tudo', collapse_all: 'Recolher tudo',
            back_btn: '← Voltar às categorias', current_type: 'Tipo: ',
            upload_title: 'Enviar contrato', upload_formats: 'PDF · Word · Imagem · TXT',
            upload_ocr_tip: '🖼️ OCR automático + melhoria IA',
            upload_max: n => `📏 Máx. ${n.toLocaleString()} caracteres`,
            or_paste: 'Ou colar texto diretamente', textarea_placeholder: 'Cole o texto do contrato aqui...',
            min_chars: n => `Mín. ${n} caracteres`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (faltam ${n} caracteres)`, chars_over: ' ⚠ Limite excedido', chars_ok: ' ✓ Pronto',
            start_review: '🔍 Iniciar revisão especializada', input_first: 'Por favor insira o texto do contrato',
            analyzing_subtitle: 'A revisão especializada geralmente leva 3-5 minutos',
            ocr_processing: '🤖 A IA está melhorando a qualidade OCR...', ocr_done: '✅ Melhoria OCR concluída',
            cancel_btn: 'Cancelar revisão',
            stages: ['Análise doc.', 'Riscos', 'Negociação', 'Revisão', 'Relatório'],
            tab_overview: 'Ler contrato', tab_risks: 'Análise de riscos', tab_negotiation: 'Estratégia', tab_revised: 'Contrato revisado',
            risk_dist: 'Distribuição de riscos', core_threats: n => `Riscos principais (${n})`,
            original_clause: 'Cláusula original', legal_basis: 'Base legal', problem_title: 'Análise do problema',
            action_title: 'Medidas', revision_suggestion: 'Redação defensiva sugerida', plain_explanation: 'Explicação simples',
            game_overview: 'Visão geral da negociação', call_script: 'Roteiro de ligação',
            opening_label: 'Abertura', key_reasons_label: 'Argumentos principais',
            style_strategies: 'Estratégias de negociação multiestilo',
            copy_btn: 'Copiar', copied_btn: '✓ Copiado', copy_full: 'Copiar tudo', copy_full2: 'Copiar tudo',
            email_section: 'E-mail de comunicação escrita',
            revised_title: 'Contrato revisado completo',
            revised_desc: 'Um contrato revisado foi gerado com base em todos os riscos identificados. As alterações são marcadas com [REVISADO].',
            revised_full_tab: 'Texto do contrato revisado',
            revision_notes: n => `Notas de revisão (${n})`,
            download_txt: 'Baixar .txt', no_revision: 'O contrato revisado está sendo gerado ou indisponível.',
            revision_item_label: i => `Revisão ${i + 1}`,
            overall_risk: 'Risco geral', risk_clauses_label: 'Cláusulas de risco',
            export_report: 'Exportar relatório', restart_btn: 'Revisar novo contrato',
            quick_nav_call: 'Roteiro telefônico', quick_nav_email: 'E-mail',
            style_aggressive: 'Agressivo', style_consultative: 'Consultivo', style_compromise: 'Compromisso',
            risk_lv: { xh: 'Risco crítico', h: 'Risco alto', m: 'Risco médio', l: 'Risco baixo', s: 'Seguro' },
            cat_names: { '劳动用工类':'Trabalho e Emprego','房产物业类':'Imóveis','消费服务类':'Serviços ao Consumidor','金融借贷类':'Finanças e Empréstimos','网络数字类':'Digital e Internet','婚姻家庭类':'Família e Casamento','经营合作类':'Parceria Empresarial','其他类':'Outros' },
          },
          'ar': {
            subtitle: 'مراجعة العقود بواسطة خبراء الذكاء الاصطناعي', subtitle2: 'بحث قانوني فوري', subtitle3: 'استراتيجية تفاوض متعمقة',
            step1_heading: 'اختر نوع العقد للمراجعة',
            step1_desc: 'الاختيار الدقيق يتيح الوصول إلى قواعد البيانات القانونية المتخصصة',
            expand_all: 'توسيع الكل', collapse_all: 'طي الكل',
            back_btn: '← العودة إلى الفئات', current_type: 'النوع: ',
            upload_title: 'رفع العقد', upload_formats: 'PDF · Word · صورة · TXT',
            upload_ocr_tip: '🖼️ OCR تلقائي + تحسين الذكاء الاصطناعي',
            upload_max: n => `📏 الحد الأقصى ${n.toLocaleString()} حرف`,
            or_paste: 'أو لصق النص مباشرةً', textarea_placeholder: 'الصق نص العقد هنا...',
            min_chars: n => `الحد الأدنى ${n} حرف`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (تحتاج ${n} حرفاً إضافياً)`, chars_over: ' ⚠ تجاوز الحد', chars_ok: ' ✓ جاهز للإرسال',
            start_review: '🔍 بدء المراجعة الخبيرة', input_first: 'الرجاء إدخال نص العقد',
            analyzing_subtitle: 'تستغرق مراجعة الخبراء عادةً 3-5 دقائق، يرجى الانتظار',
            ocr_processing: '🤖 الذكاء الاصطناعي يحسن جودة نص OCR...', ocr_done: '✅ اكتمل تحسين OCR',
            cancel_btn: 'إلغاء المراجعة',
            stages: ['تحليل المستند', 'مراجعة المخاطر', 'التفاوض', 'التعديل', 'التقرير'],
            tab_overview: 'قراءة العقد', tab_risks: 'تحليل المخاطر', tab_negotiation: 'الاستراتيجية', tab_revised: 'العقد المعدّل',
            risk_dist: 'توزيع المخاطر', core_threats: n => `المخاطر الرئيسية (${n})`,
            original_clause: 'البند الأصلي', legal_basis: 'الأساس القانوني', problem_title: 'تحليل المشكلة',
            action_title: 'الإجراءات', revision_suggestion: 'الصياغة الدفاعية المقترحة', plain_explanation: 'شرح مبسّط',
            game_overview: 'نظرة عامة على التفاوض', call_script: 'سكريبت المكالمة الهاتفية',
            opening_label: 'الافتتاح', key_reasons_label: 'الحجج الرئيسية',
            style_strategies: 'استراتيجيات تفاوض متعددة الأساليب',
            copy_btn: 'نسخ', copied_btn: '✓ تم النسخ', copy_full: 'نسخ الكل', copy_full2: 'نسخ الكل',
            email_section: 'بريد إلكتروني للتواصل الكتابي',
            revised_title: 'العقد المعدّل الكامل',
            revised_desc: 'تم إنشاء عقد معدّل بناءً على جميع المخاطر المحددة. التعديلات مُعلَّمة بـ [معدّل].',
            revised_full_tab: 'نص العقد المعدّل',
            revision_notes: n => `ملاحظات التعديل (${n})`,
            download_txt: 'تنزيل .txt', no_revision: 'العقد المعدّل قيد الإنشاء أو غير متوفر.',
            revision_item_label: i => `تعديل ${i + 1}`,
            overall_risk: 'المخاطر الإجمالية', risk_clauses_label: 'بنود المخاطر',
            export_report: 'تصدير التقرير', restart_btn: 'مراجعة عقد جديد',
            quick_nav_call: 'سكريبت الهاتف', quick_nav_email: 'البريد الإلكتروني',
            style_aggressive: 'أسلوب حازم', style_consultative: 'أسلوب تشاوري', style_compromise: 'أسلوب توافقي',
            risk_lv: { xh: 'خطر حرج', h: 'خطر عالٍ', m: 'خطر متوسط', l: 'خطر منخفض', s: 'آمن' },
            cat_names: { '劳动用工类':'العمل والتوظيف','房产物业类':'العقارات','消费服务类':'خدمات المستهلك','金融借贷类':'التمويل والقروض','网络数字类':'الرقمي والإنترنت','婚姻家庭类':'الزواج والأسرة','经营合作类':'الشراكة التجارية','其他类':'أخرى' },
          },
          'ru': {
            subtitle: 'Экспертная проверка договоров с помощью ИИ', subtitle2: 'Поиск по правовой базе в реальном времени', subtitle3: 'Глубокая переговорная стратегия',
            step1_heading: 'Выберите тип договора для проверки',
            step1_desc: 'Точный выбор типа обеспечит доступ к специализированной правовой базе данных',
            expand_all: 'Развернуть всё', collapse_all: 'Свернуть всё',
            back_btn: '← Назад к выбору', current_type: 'Тип: ',
            upload_title: 'Загрузить договор', upload_formats: 'PDF · Word · Изображение · TXT',
            upload_ocr_tip: '🖼️ Авто-OCR + улучшение ИИ',
            upload_max: n => `📏 Макс. ${n.toLocaleString()} символов`,
            or_paste: 'Или вставьте текст напрямую', textarea_placeholder: 'Вставьте текст договора здесь...',
            min_chars: n => `Мин. ${n} символов`,
            chars_info: (c, m) => `${c.toLocaleString()} / ${m.toLocaleString()}`,
            chars_need_more: n => ` (ещё ${n} символов)`, chars_over: ' ⚠ Превышен лимит', chars_ok: ' ✓ Готово',
            start_review: '🔍 Начать экспертную проверку', input_first: 'Пожалуйста, введите текст договора',
            analyzing_subtitle: 'Экспертная проверка ИИ обычно занимает 3–5 минут, пожалуйста подождите',
            ocr_processing: '🤖 ИИ улучшает качество OCR-текста...', ocr_done: '✅ Улучшение OCR завершено',
            cancel_btn: 'Отменить проверку',
            stages: ['Анализ документа', 'Риски', 'Переговоры', 'Редакция', 'Отчёт'],
            tab_overview: 'Читать договор', tab_risks: 'Анализ рисков', tab_negotiation: 'Стратегия', tab_revised: 'Исправленный договор',
            risk_dist: 'Распределение рисков', core_threats: n => `Ключевые риски (${n})`,
            original_clause: 'Исходный пункт', legal_basis: 'Правовая основа', problem_title: 'Анализ проблемы',
            action_title: 'Меры', revision_suggestion: 'Предлагаемая защитная формулировка', plain_explanation: 'Простое объяснение',
            game_overview: 'Общий взгляд на переговоры', call_script: 'Скрипт телефонного разговора',
            opening_label: 'Вступление', key_reasons_label: 'Ключевые аргументы',
            style_strategies: 'Стратегии переговоров в разных стилях',
            copy_btn: 'Копировать', copied_btn: '✓ Скопировано', copy_full: 'Копировать всё', copy_full2: 'Копировать всё',
            email_section: 'Электронное письмо для переписки',
            revised_title: 'Полный исправленный договор',
            revised_desc: 'Исправленный договор создан на основе всех выявленных рисков. Изменения отмечены [ИСПРАВЛЕНО].',
            revised_full_tab: 'Текст исправленного договора',
            revision_notes: n => `Примечания к правкам (${n})`,
            download_txt: 'Скачать .txt', no_revision: 'Исправленный договор генерируется или недоступен.',
            revision_item_label: i => `Правка ${i + 1}`,
            overall_risk: 'Общий риск', risk_clauses_label: 'Рискованные пункты',
            export_report: 'Экспорт отчёта', restart_btn: 'Проверить новый договор',
            quick_nav_call: 'Телефонный скрипт', quick_nav_email: 'Письмо',
            style_aggressive: 'Агрессивный', style_consultative: 'Консультативный', style_compromise: 'Компромисс',
            risk_lv: { xh: 'Критический риск', h: 'Высокий риск', m: 'Средний риск', l: 'Низкий риск', s: 'Безопасно' },
            cat_names: { '劳动用工类':'Трудовые договоры','房产物业类':'Недвижимость','消费服务类':'Потребительские услуги','金融借贷类':'Финансы и кредиты','网络数字类':'Цифровые договоры','婚姻家庭类':'Семья и брак','经营合作类':'Бизнес-партнёрство','其他类':'Прочее' },
          },
        };

        // ==================== 合同类型 ====================
        const CATEGORIES = [
            { id: '劳动用工类', icon: 'users',         detail: '**涵盖合同**：劳动合同、劳务合同、实习协议、竞业限制协议、保密协议、离职协议等。\n **审查重点**：试用期约定、薪资结构、工时制度、社保缴纳、违约金条款、竞业限制补偿等。' },
            { id: '房产物业类', icon: 'home',          detail: '**涵盖合同**：商品房买卖合同、房屋租赁合同、二手房买卖合同、装修合同、物业服务合同、房产中介服务合同等。\n **审查重点**：产权清晰度、交付标准、违约责任、押金退还、装修质量、物业费用等。' },
            { id: '消费服务类', icon: 'shopping-cart', detail: '**涵盖合同**：教育培训合同、健身/美容/预付卡服务合同、旅游合同、婚庆服务合同、家政服务合同、维修服务合同等。\n **审查重点**：退费条款、格式条款、虚假宣传、预付款安全、服务标准、霸王条款等。' },
            { id: '金融借贷类', icon: 'banknote',      detail: '**涵盖合同**：借款合同（个人/银行）、网络借贷合同、信用卡协议、担保合同、抵押合同、融资租赁合同等。\n **审查重点**：利率上限、复利计算、担保责任、提前还款违约金、征信条款等。' },
            { id: '网络数字类', icon: 'globe',         detail: '**涵盖合同**：用户注册协议/隐私政策、软件许可协议、电商交易合同、网络直播/游戏服务协议、云服务合同、数据授权协议等。\n **审查重点**：个人信息收集范围、数据使用授权、免责条款、账号归属、虚拟财产、自动续费等。' },
            { id: '婚姻家庭类', icon: 'heart',         detail: '**涵盖合同**：婚前/婚内财产协议、离婚协议、收养协议、遗赠扶养协议等。\n **审查重点**：财产归属约定、债务承担、子女抚养、赡养义务、撤销条件等。' },
            { id: '经营合作类', icon: 'briefcase',     detail: '**涵盖合同**：合伙协议、股东协议/公司章程，加盟/特许经营合同，经销/代理合同，联营合同，对赌协议等。\n **审查重点**：出资责任，盈亏分配，退出机制，竞业禁止，无限连带责任，对赌条款效力等。' },
            { id: '其他类',     icon: 'more-horizontal',detail: '**涵盖合同**：无法归入上述7类的合同，如赠与合同、借用合同、仓储合同、运输合同、知识产权许可等。' },
        ];


        // ─────────────────── 登录页面组件 ───────────────────
        const LoginPage = ({ onLogin, onClose }) => {
            const [mode, setMode] = React.useState('sms'); // 'sms' | 'pwd' | 'register'
            const [phone, setPhone] = React.useState('');
            const [otp, setOtp] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [confirmPwd, setConfirmPwd] = React.useState('');
            const [nickname, setNickname] = React.useState('');
            const [countdown, setCountdown] = React.useState(0);
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [showPwd, setShowPwd] = React.useState(false);
            const [devOtp, setDevOtp] = React.useState(''); // 开发模式显示的 OTP 提示
            const timerRef = React.useRef(null);

            React.useEffect(() => { lucide.createIcons(); }, [mode, error, success, devOtp]);
            React.useEffect(() => () => { if (timerRef.current) clearInterval(timerRef.current); }, []);

            const validatePhone = p => /^1[3-9]\d{9}$/.test(p);

            // ── 发送验证码 ──
            const sendOtp = async () => {
                if (!validatePhone(phone)) { setError('请输入正确的手机号码（11位）'); return; }
                setError(''); setSuccess('');
                try {
                    const res  = await fetch(API_BASE_URL + '/auth/send-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'bypass-tunnel-reminder': 'true' },
                        body: JSON.stringify({ phone }),
                    });
                    const data = await res.json();
                    if (!res.ok) { setError(data.message || '发送失败，请稍后重试'); return; }
                    setSuccess(data.message || '验证码已发送');
                    // 开发模式：后端返回 dev_otp 字段方便测试
                    if (data.dev_otp) {
                        setDevOtp(`🔧 开发模式验证码：${data.dev_otp}`);
                    }
                    setCountdown(60);
                    timerRef.current = setInterval(() => setCountdown(c => {
                        if (c <= 1) { clearInterval(timerRef.current); return 0; }
                        return c - 1;
                    }), 1000);
                } catch { setError('网络错误，请检查后端服务是否运行'); }
            };

            // ── 统一登录处理 ──
            const doAuth = async (endpoint, body) => {
                setLoading(true); setError('');
                try {
                    const res  = await fetch(API_BASE_URL + endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'bypass-tunnel-reminder': 'true' },
                        body: JSON.stringify(body),
                    });
                    const data = await res.json();
                    if (!res.ok) { setError(data.message || '操作失败，请重试'); setLoading(false); return; }
                    // 成功：交由父组件存储 token 并更新 currentUser
                    onLogin({ user: data.user, access_token: data.access_token, refresh_token: data.refresh_token });
                } catch { setError('网络错误，请检查后端服务是否运行'); setLoading(false); }
            };

            const handleSmsLogin  = () => {
                if (!validatePhone(phone)) { setError('请输入正确的手机号'); return; }
                if (!otp) { setError('请输入验证码'); return; }
                doAuth('/auth/verify-otp', { phone, code: otp }); 
            };
            const handlePwdLogin  = () => {
                if (!validatePhone(phone)) { setError('请输入正确的手机号'); return; }
                if (!password) { setError('请输入密码'); return; }
                doAuth('/auth/login-pwd', { phone, password });
            };
            const handleRegister  = () => {
                if (!validatePhone(phone)) { setError('请输入正确的手机号'); return; }
                if (!otp) { setError('请输入验证码'); return; }
                if (!password || password.length < 6) { setError('密码至少 6 位字符'); return; }
                if (password !== confirmPwd) { setError('两次输入的密码不一致'); return; }
                doAuth('/auth/register', { phone, otp, password, nickname: nickname || undefined });
            };

            const tabs = [
                { key: 'sms', label: '验证码登录' },
                { key: 'pwd', label: '密码登录' },
                { key: 'register', label: '注册账号' },
            ];

            const doAction = mode === 'sms' ? handleSmsLogin : mode === 'pwd' ? handlePwdLogin : handleRegister;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4"
                    style={{ background: 'rgba(240,245,255,0.96)', backdropFilter: 'blur(16px)' }}
                    onClick={e => { if (e.target === e.currentTarget && onClose) onClose(); }}>
                    <div className="w-full max-w-md modal-in" style={{ background: 'rgba(245,250,255,0.93)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '2rem', overflow: 'hidden', boxShadow: '0 40px 120px rgba(0,0,0,0.7), 0 0 0 1px rgba(99,102,241,0.06) inset' }}>
                        <div className="login-modal-glow"></div>
                        {/* 顶部 banner */}
                        <div className="relative px-10 pt-10 pb-7 text-center" style={{ background: 'linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1))', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                            {onClose && (
                                <button onClick={onClose} className="absolute top-5 right-5 w-8 h-8 rounded-full flex items-center justify-center text-slate-500 hover:text-white hover:bg-white/10 transition-all">
                                    <i data-lucide="x" className="w-4 h-4"></i>
                                </button>
                            )}
                            <div className="inline-flex items-center justify-center w-12 h-12 rounded-2xl mb-4" style={{ background: 'linear-gradient(135deg, #3b82f6, #8b5cf6)', boxShadow: '0 8px 24px rgba(99,102,241,0.4)', opacity: 0.85 }}>
                                <i data-lucide="scale" className="w-6 h-6 text-white"></i>
                            </div>
                            <h1 className="text-2xl font-black display-font tracking-tighter">对簿<span className="gradient-text">AI</span></h1>
                            <p className="text-slate-500 text-sm mt-1">智能合同审查 · 法律风险预警</p>
                        </div>

                        <div className="p-8">
                            {/* 登录方式标签 */}
                            <div className="flex gap-1 p-1 mb-6 rounded-xl" style={{ background: 'rgba(255,255,255,0.5)', border: '1px solid rgba(255,255,255,0.06)' }}>
                                {tabs.map(tab => (
                                    <button key={tab.key}
                                        onClick={() => { setMode(tab.key); setError(''); setSuccess(''); }}
                                        className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${mode === tab.key ? 'bg-gradient-to-r from-blue-600/60 to-violet-600/60 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>

                            {/* 错误/成功提示 */}
                            {error && (
                                <div className="flex items-center gap-2 text-sm text-red-400 rounded-xl px-4 py-3 mb-4" style={{ background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.2)' }}>
                                    <i data-lucide="alert-circle" className="w-4 h-4 shrink-0"></i> {error}
                                </div>
                            )}
                            {success && (
                                <div className="flex items-center gap-2 text-sm text-emerald-400 rounded-xl px-4 py-3 mb-4" style={{ background: 'rgba(16,185,129,0.1)', border: '1px solid rgba(16,185,129,0.2)' }}>
                                    <i data-lucide="check-circle" className="w-4 h-4 shrink-0"></i> {success}
                                </div>
                            )}
                            {devOtp && (
                                <div className="flex items-center gap-2 text-sm text-amber-600 rounded-xl px-4 py-3 mb-4 font-mono" style={{ background: 'rgba(251,191,36,0.08)', border: '1px solid rgba(251,191,36,0.2)' }}>
                                    <i data-lucide="terminal" className="w-4 h-4 shrink-0"></i> {devOtp}
                                </div>
                            )}

                            <div className="space-y-3">
                                {/* 手机号 */}
                                <div className="relative">
                                    <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm font-bold">+86</span>
                                    <div className="absolute left-12 top-1/2 -translate-y-1/2 w-px h-4 bg-white/10"></div>
                                    <input type="tel" value={phone} onChange={e => setPhone(e.target.value.replace(/\D/g,'').slice(0,11))}
                                        className="login-input" style={{ paddingLeft: '3.5rem' }} placeholder="请输入手机号" maxLength={11}
                                        onKeyDown={e => e.key === 'Enter' && doAction()} />
                                </div>

                                {/* 验证码 */}
                                {(mode === 'sms' || mode === 'register') && (
                                    <div className="flex gap-2">
                                        <input type="text" inputMode="numeric" value={otp} onChange={e => setOtp(e.target.value.replace(/\D/g,'').slice(0,6))}
                                            className="login-input flex-1" placeholder="6位验证码" maxLength={6}
                                            onKeyDown={e => e.key === 'Enter' && doAction()} />
                                        <button onClick={sendOtp} disabled={countdown > 0}
                                            className={`px-4 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition-all shrink-0 ${countdown > 0 ? 'text-slate-600 cursor-not-allowed' : 'text-blue-400 hover:text-blue-300'}`}
                                            style={{ background: countdown > 0 ? 'rgba(255,255,255,0.03)' : 'rgba(59,130,246,0.12)', border: '1px solid ' + (countdown > 0 ? 'rgba(255,255,255,0.05)' : 'rgba(59,130,246,0.25)') }}>
                                            {countdown > 0 ? `${countdown}s` : '获取验证码'}
                                        </button>
                                    </div>
                                )}

                                {/* 密码 */}
                                {(mode === 'pwd' || mode === 'register') && (
                                    <div className="relative">
                                        <input type={showPwd ? 'text' : 'password'} value={password}
                                            onChange={e => setPassword(e.target.value)}
                                            className="login-input pr-12" placeholder={mode === 'register' ? '设置密码（至少6位）' : '请输入密码'}
                                            onKeyDown={e => e.key === 'Enter' && doAction()} />
                                        <button type="button" onClick={() => setShowPwd(v => !v)} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300 transition-colors">
                                            <i data-lucide={showPwd ? 'eye-off' : 'eye'} className="w-4 h-4"></i>
                                        </button>
                                    </div>
                                )}

                                {/* 确认密码 & 昵称 (register) */}
                                {mode === 'register' && (
                                    <>
                                        <input type={showPwd ? 'text' : 'password'} value={confirmPwd}
                                            onChange={e => setConfirmPwd(e.target.value)} className="login-input"
                                            placeholder="再次输入密码确认" onKeyDown={e => e.key === 'Enter' && doAction()} />
                                        <input type="text" value={nickname} onChange={e => setNickname(e.target.value)}
                                            className="login-input" placeholder="昵称（可选，最多10字）" maxLength={10} />
                                    </>
                                )}

                                {/* 记住我说明 / 忘记密码 */}
                                {mode !== 'register' && (
                                    <div className="flex items-center justify-between pt-1">
                                        <span className="text-xs text-slate-600 flex items-center gap-1.5">
                                            <i data-lucide="shield-check" className="w-3 h-3 text-emerald-600"></i>
                                            登录状态保持 30 天
                                        </span>
                                        {mode === 'pwd' && (
                                            <button onClick={() => { setMode('sms'); setError(''); setSuccess('请使用验证码验证身份后重置密码'); }} className="text-sm text-blue-400 hover:text-blue-300 transition-colors">
                                                忘记密码?
                                            </button>
                                        )}
                                    </div>
                                )}

                                {/* 主操作按钮 */}
                                <button onClick={doAction} disabled={loading}
                                    className="w-full py-4 rounded-2xl font-black text-base text-white transition-all mt-2"
                                    style={{
                                    background: 'linear-gradient(135deg, rgba(37,99,235,0.7), rgba(124,58,237,0.7))',
                                    boxShadow: '0 8px 24px rgba(99,102,241,0.05)',
                                    opacity: loading ? 0.7 : 1
                                    }}>
                                    {loading ? '处理中...' : mode === 'register' ? '立即注册' : '登录'}
                                </button>
                            </div>

                            {/* 分隔线 */}
                            <div className="flex items-center gap-3 my-5">
                                <div className="flex-1 h-px" style={{ background: 'rgba(255,255,255,0.06)' }}></div>
                                <span className="text-xs text-slate-600 font-bold">或使用第三方登录</span>
                                <div className="flex-1 h-px" style={{ background: 'rgba(255,255,255,0.06)' }}></div>
                            </div>

                            {/* 社交登录 */}
                            <div className="flex gap-2.5">
                                {[{ emoji: '💬', label: '微信' }, { emoji: '🍎', label: 'Apple' }, { emoji: '🔵', label: 'Google' }].map(s => (
                                    <button key={s.label} className="social-btn"
                                        onClick={() => setError('第三方登录演示暂不可用，请使用手机号登录')}>
                                        <span>{s.emoji}</span><span>{s.label}</span>
                                    </button>
                                ))}
                            </div>

                            <p className="text-center text-xs text-slate-600 mt-5">
                                登录即表示同意
                                <span className="text-blue-500 mx-1 cursor-pointer hover:text-blue-400">《用户协议》</span>
                                及
                                <span className="text-blue-500 mx-1 cursor-pointer hover:text-blue-400">《隐私政策》</span>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // ─────────────────── 个人中心组件 ───────────────────
        const ProfilePage = ({ user, onClose, onLogout, onUpdateUser, selectedLanguage, setSelectedLanguage }) => {
            const [section, setSection] = React.useState('overview');
            const [contracts, setContracts] = React.useState([]);
            const [favorites, setFavorites] = React.useState([]);
            const [contractsLoading, setContractsLoading] = React.useState(false);
            const [searchQ, setSearchQ] = React.useState('');
            const [selContract, setSelContract] = React.useState(null);
            const [editForm, setEditForm] = React.useState({ nickname: user.nickname || '', email: user.email || '', bio: user.bio || '' });
            const [notifState, setNotifState] = React.useState(user.notifications || { emailNotif: true, smsNotif: false, weeklyReport: true, riskAlert: true });
            const [changePwd, setChangePwd] = React.useState({ oldPwd: '', newPwd: '', confirmPwd: '' });
            const [msg, setMsg] = React.useState({ text: '', type: '' });
            const [showPwdPeek, setShowPwdPeek] = React.useState(false);
            const [deactivateConfirm, setDeactivateConfirm] = React.useState('');
            const [sortBy, setSortBy]         = React.useState('date-desc');
            const [filterRisk, setFilterRisk] = React.useState('all');
            const [selectedIds, setSelectedIds] = React.useState([]);
            const [batchMode, setBatchMode]   = React.useState(false);
            const [statsData, setStatsData]   = React.useState(null);
            const [statsLoading, setStatsLoading] = React.useState(false);
            const loadedRef = React.useRef(false);

            const flash = (text, type = 'ok') => { setMsg({ text, type }); setTimeout(() => setMsg({ text: '', type: '' }), 3500); };
            const [sysHealth, setSysHealth] = React.useState(null);
            const [cacheInfo, setCacheInfo] = React.useState(null);
            const [sysLoading, setSysLoading] = React.useState(false);


            // 2. 添加加载数据的函数
            const loadSystemConsole = async () => {
                setSysLoading(true);
                try {
                    const [hRes, cRes] = await Promise.all([
                        fetch(API_BASE_URL + '/health', { headers: { 'bypass-tunnel-reminder': 'true' } }),
                        fetch(API_BASE_URL + '/cache/stats', { headers: { 'bypass-tunnel-reminder': 'true' } })
                    ]);
                    if (hRes.ok) setSysHealth(await hRes.json());
                    if (cRes.ok) setCacheInfo(await cRes.json());
                } catch (e) {
                    flash('无法连接到监控服务', 'err');
                }
                setSysLoading(false);
            };

            // 3. 添加清理缓存的函数
            const clearSystemCache = async () => {
                if(!confirm('确定要清理系统分析缓存吗？这会导致相同合同需要重新耗费 Token 分析。')) return;
                try {
                    const res = await apiPost('/cache/clear', { older_than_hours: 0 });
                    if(res.ok) {
                        flash('缓存已清空 ✓');
                        loadSystemConsole();
                    }
                } catch { flash('清理失败', 'err'); }
            };

            React.useEffect(() => {
                if (section === 'console') loadSystemConsole();
            }, [section]);

            const loadData = async () => {
                if (loadedRef.current) return;
                loadedRef.current = true;
                setContractsLoading(true);
                try {
                    const [cRes, fRes] = await Promise.all([
                        apiGet('/auth/contracts'),
                        apiGet('/auth/favorites'),
                    ]);
                    if (cRes.ok) { 
                        const data = await cRes.json();
                        setContracts(data.contracts || []); // 提取出真正的数组部分
                    }
                    if (fRes.ok) {
                        const data = await fRes.json();
                        setFavorites(data.favorites || []); 
                    }
                } catch { flash('数据加载失败，请检查网络', 'err'); }
                setContractsLoading(false);
            };

            const loadStats = async () => {
                if (statsLoading) return;
                setStatsLoading(true);
                try {
                    const res = await apiGet('/auth/stats');
                    if (res.ok) setStatsData(await res.json());
                } catch { /* stats are optional */ }
                setStatsLoading(false);
            };

            React.useEffect(() => {
                loadData();
                loadStats();
                // ─── 新增：如果是管理员，进入主页也自动加载控制台数据 ───
                console.log("侧边栏检查角色:", user.role);
                if (user.role === 'admin' || user.role === 'Admin') {
                    baseNavItems.push({ key: 'console', icon: 'terminal', label: '系统控制台', badge: 'Admin' });
                }
            }, []);
            React.useEffect(() => { setTimeout(() => lucide.createIcons(), 80); }, [section, selContract]);

            const toggleFav = async (cid) => {
                const isFav = favorites.includes(cid);
                // 乐观更新
                setFavorites(prev => isFav ? prev.filter(id => id !== cid) : [...prev, cid]);
                try {
                    if (isFav) {
                        await apiDelete(`/auth/favorites/${cid}`);
                    } else {
                        const res = await apiPost(`/auth/favorites/${cid}`, {});
                        if (!res.ok) throw new Error();
                    }
                } catch {
                    setFavorites(prev => isFav ? [...prev, cid] : prev.filter(id => id !== cid));
                    flash('操作失败，请重试', 'err');
                }
            };

            const deleteContract = async (cid) => {
                if (!confirm('确定要删除此合同记录吗？删除后无法恢复。')) return;
                const res = await apiDelete(`/auth/contracts/${cid}`);
                if (res.ok) {
                    setContracts(cs => cs.filter(c => c.id !== cid));
                    setFavorites(f => f.filter(id => id !== cid));
                    if (selContract?.id === cid) setSelContract(null);
                    onUpdateUser({ ...user, review_count: Math.max(0, (user.review_count || 0) - 1) });
                    flash('已删除 ✓');
                } else { flash('删除失败', 'err'); }
            };

            const saveProfile = async () => {
                const res  = await apiPut('/auth/profile', editForm);
                const data = await res.json();
                if (res.ok) { onUpdateUser({ ...user, ...data }); flash('个人资料已保存 ✓'); }
                else flash(data.message || '保存失败', 'err');
            };

            const saveNotif = async () => {
                const res  = await apiPut('/auth/notifications', notifState);
                const data = await res.json();
                if (res.ok) flash('通知设置已保存 ✓');
                else flash(data.message || '保存失败', 'err');
            };

            const doChangePwd = async () => {
                if (changePwd.newPwd.length < 6) { flash('新密码至少 6 位字符', 'err'); return; }
                if (changePwd.newPwd !== changePwd.confirmPwd) { flash('两次密码不一致', 'err'); return; }
                const res  = await apiPut('/auth/change-password', {
                    old_password: changePwd.oldPwd || undefined,
                    new_password: changePwd.newPwd,
                });
                const data = await res.json();
                if (res.ok) {
                    setChangePwd({ oldPwd: '', newPwd: '', confirmPwd: '' });
                    flash('密码已更新 ✓');
                    onUpdateUser({ ...user, has_password: true });
                } else flash(data.message || '密码修改失败', 'err');
            };

            const doDeactivate = async () => {
                if (!confirm('确定要永久注销账号吗？所有数据将被删除且无法恢复。')) return;
                const res  = await apiDelete('/auth/account');
                const data = await res.json();
                if (res.ok) { alert('账号已永久注销。'); clearTokens(); onLogout(); }
                else flash(data.message || '注销失败', 'err');
            };

            const riskHex = (score) => score >= 80 ? '#ef4444' : score >= 60 ? '#f97316' : score >= 40 ? '#fbbf24' : '#10b981';

            const filtered = (Array.isArray(contracts) ? contracts : []).filter(c => {
                const q = searchQ.toLowerCase();
                    const matchQ = !q || (c.contract_type||'').toLowerCase().includes(q) ||
                        (c.category||'').toLowerCase().includes(q) ||
                        (c.summary||'').toLowerCase().includes(q);
                    const matchRisk = filterRisk === 'all' || (c.overall_risk||'').includes(filterRisk) ||
                        (filterRisk === '极高' && (c.risk_score >= 80)) ||
                        (filterRisk === '高'  && (c.risk_score >= 60 && c.risk_score < 80)) ||
                        (filterRisk === '中'  && (c.risk_score >= 40 && c.risk_score < 60)) ||
                        (filterRisk === '低'  && (c.risk_score < 40));
                    return matchQ && matchRisk;
                })
                .sort((a, b) => {
                    if (sortBy === 'date-desc') return new Date(b.created_at) - new Date(a.created_at);
                    if (sortBy === 'date-asc')  return new Date(a.created_at) - new Date(b.created_at);
                    if (sortBy === 'score-desc') return (b.risk_score||0) - (a.risk_score||0);
                    if (sortBy === 'score-asc')  return (a.risk_score||0) - (b.risk_score||0);
                    return 0;
                });
            const favContracts = contracts.filter(c => favorites.includes(c.id));
            const currentContracts = Array.isArray(contracts) ? contracts : (contracts.contracts || []);
            const totalRisks = currentContracts.reduce((s, c) => s + (Array.isArray(c.issues) ? c.issues.length : 0), 0);
            const avgScore = currentContracts.length 
                ? Math.round(currentContracts.reduce((s, c) => s + (Number(c.risk_score) || 0), 0) / currentContracts.length) 
                : 0;

            const toggleSelect = (cid) => {
                setSelectedIds(prev => prev.includes(cid) ? prev.filter(id => id !== cid) : [...prev, cid]);
            };
            const selectAll = () => setSelectedIds(filtered.map(c => c.id));
            const clearSelect = () => { setSelectedIds([]); setBatchMode(false); };

            const batchDelete = async () => {
                if (!selectedIds.length) return;
                if (!confirm(`确定要删除选中的 ${selectedIds.length} 条合同记录吗？此操作不可恢复。`)) return;
                try {
                    const res = await apiPost('/auth/contracts/batch-delete', { ids: selectedIds });
                    if (res.ok) {
                        const data = await res.json();
                        setContracts(cs => cs.filter(c => !selectedIds.includes(c.id)));
                        setFavorites(f => f.filter(id => !selectedIds.includes(id)));
                        onUpdateUser({ ...user, review_count: Math.max(0, (user.review_count||0) - selectedIds.length) });
                        clearSelect();
                        flash(`已删除 ${data.deleted} 条记录 ✓`);
                    } else { flash('批量删除失败', 'err'); }
                } catch { flash('网络错误，请重试', 'err'); }
            };

            const exportCSV = () => {
                const rows = [['合同类型','分类','风险分','风险等级','管辖地区','审查日期','风险条款数']];
                contracts.forEach(c => rows.push([
                    c.contract_type||'', c.category||'', c.risk_score||0, c.overall_risk||'',
                    c.jurisdiction||'', new Date(c.created_at).toLocaleDateString('zh-CN'),
                    (c.issues||[]).length
                ]));
                const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
                const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download=`合同档案_${Date.now()}.csv`; a.click();
                URL.revokeObjectURL(url);
            };

            const planInfo = { free: { label: '免费版', cls: 'plan-badge-free', quota: '每月 5 次审查' }, pro: { label: 'Pro 会员', cls: 'plan-badge-pro', quota: '无限次审查' }, team: { label: '团队版', cls: 'plan-badge-team', quota: '团队共享' } }[user.plan || 'free'];

            const baseNavItems = [
                { key: 'overview',  icon: 'layout-dashboard', label: '我的主页',   badge: null },
                { key: 'history',   icon: 'file-text',         label: '合同档案',   badge: contracts.length || null },
                { key: 'favorites', icon: 'star',               label: '我的收藏',   badge: favContracts.length || null },
                { key: 'notif',     icon: 'bell',               label: '通知设置',   badge: null },
            ];

            // 根据角色动态添加管理员功能
            if (user.role === 'admin') {
                baseNavItems.push({ key: 'console', icon: 'terminal', label: '系统控制台', badge: 'Admin' });
            }

            baseNavItems.push(
                { key: 'settings',  icon: 'user-cog',           label: '账号设置',   badge: null },
                { key: 'security',  icon: 'shield-check',       label: '安全中心',   badge: null }
            );

            const navItems = baseNavItems;

            const MsgBar = () => msg.text ? (
                <div className={`flex items-center gap-2 text-sm rounded-2xl px-5 py-3 mb-4 ${msg.type === 'err' ? 'text-red-400' : 'text-emerald-400'}`}
                    style={{ background: msg.type === 'err' ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)', border: '1px solid ' + (msg.type === 'err' ? 'rgba(239,68,68,0.25)' : 'rgba(16,185,129,0.25)') }}>
                    <i data-lucide={msg.type === 'err' ? 'alert-circle' : 'check-circle'} className="w-4 h-4 shrink-0"></i> {msg.text}
                </div>
            ) : null;

            const ToggleSwitch = ({ on, onToggle }) => (
                <div className={`toggle-track ${on ? 'on' : ''}`} onClick={onToggle}>
                    <div className="toggle-knob"></div>
                </div>
            );

            return (
                <div className="fixed inset-0 z-50 overflow-y-auto scrollbar-thin" style={{ background: '#f0f4f8' }}>
                    <div className="max-w-7xl mx-auto p-5 md:p-10 min-h-screen">

                        {/* ── 顶部导航栏 ── */}
                        <div className="flex items-center justify-between mb-8 animate-up">
                            <div className="flex items-center gap-4">
                                <button onClick={onClose} className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors font-bold text-sm group">
                                    <div className="w-8 h-8 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all group-hover:text-white border border-white/8">
                                        <i data-lucide="arrow-left" className="w-4 h-4"></i>
                                    </div>
                                    <span className="hidden md:inline">返回审查</span>
                                </button>
                                <span className="text-slate-700 hidden md:block">·</span>
                                <div className="hidden md:flex items-center gap-2">
                                    <div className="w-6 h-6 rounded-lg flex items-center justify-center" style={{background:'linear-gradient(135deg,#3b82f6,#8b5cf6)'}}>
                                        <i data-lucide="user" className="w-3.5 h-3.5 text-white"></i>
                                    </div>
                                    <h1 className="text-lg font-black text-white">个人中心</h1>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => { loadStats(); flash('数据已刷新 ✓'); }}
                                    className="w-9 h-9 rounded-xl flex items-center justify-center text-slate-500 hover:text-white hover:bg-white/5 transition-all"
                                    style={{ border: '1px solid rgba(255,255,255,0.07)' }}
                                    title="刷新数据">
                                    <i data-lucide="refresh-cw" className="w-4 h-4"></i>
                                </button>
                                <button onClick={onLogout}
                                    className="flex items-center gap-2 px-4 py-2 rounded-2xl text-slate-400 hover:text-red-400 text-sm font-bold transition-all"
                                    style={{ background: 'rgba(255,255,255,0.04)', border: '1px solid rgba(255,255,255,0.07)' }}>
                                    <i data-lucide="log-out" className="w-4 h-4"></i>
                                    <span className="hidden md:inline">退出登录</span>
                                </button>
                            </div>
                        </div>

                        <div className="grid lg:grid-cols-4 gap-6">

                            {/* ── 左侧边栏 ── */}
                            <div className="lg:col-span-1 space-y-4">
                                {/* 用户名片 */}
                                <div className="glass-card p-6 text-center animate-up">
                                    <div className="avatar-circle mx-auto mb-4" style={{ width: '72px', height: '72px', fontSize: '1.75rem' }}>
                                        {(user.nickname || user.phone || 'U')[0].toUpperCase()}
                                    </div>
                                    <div className="font-black text-white text-base leading-tight">{user.nickname || '未设置昵称'}</div>
                                    <div className="mt-3 flex flex-col items-center gap-2">
                                        <span className={`role-badge role-${user.role} px-4 py-1 text-[11px]`}>
                                            {user.role === 'admin' ? '🛡️ 系统管理员' : 
                                            user.role === 'legal_staff' ? '⚖️ 首席法务' : '👤 企业成员'}
                                        </span>
                                    </div>
                                    <div className="text-slate-500 text-xs mt-1">{user.phone?.slice(0,3)+'****'+user.phone?.slice(7)}</div>
                                    {user.bio && <div className="text-slate-400 text-xs mt-2 italic leading-relaxed">{user.bio}</div>}
                                    <div className="mt-3">
                                        <span className={`text-xs font-black px-3 py-1 ${planInfo.cls}`}>{planInfo.label}</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2 mt-4 pt-4" style={{ borderTop: '1px solid rgba(255,255,255,0.06)' }}>
                                        <div className="text-center">
                                            <div className="text-xl font-black text-blue-400">{contracts.length}</div>
                                            <div className="text-[10px] text-slate-500">合同档案</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-xl font-black text-amber-400">{favContracts.length}</div>
                                            <div className="text-[10px] text-slate-500">收藏数量</div>
                                        </div>
                                    </div>
                                </div>

                                {/* 导航菜单 */}
                                <div className="glass-card p-3 space-y-0.5 animate-up">
                                    {navItems.map(item => (
                                        <button key={item.key}
                                            onClick={() => { setSection(item.key); setSelContract(null); setSearchQ(''); setFilterRisk('all'); setBatchMode(false); clearSelect(); flash('', ''); }}
                                            className={`profile-nav-btn ${section === item.key ? 'active' : ''}`}>
                                            <i data-lucide={item.icon} className="w-4 h-4 shrink-0"></i>
                                            <span className="flex-1">{item.label}</span>
                                            {item.badge ? (
                                                <span className="text-[10px] font-black px-2 py-0.5 rounded-full"
                                                    style={{ background: section === item.key ? 'rgba(129,140,248,0.3)' : 'rgba(99,102,241,0.15)', color: '#818cf8' }}>
                                                    {item.badge}
                                                </span>
                                            ) : null}
                                        </button>
                                    ))}
                                </div>

                                {/* 快捷键提示 */}
                                <div className="glass-card p-4 text-center hidden lg:block">
                                    <div className="text-[10px] text-slate-600 font-bold uppercase tracking-widest mb-2">快捷键</div>
                                    <div className="space-y-1.5">
                                        <div className="flex items-center justify-between text-[10px] text-slate-600">
                                            <span>关闭页面</span><span className="kbd">Esc</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* ── 右侧主内容区 ── */}
                            <div className="lg:col-span-3 animate-up">

                                {/* ────────── 我的主页 ────────── */}
                                {section === 'overview' && (
                                    <div className="space-y-6 page-title-in">
                                        {/* 欢迎行 */}
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className="avatar-circle avatar-glow" style={{ width: '44px', height: '44px', fontSize: '1.1rem', flexShrink: 0 }}>
                                                    {(user.nickname || 'U')[0].toUpperCase()}
                                                </div>
                                                <div>
                                                    <h2 className="text-xl font-black text-white">你好，{user.nickname || '用户'} 👋</h2>
                                                    <p className="text-slate-500 text-xs">{new Date().toLocaleDateString('zh-CN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                </div>
                                            </div>
                                            <button onClick={exportCSV} data-tooltip="导出 CSV"
                                                className="flex items-center gap-1.5 px-4 py-2 rounded-xl text-slate-400 text-xs font-bold transition-all hover:text-white hover:bg-white/5"
                                                style={{ border: '1px solid rgba(255,255,255,0.08)' }}>
                                                <i data-lucide="download" className="w-3.5 h-3.5"></i>
                                                <span className="hidden md:inline">导出档案</span>
                                            </button>
                                        </div>

                                        {/* ─── 新增：管理员专属实时监控条 ─── */}
                                        {user.role === 'admin' && sysHealth && (
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 animate-fade">
                                                <div className="p-4 rounded-2xl bg-indigo-500/5 border border-indigo-500/20 flex items-center gap-4">
                                                    <div className="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center">
                                                        <i data-lucide="activity" className="w-5 h-5 text-indigo-400"></i>
                                                    </div>
                                                    <div>
                                                        <div className="text-[10px] text-slate-500 font-black uppercase">引擎负载</div>
                                                        <div className="text-sm font-bold text-white">{sysHealth.active_tasks} 个活动任务</div>
                                                    </div>
                                                </div>
                                                <div className="p-4 rounded-2xl bg-emerald-500/5 border border-emerald-500/20 flex items-center gap-4">
                                                    <div className="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center">
                                                        <i data-lucide="database" className="w-5 h-5 text-emerald-400"></i>
                                                    </div>
                                                    <div>
                                                        <div className="text-[10px] text-slate-500 font-black uppercase">缓存效率</div>
                                                        <div className="text-sm font-bold text-white">{cacheInfo?.total_hits || 0} 次节省</div>
                                                    </div>
                                                </div>
                                                <div className="p-4 rounded-2xl bg-amber-500/5 border border-amber-500/20 flex items-center gap-4 cursor-pointer hover:bg-amber-500/10 transition-all"
                                                    onClick={() => setSection('console')}>
                                                    <div className="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center">
                                                        <i data-lucide="shield-check" className="w-5 h-5 text-amber-400"></i>
                                                    </div>
                                                    <div>
                                                        <div className="text-[10px] text-slate-500 font-black uppercase">安全策略</div>
                                                        <div className="text-sm font-bold text-white">RBAC 4级角色已启用</div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* 四格统计卡 */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            {[
                                                { label: '审查合同', value: contracts.length, sub: '份', icon: 'file-check', color: '#3b82f6', trend: contracts.length > 0 ? '↑' : '─' },
                                                { label: '发现风险', value: totalRisks, sub: '处', icon: 'alert-triangle', color: '#f97316', trend: totalRisks > 0 ? '⚠' : '─' },
                                                { label: '平均风险分', value: avgScore || '--', sub: '/100', icon: 'activity', color: riskHex(avgScore), trend: avgScore >= 60 ? '↑' : avgScore > 0 ? '─' : '─' },
                                                { label: '我的收藏', value: favContracts.length, sub: '份', icon: 'star', color: '#f59e0b', trend: favContracts.length > 0 ? '★' : '─' },
                                            ].map((s, i) => (
                                                <div key={i} className="stat-card">
                                                    <div className="w-10 h-10 rounded-2xl flex items-center justify-center mx-auto mb-3" style={{ background: s.color + '18' }}>
                                                        <i data-lucide={s.icon} className="w-5 h-5" style={{ color: s.color }}></i>
                                                    </div>
                                                    <div className="text-3xl font-black count-animate" style={{ color: s.color }}>{s.value}</div>
                                                    <div className="text-[11px] text-slate-500 mt-1">{s.sub} · {s.label}</div>
                                                    <div className={`text-xs mt-1.5 font-black ${avgScore >= 60 && s.label === '平均风险分' ? 'stat-trend-down' : 'stat-trend-flat'}`}>{s.trend}</div>
                                                </div>
                                            ))}
                                        </div>

                                        {/* 月度活动图 + 风险分布 */}
                                        <div className="grid md:grid-cols-2 gap-5">
                                            {/* 月度活动柱状图 */}
                                            <div className="glass-card p-6">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">近 6 个月审查趋势</h3>
                                                    {statsLoading && <div className="w-3 h-3 rounded-full bg-blue-500 animate-pulse"></div>}
                                                </div>
                                                {statsData?.monthly_reviews?.length > 0 ? (() => {
                                                    const months = statsData.monthly_reviews;
                                                    const maxCnt = Math.max(...months.map(m => m.count), 1);
                                                    return (
                                                        <div>
                                                            <div className="activity-chart">
                                                                {months.map((m, i) => (
                                                                    <div key={i} className="flex flex-col items-center gap-1 flex-1">
                                                                        <div className="text-[9px] text-slate-600 font-bold">{m.count}</div>
                                                                        <div className="w-full flex items-end" style={{height:'44px'}}>
                                                                            <div className="activity-chart-bar chart-bar-col w-full rounded-t"
                                                                                style={{
                                                                                    height: `${Math.max(8, (m.count/maxCnt)*44)}px`,
                                                                                    background: `linear-gradient(to top, #3b82f6, #8b5cf6)`,
                                                                                    animationDelay: `${i*0.08}s`
                                                                                }}
                                                                                title={`${m.month}: ${m.count} 份`}
                                                                            ></div>
                                                                        </div>
                                                                        <div className="text-[9px] text-slate-600">{m.month.slice(5)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                            <div className="text-center text-xs text-slate-600 mt-3">总计 {months.reduce((s,m)=>s+m.count,0)} 份</div>
                                                        </div>
                                                    );
                                                })() : (
                                                    <div className="activity-chart items-end justify-center gap-1.5">
                                                        {[3,5,2,7,4,6].map((h,i) => (
                                                            <div key={i} className="flex-1 rounded-t opacity-10 chart-bar-col"
                                                                style={{ height: `${h*6}px`, background: 'linear-gradient(to top,#3b82f6,#8b5cf6)', animationDelay:`${i*0.08}s` }}></div>
                                                        ))}
                                                    </div>
                                                )}
                                                {!statsData && !statsLoading && (
                                                    <p className="text-xs text-center text-slate-600 mt-2">开始审查合同后，趋势数据将显示在这里</p>
                                                )}
                                            </div>

                                            {/* 风险分布 */}
                                            <div className="glass-card p-6">
                                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">风险等级分布</h3>
                                                {(() => {
                                                    const levels = [
                                                        { key: '极高', color: '#ef4444', label: '极高风险' },
                                                        { key: '高',   color: '#f97316', label: '高风险'   },
                                                        { key: '中',   color: '#fbbf24', label: '中等风险' },
                                                        { key: '低',   color: '#10b981', label: '低风险'   },
                                                    ];
                                                    const counts = {};
                                                    contracts.forEach(c => {
                                                        const r = c.overall_risk||'';
                                                        if (r.includes('极高'))    counts['极高'] = (counts['极高']||0)+1;
                                                        else if (r.includes('高')) counts['高'] = (counts['高']||0)+1;
                                                        else if (r.includes('中')) counts['中'] = (counts['中']||0)+1;
                                                        else if (r.includes('低')) counts['低'] = (counts['低']||0)+1;
                                                    });
                                                    const total = contracts.length || 1;
                                                    if (contracts.length === 0) return (
                                                        <div className="flex flex-col gap-2 justify-center" style={{height:'80px'}}>
                                                            {levels.map(lv => (
                                                                <div key={lv.key} className="flex items-center gap-2">
                                                                    <div className="w-2 h-2 rounded-full shrink-0" style={{background:lv.color,opacity:0.3}}></div>
                                                                    <div className="flex-1 h-1.5 bg-white/5 rounded-full"><div className="h-full w-0 rounded-full" style={{background:lv.color}}></div></div>
                                                                    <span className="text-[10px] text-slate-600 w-4">0</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    );
                                                    return (
                                                        <div className="flex flex-col gap-3">
                                                            {levels.map(lv => {
                                                                const cnt = counts[lv.key] || 0;
                                                                const pct = Math.round((cnt/total)*100);
                                                                return (
                                                                    <div key={lv.key} className="flex items-center gap-2">
                                                                        <div className="w-2 h-2 rounded-full shrink-0" style={{background:lv.color}}></div>
                                                                        <span className="text-[10px] font-bold text-slate-500 w-10 shrink-0">{lv.key}</span>
                                                                        <div className="flex-1 h-1.5 bg-white/5 rounded-full overflow-hidden">
                                                                            <div className="h-full rounded-full cat-progress-bar" style={{width:`${pct}%`,background:lv.color}}></div>
                                                                        </div>
                                                                        <span className="text-[10px] font-black text-slate-400 w-5 text-right">{cnt}</span>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    );
                                                })()}
                                            </div>
                                        </div>

                                        {/* 分类分析 */}
                                        {statsData?.by_category?.length > 0 && (
                                            <div className="glass-card p-6">
                                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">合同类型分析</h3>
                                                <div className="space-y-3">
                                                    {statsData.by_category.map((cat, i) => (
                                                        <div key={i} className="flex items-center gap-3">
                                                            <span className="text-sm text-slate-300 font-bold w-24 shrink-0 truncate">{cat.category}</span>
                                                            <div className="flex-1 h-2 bg-white/5 rounded-full overflow-hidden">
                                                                <div className="h-full rounded-full cat-progress-bar"
                                                                    style={{
                                                                        width: `${Math.min((cat.avg_score/100)*100,100)}%`,
                                                                        background: `linear-gradient(90deg, ${cat.avg_score>=80?'#ef4444':cat.avg_score>=60?'#f97316':cat.avg_score>=40?'#fbbf24':'#10b981'}, ${cat.avg_score>=60?'#dc2626':'#059669'})`
                                                                    }}
                                                                ></div>
                                                            </div>
                                                            <span className="text-xs font-black w-8 text-right shrink-0" style={{color: cat.avg_score>=80?'#ef4444':cat.avg_score>=60?'#f97316':cat.avg_score>=40?'#fbbf24':'#10b981'}}>{cat.avg_score}</span>
                                                            <span className="text-[10px] text-slate-600 w-8 text-right shrink-0">{cat.count}份</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* 会员升级卡 */}
                                        <div className="glass-card p-7 relative overflow-hidden" style={{ background: 'linear-gradient(135deg, rgba(59,130,246,0.07), rgba(139,92,246,0.07))' }}>
                                            <div className="absolute -top-16 -right-16 w-48 h-48 rounded-full opacity-10" style={{ background: 'radial-gradient(circle, #a78bfa, transparent)' }}></div>
                                            <div className="flex flex-col md:flex-row items-start md:items-center gap-5">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <span className={`text-xs font-black px-3 py-1 ${planInfo.cls}`}>{planInfo.label}</span>
                                                        <span className="text-slate-500 text-sm">{planInfo.quota}</span>
                                                    </div>
                                                    <h3 className="text-lg font-black text-white mb-1">升级 Pro 会员，解锁无限审查</h3>
                                                    <p className="text-slate-400 text-sm">• 优先处理队列 &nbsp;• 更深度 AI 分析 &nbsp;• 专属法律模板库 &nbsp;• 历史对比功能</p>
                                                </div>
                                                <button className="px-7 py-3 rounded-2xl font-black text-sm text-white transition-all shrink-0 hover:scale-105"
                                                    style={{ background: 'linear-gradient(135deg, #f59e0b, #ef4444)', boxShadow: '0 8px 24px rgba(245,158,11,0.35)' }}>
                                                    立即升级 →
                                                </button>
                                            </div>
                                        </div>

                                        {/* 最近审查 */}
                                        <div>
                                            <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                                <i data-lucide="clock" className="w-4 h-4 text-blue-400"></i> 最近审查记录
                                            </h3>
                                            {contractsLoading ? (
                                                <div className="space-y-3">
                                                    {[1,2,3].map(i => (
                                                        <div key={i} className="history-card">
                                                            <div className="skeleton-block w-10 h-10 rounded-2xl shrink-0"></div>
                                                            <div className="flex-1 space-y-2">
                                                                <div className="skeleton-block h-3.5 w-3/4"></div>
                                                                <div className="skeleton-block h-2.5 w-1/2"></div>
                                                            </div>
                                                            <div className="skeleton-block h-6 w-8 rounded-lg shrink-0"></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : contracts.length > 0 ? (
                                                <div className="space-y-3">
                                                    {contracts.slice(0, 4).map(c => (
                                                        <div key={c.id} className="history-card cursor-pointer" onClick={() => { setSection('history'); setSelContract(c); }}>
                                                            <div className="w-10 h-10 rounded-2xl flex items-center justify-center shrink-0" style={{ background: riskHex(c.risk_score) + '18' }}>
                                                                <i data-lucide="file-text" className="w-5 h-5" style={{ color: riskHex(c.risk_score) }}></i>
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <div className="font-bold text-sm text-white truncate">
                                                                    {c.contract_type || c.contractType || '未知合同'}
                                                                </div>
                                                                <div className="text-xs text-slate-500 mt-0.5 flex items-center gap-1.5">
                                                                    <span className="cat-tag">{c.category}</span>
                                                                    <span>{new Date(c.created_at).toLocaleDateString('zh-CN')}</span>
                                                                </div>
                                                            </div>
                                                            <div className="text-right shrink-0">
                                                                <div className="text-lg font-black" style={{ color: riskHex(c.risk_score) }}>{c.risk_score}</div>
                                                                <div className="text-[10px] text-slate-600">风险分</div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {contracts.length > 4 && (
                                                        <button onClick={() => setSection('history')} className="text-sm text-blue-400 hover:text-blue-300 font-bold transition-colors ml-2">
                                                            查看全部 {contracts.length} 份 →
                                                        </button>
                                                    )}
                                                </div>
                                            ) : (
                                                <div className="glass-card p-10 text-center">
                                                    <div className="empty-illus">📄</div>
                                                    <p className="text-slate-400 font-bold mb-1">还没有审查记录</p>
                                                    <p className="text-slate-600 text-xs">完成合同审查后，记录会自动保存在这里</p>
                                                    <button onClick={onClose} className="mt-4 px-6 py-2.5 text-blue-400 rounded-full text-sm font-bold transition-colors hover:text-blue-300" style={{ background: 'rgba(59,130,246,0.1)', border: '1px solid rgba(59,130,246,0.2)' }}>
                                                        开始审查首份合同
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                        <div className="glass-card p-5 flex flex-wrap items-center gap-4 text-xs text-slate-600">
                                            <span className="flex items-center gap-1.5"><i data-lucide="calendar" className="w-3 h-3 text-slate-500"></i> 加入于 {new Date(user.join_date || Date.now()).toLocaleDateString('zh-CN', { year:'numeric', month:'long', day:'numeric' })}</span>
                                            <span className="flex items-center gap-1.5"><i data-lucide="mail" className="w-3 h-3 text-slate-500"></i> {user.email || '未绑定邮箱'}</span>
                                            <span className="flex items-center gap-1.5"><i data-lucide="globe" className="w-3 h-3 text-slate-500"></i> {LANGUAGES.find(l => l.code === selectedLanguage)?.label || '简体中文'}</span>
                                            <span className="ml-auto text-[10px] text-slate-700 flex items-center gap-1">
                                                <span className="kbd">Esc</span> 关闭
                                            </span>
                                        </div>
                                    </div>
                                )}

                                {/* ────────── 合同档案 ────────── */}
                                {section === 'history' && (
                                    <div className="space-y-4 page-title-in">
                                        {/* 标题行 */}
                                        <div className="flex items-center justify-between flex-wrap gap-3">
                                            <h2 className="text-2xl font-black text-white flex items-center gap-2">
                                                合同档案
                                                <span className="text-base font-bold text-slate-500">{contracts.length} 份</span>
                                            </h2>
                                            <div className="flex items-center gap-2">
                                                <button onClick={exportCSV}
                                                    className="flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-slate-400 text-xs font-bold transition-all hover:text-white hover:bg-white/5"
                                                    style={{ border: '1px solid rgba(255,255,255,0.07)' }}>
                                                    <i data-lucide="download" className="w-3.5 h-3.5"></i> 导出 CSV
                                                </button>
                                                <button onClick={() => { setBatchMode(!batchMode); if (batchMode) clearSelect(); }}
                                                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-xs font-bold transition-all ${batchMode ? 'text-indigo-300 bg-indigo-500/15 border-indigo-500/30' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}
                                                    style={{ border: '1px solid rgba(255,255,255,0.07)' }}>
                                                    <i data-lucide={batchMode ? 'check-square' : 'square'} className="w-3.5 h-3.5"></i>
                                                    {batchMode ? '退出选择' : '批量选择'}
                                                </button>
                                            </div>
                                        </div>

                                        {selContract ? (
                                            <div className="space-y-4 animate-up">
                                                <button onClick={() => setSelContract(null)} className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm font-bold">
                                                    <i data-lucide="arrow-left" className="w-4 h-4"></i> 返回列表
                                                </button>
                                                <div className="glass-card p-8">
                                                    <div className="flex items-start gap-4 mb-6">
                                                        <div className="w-14 h-14 rounded-2xl flex items-center justify-center shrink-0" style={{ background: riskHex(selContract.risk_score) + '18' }}>
                                                            <i data-lucide="file-text" className="w-7 h-7" style={{ color: riskHex(selContract.risk_score) }}></i>
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <h3 className="text-xl font-black text-white leading-tight">{selContract.contract_type}</h3>
                                                            <div className="flex flex-wrap items-center gap-2 mt-2">
                                                                <span className="cat-tag">{selContract.category}</span>
                                                                <span className="text-xs text-slate-500">{new Date(selContract.created_at).toLocaleString('zh-CN')}</span>
                                                                <span className="text-xs font-black px-2.5 py-0.5 rounded-full" style={{ color: riskHex(selContract.risk_score), background: riskHex(selContract.risk_score)+'18' }}>
                                                                    ⚡ 风险分 {selContract.risk_score}/100
                                                                </span>
                                                                {selContract.jurisdiction && <span className="text-xs text-slate-500">📍 {selContract.jurisdiction}</span>}
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2 shrink-0">
                                                            <button onClick={() => toggleFav(selContract.id)} className={`w-9 h-9 rounded-xl flex items-center justify-center transition-all ${favorites.includes(selContract.id) ? 'text-amber-400 bg-amber-500/15' : 'text-slate-500 hover:text-amber-400 hover:bg-amber-500/10'}`}>
                                                                <i data-lucide="star" className="w-4 h-4"></i>
                                                            </button>
                                                            <button onClick={() => deleteContract(selContract.id)} className="w-9 h-9 rounded-xl flex items-center justify-center text-slate-500 hover:text-red-400 hover:bg-red-500/10 transition-all">
                                                                <i data-lucide="trash-2" className="w-4 h-4"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    {selContract.summary && (
                                                        <div className="p-5 rounded-2xl italic text-slate-300 text-sm leading-relaxed mb-6" style={{ background: 'rgba(255,255,255,0.03)', border: '1px solid rgba(255,255,255,0.06)' }}>
                                                            "{selContract.summary}"
                                                        </div>
                                                    )}
                                                    <h4 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-3">识别的风险条款</h4>
                                                    {(selContract.issues || []).length > 0 ? (
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            {(selContract.issues || []).map((iss, i) => (
                                                                <div key={i} className="p-4 rounded-2xl" style={{ background: 'rgba(255,255,255,0.025)', border: '1px solid rgba(255,255,255,0.06)' }}>
                                                                    <span className="risk-pill mb-2 inline-flex" style={{ color: iss.severity?.includes('高') || iss.severity?.toLowerCase().includes('high') ? (iss.severity?.includes('极') ? '#ef4444' : '#f97316') : iss.severity?.includes('中') || iss.severity?.toLowerCase() === 'medium' ? '#fbbf24' : '#10b981', background: iss.severity?.includes('极') ? 'rgba(239,68,68,0.15)' : iss.severity?.includes('高') ? 'rgba(249,115,22,0.15)' : iss.severity?.includes('中') ? 'rgba(251,191,36,0.15)' : 'rgba(16,185,129,0.15)' }}>
                                                                        {iss.severity}
                                                                    </span>
                                                                    <div className="text-sm text-slate-300 font-bold leading-snug">{iss.title}</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : <p className="text-slate-500 text-sm">暂无风险条款记录</p>}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {/* 搜索 + 筛选 + 排序栏 */}
                                                <div className="space-y-3">
                                                    <div className="relative">
                                                        <i data-lucide="search" className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                                                        <input type="text" value={searchQ} onChange={e => setSearchQ(e.target.value)}
                                                            className="login-input" style={{ paddingLeft: '2.75rem' }}
                                                            placeholder="搜索合同类型、分类、摘要..." />
                                                        {searchQ && (
                                                            <button onClick={() => setSearchQ('')} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white">
                                                                <i data-lucide="x" className="w-4 h-4"></i>
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div className="flex flex-wrap items-center gap-2">
                                                        <span className="text-xs text-slate-600 font-bold mr-1">风险:</span>
                                                        {[['all','全部'],['极高','极高'],['高','高'],['中','中'],['低','低']].map(([v,l]) => (
                                                            <button key={v} onClick={() => setFilterRisk(v)}
                                                                className={`filter-pill ${filterRisk===v?'active':''} ${v==='极高'&&filterRisk===v?'danger':''}`}>
                                                                {l}
                                                            </button>
                                                        ))}
                                                        <div className="ml-auto flex items-center gap-2">
                                                            <span className="text-xs text-slate-600 font-bold">排序:</span>
                                                            <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="lang-selector" style={{paddingRight:'1.75rem',fontSize:'0.72rem'}}>
                                                                <option value="date-desc">最新优先</option>
                                                                <option value="date-asc">最旧优先</option>
                                                                <option value="score-desc">风险最高</option>
                                                                <option value="score-asc">风险最低</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* 批量操作栏 */}
                                                {batchMode && selectedIds.length > 0 && (
                                                    <div className="batch-action-bar">
                                                        <span className="text-sm font-black text-indigo-300">已选 {selectedIds.length} 份</span>
                                                        <button onClick={selectAll} className="text-xs font-bold text-slate-400 hover:text-white transition-colors">全选 ({filtered.length})</button>
                                                        <div className="ml-auto flex items-center gap-2">
                                                            <button onClick={clearSelect} className="px-3 py-1.5 rounded-lg text-xs font-bold text-slate-400 hover:bg-white/5 transition-all">取消</button>
                                                            <button onClick={batchDelete}
                                                                className="flex items-center gap-1.5 px-4 py-1.5 rounded-xl text-xs font-black text-white transition-all"
                                                                style={{ background: 'linear-gradient(135deg,#ef4444,#dc2626)', boxShadow: '0 4px 14px rgba(239,68,68,0.3)' }}>
                                                                <i data-lucide="trash-2" className="w-3.5 h-3.5"></i> 删除选中
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                                {batchMode && selectedIds.length === 0 && (
                                                    <div className="batch-action-bar">
                                                        <span className="text-xs text-slate-500">点击合同卡片左侧圆圈进行选择</span>
                                                        <button onClick={() => selectAll()} className="text-xs font-bold text-blue-400 hover:text-blue-300 ml-auto">全选</button>
                                                    </div>
                                                )}

                                                {contractsLoading ? (
                                                    <div className="space-y-3">
                                                        {[1,2,3,4].map(i => (
                                                            <div key={i} className="history-card">
                                                                <div className="skeleton-block w-10 h-10 rounded-2xl shrink-0"></div>
                                                                <div className="flex-1 space-y-2">
                                                                    <div className="skeleton-block h-3.5 w-3/4"></div>
                                                                    <div className="skeleton-block h-2.5 w-1/2"></div>
                                                                </div>
                                                                <div className="skeleton-block h-7 w-10 rounded-lg shrink-0"></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : filtered.length > 0 ? (
                                                    <div className="space-y-3">
                                                        {filtered.map(c => (
                                                            <div key={c.id} className={`history-card ${selectedIds.includes(c.id) ? 'selected' : ''}`}>
                                                                {batchMode && (
                                                                    <div className={`contract-cb ${selectedIds.includes(c.id) ? 'on' : ''}`}
                                                                        onClick={() => toggleSelect(c.id)}>
                                                                        {selectedIds.includes(c.id) && '✓'}
                                                                    </div>
                                                                )}
                                                                <div className="w-10 h-10 rounded-2xl flex items-center justify-center shrink-0" style={{ background: riskHex(c.risk_score) + '18' }}>
                                                                    <i data-lucide="file-text" className="w-4 h-4" style={{ color: riskHex(c.risk_score) }}></i>
                                                                </div>
                                                                <div className="flex-1 min-w-0 cursor-pointer" onClick={() => !batchMode && setSelContract(c)}>
                                                                    <div className="font-bold text-sm text-white truncate">{c.contract_type || '未知合同'}</div>
                                                                    <div className="text-xs text-slate-500 mt-0.5 flex items-center gap-1.5 flex-wrap">
                                                                        <span className="cat-tag">{c.category}</span>
                                                                        <span>{new Date(c.created_at).toLocaleDateString('zh-CN')}</span>
                                                                        <span>· {c.issues?.length || 0} 处风险</span>
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-2 shrink-0">
                                                                    <div className="text-right">
                                                                        <div className="text-base font-black" style={{ color: riskHex(c.risk_score) }}>{c.risk_score}</div>
                                                                        <div className="text-[10px] text-slate-600">分</div>
                                                                    </div>
                                                                    {!batchMode && (
                                                                        <>
                                                                            <button onClick={() => toggleFav(c.id)} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${favorites.includes(c.id) ? 'text-amber-400' : 'text-slate-600 hover:text-amber-400'}`}>
                                                                                <i data-lucide="star" className="w-3.5 h-3.5"></i>
                                                                            </button>
                                                                            <button onClick={() => deleteContract(c.id)} className="w-8 h-8 rounded-full flex items-center justify-center text-slate-600 hover:text-red-400 transition-all">
                                                                                <i data-lucide="trash-2" className="w-3.5 h-3.5"></i>
                                                                            </button>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="glass-card p-12 text-center">
                                                        <div className="empty-illus">{searchQ || filterRisk !== 'all' ? '🔍' : '📂'}</div>
                                                        <p className="text-slate-400 font-bold">{searchQ || filterRisk !== 'all' ? '未找到匹配结果' : '还没有合同记录'}</p>
                                                        <p className="text-slate-600 text-xs mt-1">{searchQ ? `关键词 "${searchQ}" 无匹配` : filterRisk !== 'all' ? '尝试调整风险筛选条件' : ''}</p>
                                                        {!searchQ && filterRisk === 'all' && <button onClick={onClose} className="mt-4 px-6 py-2.5 text-blue-400 rounded-full text-sm font-bold hover:text-blue-300 transition-colors" style={{ background: 'rgba(59,130,246,0.1)', border: '1px solid rgba(59,130,246,0.2)' }}>审查首份合同 →</button>}
                                                        {(searchQ || filterRisk !== 'all') && (
                                                            <button onClick={() => { setSearchQ(''); setFilterRisk('all'); }} className="mt-3 text-xs text-slate-500 hover:text-white transition-colors">清除筛选条件</button>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* ────────── 我的收藏 ────────── */}
                                {section === 'favorites' && (
                                    <div className="space-y-4">
                                        <h2 className="text-2xl font-black text-white">我的收藏</h2>
                                        {favContracts.length > 0 ? (
                                            <div className="space-y-3">
                                                {favContracts.map(c => (
                                                    <div key={c.id} className="history-card">
                                                        <div className="w-10 h-10 rounded-2xl flex items-center justify-center shrink-0" style={{ background: '#f59e0b18' }}>
                                                            <i data-lucide="star" className="w-5 h-5 text-amber-400"></i>
                                                        </div>
                                                        <div className="flex-1 min-w-0 cursor-pointer" onClick={() => { setSection('history'); setSelContract(c); }}>
                                                            <div className="font-bold text-sm text-white truncate">{c.contract_type || '未知合同'}</div>
                                                            <div className="text-xs text-slate-500 mt-0.5">{c.category} · {new Date(c.created_at).toLocaleDateString('zh-CN')}</div>
                                                        </div>
                                                        <div className="font-black text-base shrink-0" style={{ color: riskHex(c.risk_score) }}>{c.risk_score} 分</div>
                                                        <button onClick={() => toggleFav(c.id)} className="w-8 h-8 rounded-full flex items-center justify-center text-amber-400 hover:text-slate-500 transition-all" title="取消收藏">
                                                            <i data-lucide="star-off" className="w-3.5 h-3.5"></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="glass-card p-12 text-center">
                                                <div className="text-5xl mb-4">⭐</div>
                                                <p className="text-slate-400 font-bold">暂无收藏</p>
                                                <p className="text-slate-600 text-sm mt-1">在合同档案中点击 ⭐ 即可收藏</p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* ────────── 通知设置 ────────── */}
                                {section === 'notif' && (
                                    <div className="space-y-5">
                                        <h2 className="text-2xl font-black text-white">通知设置</h2>
                                        <MsgBar />
                                        <div className="glass-card p-8 space-y-1">
                                            {[
                                                { key: 'emailNotif',    icon: 'mail',           label: '邮件通知',   desc: '合同分析完成后发送邮件提醒' },
                                                { key: 'smsNotif',     icon: 'message-square', label: '短信通知',   desc: '发现极高风险条款时发送短信' },
                                                { key: 'weeklyReport', icon: 'bar-chart-2',    label: '每周报告',   desc: '每周发送合同审查汇总报告' },
                                                { key: 'riskAlert',    icon: 'alert-triangle', label: '风险预警',   desc: '风险分超过 80 分立即推送通知' },
                                            ].map((item, i, arr) => (
                                                <div key={item.key} className={`flex items-center justify-between py-5 ${i < arr.length-1 ? 'border-b' : ''}`} style={{ borderColor: 'rgba(255,255,255,0.05)' }}>
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-9 h-9 rounded-xl flex items-center justify-center shrink-0" style={{ background: 'rgba(99,102,241,0.12)' }}>
                                                            <i data-lucide={item.icon} className="w-4 h-4 text-indigo-400"></i>
                                                        </div>
                                                        <div>
                                                            <div className="font-bold text-white text-sm">{item.label}</div>
                                                            <div className="text-xs text-slate-500 mt-0.5">{item.desc}</div>
                                                        </div>
                                                    </div>
                                                    <ToggleSwitch on={notifState[item.key]} onToggle={() => setNotifState(p => ({ ...p, [item.key]: !p[item.key] }))} />
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={saveNotif} className="px-8 py-3 rounded-2xl font-black text-sm text-white transition-all hover:opacity-90" style={{ background: 'linear-gradient(135deg, rgba(37,99,235,0.8), rgba(124,58,237,0.8))', boxShadow: '0 8px 20px rgba(99,102,241,0.3)' }}>
                                            保存通知设置
                                        </button>
                                    </div>
                                )}

                                {/* ────────── 账号设置 ────────── */}
                                {section === 'settings' && (
                                    <div className="space-y-5">
                                        <h2 className="text-2xl font-black text-white">账号设置</h2>
                                        <MsgBar />
                                        <div className="glass-card p-8 space-y-6">
                                            <div className="flex items-center gap-5 pb-6" style={{ borderBottom: '1px solid rgba(255,255,255,0.06)' }}>
                                                <div className="avatar-circle" style={{ width: '80px', height: '80px', fontSize: '2rem', flexShrink: 0 }}>
                                                    {(editForm.nickname || user.phone || 'U')[0].toUpperCase()}
                                                </div>
                                                <div>
                                                    <div className="font-black text-white text-lg">{editForm.nickname || user.phone}</div>
                                                    <div className="text-slate-500 text-sm mt-1">手机号：{user.phone}</div>
                                                    <div className="text-slate-600 text-xs mt-1">UID：{user.id?.slice(0, 8)?.toUpperCase()}</div>
                                                </div>
                                            </div>
                                            <div className="space-y-5">
                                                <div>
                                                    <label className="block text-sm font-black text-slate-400 mb-2">昵称 <span className="text-slate-600 font-normal">（最多 20 字）</span></label>
                                                    <input type="text" value={editForm.nickname} onChange={e => setEditForm(f => ({...f, nickname: e.target.value}))}
                                                        className="login-input" placeholder="设置您的昵称" maxLength={20} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-black text-slate-400 mb-2">绑定邮箱 <span className="text-slate-600 font-normal">（接收通知邮件）</span></label>
                                                    <input type="email" value={editForm.email} onChange={e => setEditForm(f => ({...f, email: e.target.value}))}
                                                        className="login-input" placeholder="请输入邮箱地址" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-black text-slate-400 mb-2">个人简介 <span className="text-slate-600 font-normal">（最多 200 字）</span></label>
                                                    <textarea value={editForm.bio} onChange={e => setEditForm(f => ({...f, bio: e.target.value}))}
                                                        className="login-input resize-none" rows={3} placeholder="介绍一下自己..." maxLength={200}
                                                        style={{ height: 'auto', lineHeight: '1.6' }} />
                                                    <div className="text-right text-xs text-slate-600 mt-1">{editForm.bio.length}/200</div>
                                                </div>
                                            </div>
                                            <button onClick={saveProfile} className="px-8 py-3 rounded-2xl font-black text-sm text-white transition-all hover:opacity-90" style={{ background: 'linear-gradient(135deg, rgba(37,99,235,0.8), rgba(124,58,237,0.8))', boxShadow: '0 8px 20px rgba(99,102,241,0.3)' }}>
                                                保存修改
                                            </button>
                                        </div>

                                        <div className="glass-card p-8">
                                            <h3 className="text-base font-black text-white mb-5 flex items-center gap-2">
                                                <i data-lucide="sliders" className="w-4 h-4 text-purple-400"></i> 使用偏好
                                            </h3>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-bold text-sm text-white">默认分析语言</div>
                                                    <div className="text-xs text-slate-500 mt-0.5">当前：{LANGUAGES.find(l => l.code === selectedLanguage)?.label}</div>
                                                </div>
                                                <select value={selectedLanguage} onChange={e => setSelectedLanguage(e.target.value)} className="lang-selector">
                                                    {LANGUAGES.map(l => <option key={l.code} value={l.code}>{l.label}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                )}
            
                                {/* ────────── 系统控制台 (Console) ────────── */}
                                {section === 'console' && (
                                    <div className="space-y-6 page-title-in">
                                        <div className="flex items-center justify-between">
                                            <h2 className="text-2xl font-black text-white flex items-center gap-3">
                                                <i data-lucide="terminal" className="w-6 h-6 text-indigo-400"></i> 系统控制台
                                            </h2>
                                            <button 
                                                onClick={loadSystemConsole} 
                                                disabled={sysLoading}
                                                className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-slate-400 transition-all">
                                                <i data-lucide="refresh-cw" className={`w-4 h-4 ${sysLoading ? 'animate-spin' : ''}`}></i>
                                            </button>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-5">
                                            {/* API 健康度 */}
                                            <div className="glass-card p-6">
                                                <h3 className="text-xs font-black text-slate-500 uppercase tracking-widest mb-4">服务健康状态</h3>
                                                {sysHealth ? (
                                                    <div className="space-y-3">
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-sm text-slate-400">核心引擎版本</span>
                                                            <span className="text-sm font-mono text-indigo-400">v{sysHealth.analysis_version}</span>
                                                        </div>
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-sm text-slate-400">数据库状态</span>
                                                            <span className="text-xs font-black text-emerald-400 px-2 py-0.5 bg-emerald-500/10 rounded-md">CONNECTED</span>
                                                        </div>
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-sm text-slate-400">活动中的 AI 任务</span>
                                                            <span className="text-sm font-black text-amber-400">{sysHealth.active_tasks}</span>
                                                        </div>
                                                        <div className="pt-3 border-t border-white/5">
                                                            <div className="text-[10px] text-slate-600 mb-2">已加载的向量库分类</div>
                                                            <div className="flex flex-wrap gap-2">
                                                                {Object.entries(sysHealth.vector_dbs || {}).map(([cat, stat]) => (
                                                                    <span key={cat} className={`text-[10px] px-2 py-0.5 rounded-md ${stat === 'ok' ? 'bg-blue-500/10 text-blue-400' : 'bg-red-500/10 text-red-400'}`}>
                                                                        {cat}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ) : <div className="skeleton-block h-32 w-full"></div>}
                                            </div>

                                            {/* 缓存统计 */}
                                            <div className="glass-card p-6">
                                                <h3 className="text-xs font-black text-slate-500 uppercase tracking-widest mb-4">性能与缓存管理</h3>
                                                {cacheInfo ? (
                                                    <div className="space-y-3">
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-sm text-slate-400">缓存条目总数</span>
                                                            <span className="text-sm font-black text-white">{cacheInfo.total_entries}</span>
                                                        </div>
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-sm text-slate-400">累计节省 Token 次数</span>
                                                            <span className="text-sm font-black text-emerald-400">{cacheInfo.total_hits}</span>
                                                        </div>
                                                        <div className="pt-2">
                                                            <button onClick={clearSystemCache} 
                                                                className="w-full mt-4 py-2.5 rounded-xl border border-red-500/30 text-red-400 text-xs font-black hover:bg-red-500/10 transition-all flex items-center justify-center gap-2">
                                                                <i data-lucide="trash-2" className="w-3.5 h-3.5"></i> 清空全局缓存 (Token GC)
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : <div className="skeleton-block h-32 w-full"></div>}
                                            </div>
                                        </div>

                                        {/* 模型运行状态 */}
                                        <div className="glass-card p-6">
                                            <h3 className="text-xs font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                                <i data-lucide="cpu" className="w-3.5 h-3.5"></i> 多模型集群可用性 (Panel Availability)
                                            </h3>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                {sysHealth?.available_models?.map(m => (
                                                    <div key={m} className="flex items-center gap-2 p-3 rounded-xl bg-white/3 border border-white/5">
                                                        <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                                        <span className="text-xs font-mono text-slate-300 truncate">{m}</span>
                                                    </div>
                                                )) || <div className="text-slate-600 text-xs italic">正在检测模型就绪情况...</div>}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* ────────── 安全中心 ────────── */}
                                {section === 'security' && (
                                    <div className="space-y-5">
                                        <h2 className="text-2xl font-black text-white">安全中心</h2>
                                        <MsgBar />

                                        <div className="glass-card p-6 flex items-center gap-5" style={{ background: 'linear-gradient(135deg, rgba(16,185,129,0.07), rgba(6,182,212,0.07))' }}>
                                            <div className="w-16 h-16 rounded-full flex items-center justify-center shrink-0" style={{ background: 'rgba(16,185,129,0.15)', border: '2px solid rgba(16,185,129,0.3)' }}>
                                                <i data-lucide="shield-check" className="w-8 h-8 text-emerald-400"></i>
                                            </div>
                                            <div>
                                                <div className="text-lg font-black text-white">安全评级：⭐⭐⭐ 良好</div>
                                                <div className="text-sm text-slate-400 mt-0.5">JWT 双令牌鉴权，服务端 bcrypt 加密，Refresh Token 自动轮换</div>
                                            </div>
                                        </div>

                                        <div className="glass-card p-6 space-y-3">
                                            <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">安全检查项</h3>
                                            {[
                                                { label: '手机号验证',        done: !!user.phone,     desc: user.phone || '未绑定' },
                                                { label: '服务端密码加密',     done: true,             desc: 'bcrypt 哈希 + 随机 salt，明文不落库' },
                                                { label: 'JWT Access Token', done: true,             desc: `30 分钟有效期，自动刷新` },
                                                { label: 'Refresh Token 轮换', done: true,           desc: '每次刷新旧 Token 立即吊销，防重放攻击' },
                                                { label: '接口限流保护',       done: true,             desc: '每 IP 每分钟最多 10 次鉴权请求' },
                                                { label: '绑定邮箱',          done: !!user.email,     desc: user.email || '未绑定，可接收重要通知' },
                                            ].map((item, i) => (
                                                <div key={i} className="security-item">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center shrink-0 text-xs font-black ${item.done ? 'text-emerald-400 bg-emerald-500/15' : 'text-amber-400 bg-amber-500/10'}`}>
                                                            {item.done ? '✓' : '!'}
                                                        </div>
                                                        <div>
                                                            <div className="font-bold text-sm text-white">{item.label}</div>
                                                            <div className="text-xs text-slate-500 mt-0.5">{item.desc}</div>
                                                        </div>
                                                    </div>
                                                    {!item.done && item.label === '绑定邮箱' && (
                                                        <button onClick={() => setSection('settings')} className="text-xs text-blue-400 font-bold hover:text-blue-300 transition-colors">
                                                            去设置 →
                                                        </button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>

                                        <div className="glass-card p-8 space-y-4">
                                            <h3 className="text-base font-black text-white flex items-center gap-2">
                                                <i data-lucide="lock" className="w-4 h-4 text-blue-400"></i> {user.has_password ? '修改登录密码' : '设置登录密码'}
                                            </h3>
                                            <p className="text-xs text-slate-500">密码长度至少 8 位。密码以 bcrypt 哈希形式存储于服务端，系统无法查看明文。</p>
                                            {user.has_password && (
                                                <input type="password" value={changePwd.oldPwd} onChange={e => setChangePwd(p => ({...p, oldPwd: e.target.value}))}
                                                    className="login-input" placeholder="当前密码" />
                                            )}
                                            <div className="relative">
                                                <input type={showPwdPeek ? 'text' : 'password'} value={changePwd.newPwd} onChange={e => setChangePwd(p => ({...p, newPwd: e.target.value}))}
                                                    className="login-input pr-12" placeholder="新密码（至少 8 位）" />
                                                <button type="button" onClick={() => setShowPwdPeek(v => !v)} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300">
                                                    <i data-lucide={showPwdPeek ? 'eye-off' : 'eye'} className="w-4 h-4"></i>
                                                </button>
                                            </div>
                                            <input type={showPwdPeek ? 'text' : 'password'} value={changePwd.confirmPwd} onChange={e => setChangePwd(p => ({...p, confirmPwd: e.target.value}))}
                                                className="login-input" placeholder="确认新密码" />
                                            <button onClick={doChangePwd} className="px-8 py-3 rounded-2xl font-black text-sm text-white transition-all hover:opacity-90" style={{ background: 'linear-gradient(135deg, rgba(37,99,235,0.8), rgba(124,58,237,0.8))', boxShadow: '0 8px 20px rgba(99,102,241,0.3)' }}>
                                                {user.has_password ? '确认修改密码' : '立即设置密码'}
                                            </button>
                                        </div>

                                        <div className="glass-card p-6 space-y-4" style={{ borderColor: 'rgba(239,68,68,0.12)' }}>
                                            <h3 className="text-base font-black text-red-400 flex items-center gap-2">
                                                <i data-lucide="alert-triangle" className="w-4 h-4"></i> 危险操作
                                            </h3>
                                            <div className="security-item" style={{ background: 'rgba(239,68,68,0.04)', borderColor: 'rgba(239,68,68,0.1)' }}>
                                                <div className="flex-1">
                                                    <div className="font-bold text-sm text-white mb-1">永久注销账号</div>
                                                    <div className="text-xs text-slate-500 mb-3">此操作不可逆，所有审查数据将被永久删除。请输入当前密码（无密码时输入 OTP）确认。</div>
                                                    <input type="password" value={deactivateConfirm} onChange={e => setDeactivateConfirm(e.target.value)}
                                                        className="login-input" style={{ fontSize: '0.8rem', padding: '0.6rem 1rem' }} placeholder="输入密码或 OTP 验证码" />
                                                </div>
                                            </div>
                                            <button onClick={doDeactivate}
                                                className="px-5 py-2 rounded-xl text-sm font-black text-red-400 transition-all hover:bg-red-500/20"
                                                style={{ background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.2)' }}>
                                                确认注销账号
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== 主应用 ====================
        function App() {

            // ── 状态 ──
            const [isDarkMode, setIsDarkMode]       = useState(() => {
                try { return localStorage.getItem('cc-theme') === 'dark'; } catch { return false; }
            });
            const [partyRole, setPartyRole]         = useState('partyA'); // 'partyA'=甲方, 'partyB'=乙方
            const [step, setStep]                   = useState('categorySelect');
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [expandedCat, setExpandedCat]     = useState([]);
            const [isAllExpanded, setIsAllExpanded] = useState(false);
            const [progress, setProgress]           = useState('');
            const [progressStage, setProgressStage] = useState(0); // 0-4
            const [extractedText, setExtractedText] = useState('');
            const [analysisResult, setAnalysisResult] = useState(null);
            const [activeTab, setActiveTab]         = useState('合同总览');
            const [selectedIssue, setSelectedIssue] = useState(null);
            // ★ v4.0 辩论仲裁 UI 状态
            const [debateExpandedIssue, setDebateExpandedIssue] = useState(null); // 展开辩论详情的 issue id
            const [debateActiveRound, setDebateActiveRound]     = useState({});   // {issueId: roundNum}
            const [contractText, setContractText]   = useState('');
            const [copyTip, setCopyTip]             = useState('');
            const [copyTipType, setCopyTipType]     = useState('');
            const [selectedLanguage, setSelectedLanguage] = useState('zh-CN');
            const [ocrStatus, setOcrStatus]         = useState('');

            // ── 新增状态 ──
            const [apiHealth, setApiHealth]         = useState('checking');  // 'ok' | 'error' | 'checking'
            const [quickScanResult, setQuickScanResult] = useState(null);    // 快速预扫描结果
            const [autoDetected, setAutoDetected]   = useState(null);         // 自动检测到的分类
            const [copiedField, setCopiedField]     = useState('');           // 用于微型复制按钮

            // ★ 增强 C: 律师审查状态
            const [lawyerReviewStatus, setLawyerReviewStatus] = useState('idle'); // idle|requesting|requested
            const [lawyerReviewId, setLawyerReviewId]         = useState(null);
            const [showLawyerModal, setShowLawyerModal]       = useState(false);
            const [lawyerNotes, setLawyerNotes]               = useState('');

            // ── 通用微型复制函数 ──
            const copyToClipboard = async (text, fieldKey) => {
                try {
                    await navigator.clipboard.writeText(text);
                    setCopiedField(fieldKey);
                    setTimeout(() => setCopiedField(''), 2000);
                } catch (e) { /* fallback */ }
            };

            // ── API 健康检测（每 60s 轮询一次）──
            useEffect(() => {
                const checkHealth = async () => {
                    try {
                        const res = await fetch(`${API_BASE_URL}/health`, {
                            headers: { 'bypass-tunnel-reminder': 'true', 'ngrok-skip-browser-warning': 'true' }
                        });
                        setApiHealth(res.ok ? 'ok' : 'error');
                    } catch {
                        setApiHealth('error');
                    }
                };
                checkHealth();
                const id = setInterval(checkHealth, 60000);
                return () => clearInterval(id);
            }, []);

            // ── 翻译函数 ──
            const t = (key, ...args) => {
                const dict = UI_STRINGS[selectedLanguage] || UI_STRINGS['zh-CN'];
                const fallback = UI_STRINGS['zh-CN'];
                const val = dict[key] !== undefined ? dict[key] : fallback[key];
                if (typeof val === 'function') return val(...args);
                return val !== undefined ? val : key;
            };

            // 翻译合同类型名称
            const getCatName = (id) => {
                const dict = UI_STRINGS[selectedLanguage] || UI_STRINGS['zh-CN'];
                return (dict.cat_names || {})[id] || id;
            };
            const [isDragOver, setIsDragOver]       = useState(false);
            const [fileInfo, setFileInfo]           = useState(null); // {name, size, chars}
            const [revisionView, setRevisionView]   = useState('contract'); // 'contract' | 'notes'

            // ── 用户鉴权状态 ──
            const [currentUser, setCurrentUser]   = useState(null);
            const [authLoading, setAuthLoading]   = useState(true);  // 首次 token 校验
            const [showLogin, setShowLogin]        = useState(false);
            const [showProfile, setShowProfile]    = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            // --- 新增状态 ---
            const [userPerms, setUserPerms] = useState(new Set());
            const [userRole, setUserRole]   = useState('employee');

            // --- 新增权限加载函数 ---
            const _loadUserPerms = async () => {
                try {
                    const res = await apiGet('/auth/me/permissions');
                    if (res.ok) {
                        const data = await res.json();
                        setUserPerms(new Set(data.permissions || []));
                        setUserRole(data.role || 'employee');
                        // 重要：同步 currentUser 的 role，否则个人中心看不到管理标签
                        setCurrentUser(prev => ({ ...prev, role: data.role }));
                        console.log("当前角色已激活:", data.role);
                    }
                } catch (err) { console.error("权限加载失败", err); }
            };

            const pollingRef = useRef(null);
            const authFetchedRef = useRef(false);
            const isAdmin = () => currentUser?.role === 'admin';
            // ── Esc 键关闭弹窗 + Ctrl+Enter 触发分析 ──
            useEffect(() => {
                const onKey = (e) => {
                    if (e.key === 'Escape') {
                        if (showLogin)   setShowLogin(false);
                        if (showProfile) setShowProfile(false);
                    }
                    // Ctrl+Enter 或 Cmd+Enter 快捷启动分析
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && step === 'upload' && isTextValid) {
                        setExtractedText(contractText);
                        setStep('analyzing');
                        startPollingAI(contractText);
                    }
                };
                window.addEventListener('keydown', onKey);
                return () => window.removeEventListener('keydown', onKey);
            }, [showLogin, showProfile, step, contractText, isTextValid]);

            // ── 主题同步 ──
            useEffect(() => {
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                try { localStorage.setItem('cc-theme', isDarkMode ? 'dark' : 'light'); } catch {}
            }, [isDarkMode]);

            // ── 启动时验证 JWT，从后端加载用户（ref 防止重复执行）──
            useEffect(() => {
                if (authFetchedRef.current) return;
                authFetchedRef.current = true;
                fetchCurrentUser().then(user => {
                    setCurrentUser(user);
                    setAuthLoading(false);
                    // --- 关键修改：如果登录了，立即加载权限 ---
                    if (user) _loadUserPerms(); 
                });
            }, []);

            const currentLength = contractText.length;
            const isTextValid   = currentLength >= MIN_CHARACTERS && currentLength <= MAX_CHARACTERS;

            // ── 图标刷新 ──
            useEffect(() => { lucide.createIcons(); }, [step, activeTab, selectedIssue]);

            // ── 工具函数 ──
            const normalizeRisk = (s) => String(s || '').trim();

            const getRiskColor = (s) => {
                const r = normalizeRisk(s).toLowerCase();
                if (r.includes('极高') || r.includes('critical') || r.includes('très') || r.includes('sehr') || r.includes('muy')) return 'risk-极高';
                if (r.includes('高') || r === 'high' || r.includes('élevé') || r.includes('hoch') || r.includes('alto')) return 'risk-高';
                if (r.includes('中') || r === 'medium' || r.includes('moyen') || r === 'mittel' || r.includes('medio')) return 'risk-中';
                if (r.includes('低') || r === 'low' || r.includes('faible') || r === 'niedrig' || r.includes('bajo')) return 'risk-低';
                return 'bg-slate-600';
            };

            const getBorderColor = (s) => {
                const r = normalizeRisk(s).toLowerCase();
                if (r.includes('极高') || r.includes('critical')) return 'border-极高';
                if (r.includes('高') || r === 'high') return 'border-高';
                if (r.includes('中') || r === 'medium') return 'border-中';
                if (r.includes('低') || r === 'low') return 'border-低';
                return 'border-slate-800';
            };

            const getRiskHex = (s) => {
                const r = normalizeRisk(s).toLowerCase();
                if (r.includes('极高') || r.includes('critical')) return '#ef4444';
                if (r.includes('高') || r === 'high') return '#f97316';
                if (r.includes('中') || r === 'medium') return '#fbbf24';
                return '#10b981';
            };

            const parseMarkdownToHtml = (text, styleType) => {
                if (!text) return '';
                const colorMap = { aggressive: 'text-red-400', consultative: 'text-blue-400', compromise: 'text-green-400' };
                const colorClass = colorMap[styleType] || 'text-blue-400';
                let html = text
                    .replace(/\*\*(.*?)\*\*/g, `<strong class="font-bold ${colorClass}">$1</strong>`)
                    .replace(/(\d+)\. (.*?)(\n|$)/g, `<div class="ml-4 mb-2 flex items-start gap-2"><span class="${colorClass} shrink-0">$1.</span><span>$2</span></div>`)
                    .replace(/\- (.*?)(\n|$)/g, `<div class="ml-8 mb-2 flex items-start gap-2"><span class="${colorClass} shrink-0">•</span><span>$1</span></div>`)
                    .replace(/\n/g, '<br/>');
                return html.replace(/^(<br\/>)+/, '').replace(/(<br\/>)+$/, '');
            };

            // ── 取消分析 ──
            const cancelAnalysis = () => {
                if (pollingRef.current) clearInterval(pollingRef.current);
                setStep('upload');
                setProgress('');
                setAnalysisResult(null);
                setProgressStage(0);
            };

            // ── 用户登录回调（LoginPage 调用，传入 {user, access_token, refresh_token}）──
            const handleLogin = useCallback(({ user, access_token, refresh_token }) => {
                setTokens(access_token, refresh_token);
                setCurrentUser(user);
                setShowLogin(false);
            }, []);

            // ── 用户登出 ──
            const handleLogout = useCallback(async () => {
                try {
                    await apiPost('/auth/logout', { refresh_token: getRefreshToken() });
                } catch { /* 忽略网络错误，直接清除本地 token */ }
                clearTokens();
                setCurrentUser(null);
                setShowProfile(false);
            }, []);

            // ── 更新用户信息（ProfilePage 保存后回调）──
            const handleUpdateUser = useCallback((updatedUser) => {
                setCurrentUser(updatedUser);
            }, []);

            // ── 将分析结果异步保存至后端 ──
            const saveToHistory = async (result, category) => {
                if (!currentUser) return;
                const record = {
                    date:              new Date().toISOString(),
                    category:          category || '其他类',
                    contract_type:     result.contractType || '未知合同',
                    risk_score:        result.riskScore    || 0,
                    overall_risk:      result.overallRisk  || '',
                    summary:           result.summary      || '',
                    jurisdiction:      result.jurisdiction || '',
                    issues: (result.issues || []).map(i => ({
                        severity: i.severity, title: i.title, id: i.id,
                        confidence_score: i.confidence_score,   // ★ 增强A
                        model_agreement:  i.model_agreement,    // ★ 增强A
                    })),
                    // ★ 增强 A: 多模型元数据
                    models_used:        result._models_used || [],
                };
                try {
                    const res = await apiPost('/auth/contracts', record);
                    if (res.ok) {
                        setCurrentUser(u => u ? { ...u, review_count: (u.review_count || 0) + 1 } : u);
                    }
                } catch (e) {
                    console.warn('保存合同记录失败:', e);
                }
            };

            // ── 下载报告 ──
            const downloadReport = () => {
                const r = analysisResult;
                let text = `对簿AI 合同分析报告\n========================\n\n`;
                text += `合同类型: ${r.contractType}\n风险分数: ${r.riskScore}/100\n国家或地区: ${r.jurisdiction}\n\n`;
                text += `总体点评:\n${r.summary}\n\n`;
                text += `核心风险点:\n`;
                r.issues.forEach((iss, i) => {
                    text += `${i+1}. [${iss.severity.toUpperCase()}] ${iss.title}\n`;
                    text += `   问题: ${iss.problem}\n`;
                    text += `   建议: ${(iss.whatToDo||[]).join(', ')}\n\n`;
                });
                text += `\n========================================\n谈判与博弈策略\n========================================\n\n`;
                text += `一、博弈全局观\n${r.negotiation.strategy}\n\n`;
                text += `二、电话面谈脚本\n开场：${r.negotiation.talkTrack.opening}\n\n核心理由：\n`;
                r.negotiation.talkTrack.reasons.forEach((item, i) => { text += `${i+1}. ${item}\n`; });
                text += `\n三、多风格谈判策略\n\n1) 强硬风格\n${r.negotiation.styles.aggressive}\n\n2) 协商风格\n${r.negotiation.styles.consultative}\n\n3) 妥协风格\n${r.negotiation.styles.compromise}\n\n`;
                text += `四、书面沟通邮件\n${r.negotiation.email}`;
                if (r.revisedContract) {
                    text += `\n\n========================================\n完整修订合同\n========================================\n\n${r.revisedContract}`;
                }
                const blob = new Blob([text], { type: 'text/plain' });
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement('a');
                a.href     = url;
                a.download = `ContractClarity_完整分析报告_${Date.now()}.txt`;
                a.click();
            };

            // ── 下载修订合同 ──
            const downloadRevisedContract = () => {
                if (!analysisResult?.revisedContract) return;
                const blob = new Blob([analysisResult.revisedContract], { type: 'text/plain' });
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement('a');
                a.href     = url;
                a.download = `ContractClarity_修订合同_${Date.now()}.txt`;
                a.click();
            };

            // ★ 增强 C: 申请律师审查
            const requestLawyerReview = async () => {
                if (!currentUser) { alert(t('login_required_review')); return; }
                setLawyerReviewStatus('requesting');
                try {
                    const res = await apiPost('/review/request', {
                        contract_text: extractedText,
                        category:      selectedCategory || '其他类',
                        risk_score:    analysisResult?.riskScore || 0,
                        ai_result:     analysisResult || {},
                        notes:         lawyerNotes,
                        priority:      (analysisResult?.riskScore || 0) >= 85 ? 'urgent' : 'normal',
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setLawyerReviewStatus('requested');
                        setLawyerReviewId(data.review_id);
                        setShowLawyerModal(false);
                    } else {
                        setLawyerReviewStatus('idle');
                        alert(data.error || '申请失败，请重试');
                    }
                } catch (e) {
                    setLawyerReviewStatus('idle');
                    alert('网络错误，请重试');
                }
            };

            // ── OCR AI 优化 ──
            const refineOcrText = async (rawText) => {
                setOcrStatus(t('ocr_processing'));
                try {
                    const res = await fetch(`${API_BASE_URL}/ocr-refine`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'bypass-tunnel-reminder': 'true' },
                        body: JSON.stringify({ text: rawText, language: selectedLanguage })
                    });
                    const data = await res.json();
                    if (data.refined) {
                        setOcrStatus(t('ocr_done'));
                        setTimeout(() => setOcrStatus(''), 3000); // Fix 2: 3秒后自动消失
                        return data.refined;
                    }
                } catch (e) {
                    console.warn('OCR refine failed, using raw text:', e);
                }
                setOcrStatus('');
                return rawText;
            };

            // ── 文件上传处理 ──
            const handleFileUpload = async (files) => {
                setStep('analyzing');
                setProgress('正在智能解析文档...');
                setProgressStage(0);
                let fullText = '';
                try {
                    for (const f of Array.from(files)) {
                        const ext = f.name.split('.').pop().toLowerCase();
                        const fileSizeMB = (f.size / 1024 / 1024).toFixed(2);

                        if (ext === 'txt') {
                            fullText += await new Promise(res => {
                                const r = new FileReader();
                                r.onload = e => res(e.target.result);
                                r.readAsText(f);
                            });
                        } else if (ext === 'docx') {
                            const res = await mammoth.extractRawText({ arrayBuffer: await f.arrayBuffer() });
                            fullText += res.value;
                        } else if (ext === 'pdf') {
                            const pdf = await pdfjsLib.getDocument({ data: await f.arrayBuffer() }).promise;
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page    = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                fullText += content.items.map(it => it.str).join(' ') + '\n';
                            }
                        } else if (['png', 'jpg', 'jpeg', 'webp', 'bmp'].includes(ext)) {
                            setProgress(`正在进行 OCR 文字识别（${f.name}）...`);
                            const worker = await Tesseract.createWorker();
                            await worker.loadLanguage('chi_sim+chi_tra+eng+jpn+kor');
                            await worker.initialize('chi_sim+chi_tra+eng');
                            const { data: { text: t } } = await worker.recognize(f);
                            await worker.terminate();
                            // AI 优化 OCR 结果
                            setProgress('正在优化 OCR 识别结果...');
                            const refined = await refineOcrText(t);
                            fullText += refined + '\n';
                        }
                    }

                    if (!fullText.trim()) throw new Error('文本提取失败，请检查文件内容');
                    if (fullText.trim().length < MIN_CHARACTERS) throw new Error(`提取的文本不足 ${MIN_CHARACTERS} 字，请上传内容更完整的文档`);

                    // 超出字数时截断并提示
                    let finalText = fullText.trim();
                    if (finalText.length > FILE_MAX_CHARS) {
                        finalText = finalText.substring(0, FILE_MAX_CHARS);
                        console.warn(`文件内容超出 ${FILE_MAX_CHARS} 字限制，已自动截断。`);
                    }

                    setExtractedText(finalText);
                    startPollingAI(finalText);
                } catch (e) {
                    alert(e.message);
                    setStep('upload');
                    setProgressStage(0);
                }
            };

            // ── 拖放处理 ──
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                const files = e.dataTransfer.files;
                if (files.length) handleFileUpload(files);
            };

            // ── 启动 AI 分析 ──
            const startPollingAI = async (text) => {
                setProgress('正在初始化分析任务...');
                setProgressStage(1);
                setQuickScanResult(null);

                // ── 并行启动快速预扫描（仅中文分类模式）──
                if (selectedLanguage === 'zh-CN') {
                    fetch(`${API_BASE_URL}/analyze/quick`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'bypass-tunnel-reminder': 'true' },
                        body: JSON.stringify({ text, category: selectedCategory, language: selectedLanguage, party_role: partyRole })
                    }).then(r => r.ok ? r.json() : null)
                      .then(d => { if (d && !d.error) setQuickScanResult(d); })
                      .catch(() => {});
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/analyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'bypass-tunnel-reminder': 'true' },
                        body: JSON.stringify({ text, category: selectedCategory, language: selectedLanguage, party_role: partyRole })
                    });
                    const respData = await response.json();
                    if (!response.ok) {
                        throw new Error(respData.message || respData.error || '服务启动失败');
                    }
                    const { task_id, warnings } = respData;
                    if (warnings && warnings.length > 0) {
                        setProgress(`⚠ ${warnings[0]}  |  正在初始化...`);
                    }

                    pollingRef.current = setInterval(async () => {
                        try {
                            const res    = await fetch(`${API_BASE_URL}/status/${task_id}`, { headers: { 'bypass-tunnel-reminder': 'true', 'ngrok-skip-browser-warning': 'true' } });
                            const status = await res.json();

                            if (status.progress) {
                                setProgress(status.progress);
                            }

                            if (status.stage !== undefined) {
                                setProgressStage(status.stage);
                            } else if (status.progress) {
                                if      (status.progress.includes('多模型') || status.progress.includes('审查团') || status.progress.includes('风险审查'))  setProgressStage(1);
                                else if (status.progress.includes('辩论') || status.progress.includes('仲裁') || status.progress.includes('甲方'))  setProgressStage(1);
                                else if (status.progress.includes('邮件'))      setProgressStage(2);
                                else if (status.progress.includes('话术'))      setProgressStage(2);
                                else if (status.progress.includes('修订版'))    setProgressStage(3);
                                else if (status.progress.includes('案例'))      setProgressStage(4);
                                else if (status.progress.includes('整合'))      setProgressStage(4);
                            }

                            if (status.status === 'completed') {
                                clearInterval(pollingRef.current);
                                setAnalysisResult(status.result);
                                setStep('results');
                                setProgressStage(0);
                                setQuickScanResult(null);
                                saveToHistory(status.result, selectedCategory);
                                if (status.result.issues?.length > 0) setSelectedIssue(status.result.issues[0]);
                                setTimeout(() => lucide.createIcons(), 100);
                            } else if (status.status === 'failed') {
                                clearInterval(pollingRef.current);
                                alert('AI 处理失败: ' + status.error);
                                setStep('upload');
                                setProgressStage(0);
                            }
                        } catch (e) { console.log('轮询异常:', e); }
                    }, 1000);
                } catch (e) {
                    alert('服务启动失败: ' + e.message);
                    setStep('upload');
                    setProgressStage(0);
                }
            };

            // ── 改进的文本高亮（支持跨行空白匹配）──
            const renderHighlightedText = () => {
                if (!analysisResult || !extractedText) return <span>{extractedText}</span>;
                let html = extractedText
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                analysisResult.issues.forEach(iss => {
                    if (!iss.clauseText || iss.clauseText.length < 4) return;
                    try {
                        // 将 clauseText 中的连续空白替换成 \s+ 以支持跨行匹配
                        const escaped = iss.clauseText
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                            .replace(/\s+/g, '\\s+');
                        const regex = new RegExp(`(${escaped})`, 'gs');
                        const severity = normalizeRisk(iss.severity);
                        html = html.replace(regex,
                            `<span class="highlight-${severity} px-1 rounded font-bold cursor-pointer" ` +
                            `title="${iss.title.replace(/"/g, '&quot;')}" ` +
                            `style="text-decoration:underline dotted;">$1</span>`
                        );
                    } catch (e) { /* 正则无效时跳过 */ }
                });
                return <div dangerouslySetInnerHTML={{ __html: html }} />;
            };

            // ── 修订合同渲染（高亮【修订】标记）──
            const renderRevisedContract = (text) => {
                if (!text) return '';
                const escaped = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br/>');
                return escaped.replace(
                    /【修订】(.*?)(?=<br\/>|$)/g,
                    '<span class="revision-marker">【修订】$1</span>'
                );
            };

            // ── 字符条颜色 ──
            const getCharBarClass = (len) => {
                if (len > MAX_CHARACTERS) return 'char-bar-error';
                if (len > MAX_CHARACTERS * 0.8) return 'char-bar-warn';
                return 'char-bar-ok';
            };
            const charBarWidth = Math.min((currentLength / MAX_CHARACTERS) * 100, 100);

            // ─────────────────── 子组件 ───────────────────

            // 迷你仪表盘
            const MiniDashboard = () => {
                const counts = {};
                analysisResult.issues.forEach(i => {
                    const s = normalizeRisk(i.severity);
                    counts[s] = (counts[s] || 0) + 1;
                });

                // 固定顺序：极高 -> 高 -> 中 -> 低
                const fixedOrder = ['极高', '高', '中', '低'];
                
                return (
                    <div className="glass-card-light p-5 space-y-3">
                        <div className="text-xs font-black uppercase tracking-widest text-slate-500 mb-4">{t('risk_dist')}</div>
                        {fixedOrder.map(label => {
                            const count = counts[label] || 0; // 如果某个等级没有风险，显示为 0
                            const total = analysisResult.issues.length || 1;
                            return (
                                <div key={label} className="flex items-center gap-3">
                                    <div className={`w-3 h-3 rounded-full shrink-0 ${getRiskColor(label)}`}></div>
                                    <span className="text-sm text-slate-400 w-12 shrink-0">{label}</span>
                                    <div className="flex-1 bg-white/5 rounded-full h-2 overflow-hidden">
                                        <div
                                            className={`risk-bar h-full rounded-full ${getRiskColor(label)}`}
                                            style={{ width: `${(count / total) * 100}%` }}
                                        ></div>
                                    </div>
                                    <span className="text-sm font-black text-slate-300 w-4 text-right">{count}</span>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            // 风险仪表盘
            const RiskMeter = ({ score }) => {
                const radius = 90;
                const circ   = Math.PI * radius;
                const offset = circ - (score / 100) * circ;
                const getColor = (s) => {
                    if (s <= 50) {
                        const p = s / 50;
                        return `rgb(${Math.round(16+(251-16)*p)},${Math.round(185+(191-185)*p)},${Math.round(129+(36-129)*p)})`;
                    }
                    const p = (s-50)/50;
                    return `rgb(${Math.round(251+(239-251)*p)},${Math.round(191+(68-191)*p)},${Math.round(36+(68-36)*p)})`;
                };
                const getRiskLabel = (s) => {
                    if (s >= 80) return { text: t('risk_lv').xh, color: '#ef4444' };
                    if (s >= 60) return { text: t('risk_lv').h,  color: '#f97316' };
                    if (s >= 40) return { text: t('risk_lv').m,  color: '#fbbf24' };
                    if (s >= 20) return { text: t('risk_lv').l,  color: '#10b981' };
                    return          { text: t('risk_lv').s,  color: '#059669' };
                };
                const strokeColor = getColor(score);
                const riskInfo    = getRiskLabel(score);
                return (
                    <div className="relative flex flex-col items-center">
                        <svg width="240" height="140" viewBox="0 0 240 140">
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                    <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                                </filter>
                            </defs>
                            <path d="M20,120 A100,100 0 0,1 220,120" fill="none" stroke="#374151" strokeWidth="14" strokeLinecap="round"/>
                            <path className="gauge-ring" d="M20,120 A100,100 0 0,1 220,120" fill="none"
                                stroke={strokeColor} strokeWidth="14" strokeLinecap="round"
                                strokeDasharray={`${circ} ${circ}`} strokeDashoffset={offset}
                                filter="url(#glow)"
                            />
                            {[0,25,50,75,100].map((tick, i) => {
                                const angle = (Math.PI * tick) / 100;
                                const x1 = 120-100*Math.cos(angle), y1 = 120-100*Math.sin(angle);
                                const x2 = 120-85*Math.cos(angle),  y2 = 120-85*Math.sin(angle);
                                return <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke="#718096" strokeWidth="2" strokeLinecap="round"/>;
                            })}
                        </svg>
                        <div className="absolute top-16 text-center">
                            <span className="text-6xl font-black" style={{ color: strokeColor }}>{score || 0}</span>
                            <div className="text-[11px] font-bold text-slate-500 uppercase tracking-widest mt-1">RISK SCORE</div>
                        </div>
                        <div className="mt-4 px-6 py-2 rounded-full text-sm font-black tracking-wider"
                            style={{ backgroundColor: `${riskInfo.color}20`, color: riskInfo.color, border: `2px solid ${riskInfo.color}40` }}>
                            {riskInfo.text}
                        </div>
                    </div>
                );
            };

            // 进度步骤指示器
            const ProgressStepper = () => {
                const stages = t('stages');
                return (
                    <div className="flex items-center gap-2 justify-center mt-8">
                        {stages.map((s, i) => (
                            <React.Fragment key={s}>
                                <div className={`flex flex-col items-center gap-1 transition-all ${i < progressStage ? 'opacity-100' : i === progressStage ? 'opacity-100' : 'opacity-20'}`}>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-black ${
                                        i < progressStage  ? 'bg-green-500 text-white' :
                                        i === progressStage ? 'bg-blue-500 text-white animate-pulse' :
                                        'bg-white/10 text-slate-500'
                                    }`}>
                                        {i < progressStage ? '✓' : i+1}
                                    </div>
                                    <span className="text-[10px] text-slate-400 whitespace-nowrap">{s}</span>
                                </div>
                                {i < stages.length-1 && (
                                    <div className={`flex-1 h-px max-w-[32px] mb-4 ${i < progressStage ? 'bg-green-500' : 'bg-white/10'}`}></div>
                                )}
                            </React.Fragment>
                        ))}
                    </div>
                );
            };

            // ─────────────────── 渲染 ───────────────────
            if (authLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center animate-fade">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-3xl mb-5"
                                style={{ background: 'linear-gradient(135deg, #3b82f6, #8b5cf6)', boxShadow: '0 12px 32px rgba(99,102,241,0.4)' }}>
                                <i data-lucide="scale" className="w-8 h-8 text-white"></i>
                            </div>
                            <div className="text-2xl font-black display-font">对簿<span className="gradient-text">AI</span></div>
                            <div className="flex items-center justify-center gap-1.5 mt-4">
                                {[0,1,2].map(i => (
                                    <div key={i} className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"
                                        style={{ animationDelay: `${i*0.2}s` }}></div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <React.Fragment>
                    <div className="max-w-7xl mx-auto p-4 md:p-10 min-h-screen">

                        {/* ── 回到顶部 ── */}
                        <button
                            onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                            className="scroll-top-btn"
                            title="回到顶部">
                            <i data-lucide="arrow-up" className="w-4 h-4"></i>
                        </button>

                        {/* ── 登录弹窗 ── */}
                        {showLogin && (
                            <LoginPage
                                onLogin={handleLogin}
                                onClose={() => setShowLogin(false)}
                            />
                        )}
                
                        {/* ★ 管理员面板 */}
                        {showAdminPanel && isAdmin() && (
                            <AdminPanel
                                onClose={() => setShowAdminPanel(false)}
                                currentUserId={currentUser?.id}
                            />
                        )}

                        {/* ── 个人中心（全屏覆盖） ── */}
                        {showProfile && currentUser && (
                            <ProfilePage
                                user={currentUser}
                                onClose={() => setShowProfile(false)}
                                onLogout={handleLogout}
                                onUpdateUser={handleUpdateUser}
                                selectedLanguage={selectedLanguage}
                                setSelectedLanguage={setSelectedLanguage}
                            />
                        )}

                        {/* ── 头部 ── */}
                        <header className="text-center mb-14 animate-up">
                            <div className="flex items-center justify-between mb-6">
                                <div className="inline-flex items-center gap-2 px-4 py-2 glass-card border-blue-500/20 text-blue-400 text-xs font-bold tracking-widest uppercase"
                                    style={{boxShadow: '0 0 20px rgba(59,130,246,0.1)'}}>
                                    <div className={`w-2 h-2 rounded-full ${apiHealth === 'ok' ? 'api-dot-ok' : apiHealth === 'error' ? 'api-dot-error' : 'api-dot-checking'}`}></div>
                                    <i data-lucide="shield" className="w-4 h-4"></i>
                                    AI-Powered Contract Review
                                    {apiHealth === 'error' && <span className="text-red-400 ml-1">· 服务离线</span>}
                                </div>
                            {/* 语言选择器 + 用户入口 */}
                            <div className="flex items-center gap-3">
                                <i data-lucide="globe-2" className="w-4 h-4 text-slate-500"></i>
                                <select
                                    value={selectedLanguage}
                                    onChange={e => setSelectedLanguage(e.target.value)}
                                    className="lang-selector"
                                >
                                    {LANGUAGES.map(l => (
                                        <option key={l.code} value={l.code}>{l.label}</option>
                                    ))}
                                </select>
                                {/* ── 主题切换按钮 ── */}
                                <button
                                    className="theme-toggle-btn"
                                    onClick={() => setIsDarkMode(d => !d)}
                                    title={isDarkMode ? '切换至浅色模式' : '切换至深色模式'}
                                >
                                    {isDarkMode
                                        ? <i data-lucide="sun" className="w-4 h-4"></i>
                                        : <i data-lucide="moon" className="w-4 h-4"></i>
                                    }
                                </button>
                                <span className="text-slate-700 hidden md:block">|</span>
                                {currentUser ? (
                                    <div className="flex items-center gap-2">
                                        {/* ★ 管理员专属：顶部控制台按钮 */}
                                        {currentUser.role === 'admin' && (
                                            <button
                                                onClick={() => setShowAdminPanel(true)}
                                                className="flex items-center gap-1.5 px-4 py-2 rounded-xl font-black text-xs text-amber-400 transition-all hover:bg-amber-500/10"
                                                style={{ background: 'rgba(245,158,11,0.08)', border: '1px solid rgba(245,158,11,0.2)' }}>
                                                <i data-lucide="shield" className="w-3.5 h-3.5"></i>
                                                <span className="hidden md:inline">系统控制台</span>
                                            </button>
                                        )}
                                        
                                        <button className="user-avatar-btn" onClick={() => setShowProfile(true)}>
                                            <div className="avatar-circle" style={{ width: '28px', height: '28px', fontSize: '0.75rem' }}>
                                                {(currentUser.nickname || currentUser.phone || 'U')[0].toUpperCase()}
                                            </div>
                                            <span className="text-sm font-bold text-slate-300 hidden md:block max-w-[80px] truncate">
                                                {currentUser.nickname || (currentUser.phone?.slice(0,3) + '****' + currentUser.phone?.slice(7))}
                                            </span>
                                            <i data-lucide="chevron-down" className="w-3 h-3 text-slate-500 hidden md:block"></i>
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowLogin(true)}
                                        className="flex items-center gap-1.5 px-4 py-2 rounded-xl font-bold text-sm text-blue-400 transition-all hover:text-blue-300"
                                        style={{ background: 'rgba(59,130,246,0.1)', border: '1px solid rgba(59,130,246,0.2)' }}>
                                        <i data-lucide="user" className="w-3.5 h-3.5"></i>
                                        <span className="hidden md:inline">登录 / 注册</span>
                                        <span className="md:hidden">登录</span>
                                    </button>
                                )}
                            </div>
                            </div>
                            <h1 className="text-5xl md:text-8xl font-black display-font mb-4 tracking-tighter">
                                对簿<span className="gradient-text">AI</span>
                            </h1>
                            <div className="flex items-center justify-center gap-3 mb-5">
                                <div style={{height:'1px', width:'60px', background:'linear-gradient(90deg, transparent, rgba(99,102,241,0.5))'}}></div>
                                <div className="w-1.5 h-1.5 rounded-full" style={{background:'linear-gradient(135deg,#3b82f6,#8b5cf6)'}}></div>
                                <div style={{height:'1px', width:'60px', background:'linear-gradient(90deg, rgba(99,102,241,0.5), transparent)'}}></div>
                            </div>
                            <p className="text-xl text-slate-300 font-light italic">
                                <span className="gradient-text">Contract Clarity</span>
                                <span className="text-slate-500 mx-3">·</span>{t('subtitle')}
                                <span className="text-slate-500 mx-3">·</span>{t('subtitle2')}
                                <span className="text-slate-500 mx-3">·</span>{t('subtitle3')}
                            </p>
                        </header>

                        {/* ══════════════════════════════════════════════════ */}
                        {/* 步骤 1: 选择合同类型                                */}
                        {/* ══════════════════════════════════════════════════ */}
                        {step === 'categorySelect' && (
                            <div className="max-w-7xl mx-auto animate-up px-4"> {/* 加宽容器 + 增加左右内边距 */}
                                <div className="text-center mb-10">
                                    <h2 className="text-3xl font-bold text-white mb-2 tracking-tight">{t('step1_heading')}</h2>
                                    <p className="text-slate-500 mb-5 text-sm">{t('step1_desc')}</p>
                                    <button
                                        onClick={() => { setIsAllExpanded(!isAllExpanded); setExpandedCat(isAllExpanded ? [] : CATEGORIES.map(c => c.id)); }}
                                        className="px-5 py-2 text-blue-400 rounded-full text-xs font-bold hover:text-blue-300 transition-all"
                                        style={{background: 'rgba(59,130,246,0.08)', border: '1px solid rgba(59,130,246,0.2)'}}
                                    >
                                        {isAllExpanded ? t('collapse_all') : t('expand_all')}
                                    </button>
                                </div>
                                {/* 核心修改：网格布局改为 4列（大屏）/ 2列（平板）/ 1列（手机） */}
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 items-start">
                                    {CATEGORIES.map((cat, idx) => {
                                        const catColors = {
                                            '劳动用工类': { icon: 'text-blue-400', bg: 'bg-blue-600/20', bgSel: 'bg-blue-600/40', border: 'border-blue-500', check: 'text-blue-400' },
                                            '房产物业类': { icon: 'text-emerald-400', bg: 'bg-emerald-600/20', bgSel: 'bg-emerald-600/40', border: 'border-emerald-500', check: 'text-emerald-400' },
                                            '消费服务类': { icon: 'text-orange-400', bg: 'bg-orange-600/20', bgSel: 'bg-orange-600/40', border: 'border-orange-500', check: 'text-orange-400' },
                                            '金融借贷类': { icon: 'text-amber-400', bg: 'bg-amber-600/20', bgSel: 'bg-amber-600/40', border: 'border-amber-500', check: 'text-amber-400' },
                                            '网络数字类': { icon: 'text-violet-400', bg: 'bg-violet-600/20', bgSel: 'bg-violet-600/40', border: 'border-violet-500', check: 'text-violet-400' },
                                            '婚姻家庭类': { icon: 'text-pink-400', bg: 'bg-pink-600/20', bgSel: 'bg-pink-600/40', border: 'border-pink-500', check: 'text-pink-400' },
                                            '经营合作类': { icon: 'text-teal-400', bg: 'bg-teal-600/20', bgSel: 'bg-teal-600/40', border: 'border-teal-500', check: 'text-teal-400' },
                                            '其他类':     { icon: 'text-slate-400', bg: 'bg-slate-600/20', bgSel: 'bg-slate-600/40', border: 'border-slate-500', check: 'text-slate-400' },
                                        };
                                        const cc = catColors[cat.id] || catColors['其他类'];
                                        const isSelected = selectedCategory === cat.id;
                                        return (
                                        <div key={cat.id} className={`glass-card p-6 transition-all hover-lift border-2 card-reveal ${isSelected ? `${cc.border} bg-blue-500/5` : 'border-white/5 hover:border-white/15'}`}
                                            style={{animationDelay: `${idx * 0.06}s`}}>
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-4 flex-1 cursor-pointer"
                                                    onClick={() => { setSelectedCategory(cat.id); setStep('upload'); }}>
                                                    <div className={`p-3 rounded-2xl transition-all ${isSelected ? cc.bgSel : cc.bg} ${cc.icon}`}>
                                                        <i data-lucide={cat.icon} className="w-6 h-6"></i>
                                                    </div>
                                                    <div>
                                                        <span className="text-xl font-bold text-white">{getCatName(cat.id)}</span>
                                                        {isSelected && <div className={`text-[10px] ${cc.check} font-black mt-0.5`}>✓ 已选择</div>}
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={e => { e.stopPropagation(); setExpandedCat(prev => prev.includes(cat.id) ? prev.filter(id => id !== cat.id) : [...prev, cat.id]); setTimeout(() => lucide.createIcons(), 100); }}
                                                    className="p-2 hover:bg-white/5 rounded-full transition-colors text-slate-500"
                                                >
                                                    <i data-lucide={expandedCat.includes(cat.id) ? 'chevron-up' : 'chevron-down'} className="w-5 h-5"></i>
                                                </button>
                                            </div>
                                            {expandedCat.includes(cat.id) && (
                                                <div className="mt-4 pt-4 border-t border-white/5 text-sm text-slate-400 leading-relaxed negotiation-markdown"
                                                    dangerouslySetInnerHTML={{ __html: parseMarkdownToHtml(cat.detail) }}>
                                                </div>
                                            )}
                                        </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* ══════════════════════════════════════════════════ */}
                        {/* 步骤 2: 上传 / 粘贴                                */}
                        {/* ══════════════════════════════════════════════════ */}
                        {step === 'upload' && (
                            <div className="max-w-4xl mx-auto space-y-10 animate-up">
                                <div className="flex justify-between items-center px-2">
                                    <button onClick={() => setStep('categorySelect')}
                                        className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                                        <i data-lucide="arrow-left" className="w-4 h-4"></i> {t('back_btn')}
                                    </button>
                                    <div className="flex items-center gap-3">
                                        <span className="text-sm font-bold text-blue-400 uppercase tracking-widest">{t('current_type')}{getCatName(selectedCategory)}</span>
                                        <span className="text-slate-600">|</span>
                                        <span className={`text-xs font-black px-2 py-0.5 rounded-lg ${partyRole === 'partyA' ? 'text-blue-400 bg-blue-500/10' : 'text-purple-400 bg-purple-500/10'}`}>
                                            {partyRole === 'partyA' ? '以甲方视角审查' : '以乙方视角审查'}
                                        </span>
                                        <span className="text-slate-600">|</span>
                                        <span className="text-sm text-slate-400">{LANGUAGES.find(l=>l.code===selectedLanguage)?.label}</span>
                                    </div>
                                </div>

                                {/* ── 甲方/乙方身份选择 ── */}
                                <div className="glass-card p-8">
                                    <div className="flex items-center gap-3 mb-4">
                                        <i data-lucide="users" className="w-5 h-5 text-blue-400"></i>
                                        <h3 className="text-base font-black text-white">您在本合同中的身份</h3>
                                        <span className="text-xs text-slate-500 ml-1">（影响风险审查视角与谈判策略）</span>
                                    </div>
                                    <div className="party-selector w-full md:w-max mb-6">
                                        <button
                                            type="button"
                                            className={`party-btn ${partyRole === 'partyA' ? 'active-a' : ''}`}
                                            onClick={(e) => { e.preventDefault(); setPartyRole('partyA'); }}
                                        >
                                            <i data-lucide="building-2" className="w-4 h-4"></i>
                                            <div className="text-left">
                                                <div className="leading-none">我是甲方</div>
                                                <div className="text-[10px] opacity-60 font-normal mt-1">发起方/提供者</div>
                                            </div>
                                        </button>
                                        
                                        <button
                                            type="button"
                                            className={`party-btn ${partyRole === 'partyB' ? 'active-b' : ''}`}
                                            onClick={(e) => { e.preventDefault(); setPartyRole('partyB'); }}
                                        >
                                            <i data-lucide="user" className="w-4 h-4"></i>
                                            <div className="text-left">
                                                <div className="leading-none">我是乙方</div>
                                                <div className="text-[10px] opacity-60 font-normal mt-1">接受方/签署者</div>
                                            </div>
                                        </button>
                                    </div>

                                    <div className={`party-role-banner ${partyRole === 'partyA' ? 'party-a' : 'party-b'}`}>
                                        <div className={`party-badge ${partyRole === 'partyA' ? 'party-badge-a' : 'party-badge-b'}`}>
                                            <i data-lucide={partyRole === 'partyA' ? 'building-2' : 'user'} className="w-3 h-3"></i>
                                            {partyRole === 'partyA' ? '甲方视角' : '乙方视角'}
                                        </div>
                                        <span className="text-sm text-slate-300">
                                            {partyRole === 'partyA'
                                                ? 'AI 将重点识别对甲方不利的条款、您的违约风险，以及乙方可能利用的漏洞，并从甲方立场生成谈判策略。'
                                                : 'AI 将重点识别甲方强加给乙方的苛刻条款、不对等责任条款，并从乙方立场生成维权策略、保障您的权益。'
                                            }
                                        </span>
                                    </div>
                                </div>
                                <div
                                    className={`upload-zone glass-card p-14 text-center border-2 cursor-pointer group shadow-2xl ${isDragOver ? 'drag-over' : 'border-white/8 hover:border-indigo-500/35'}`}
                                    onClick={() => document.getElementById('fileInput').click()}
                                    onDragOver={e => { e.preventDefault(); setIsDragOver(true); }}
                                    onDragLeave={() => setIsDragOver(false)}
                                    onDrop={handleDrop}
                                >
                                    <input id="fileInput" type="file" multiple className="hidden"
                                        accept=".pdf,.docx,.txt,.png,.jpg,.jpeg,.webp,.bmp"
                                        onChange={e => handleFileUpload(e.target.files)} />
                                    <div className="mb-6">
                                        <div className="w-20 h-20 mx-auto rounded-3xl flex items-center justify-center group-hover:scale-110 transition-transform duration-500 relative"
                                            style={{background: 'linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.15))', border: '1.5px solid rgba(99,102,241,0.35)', boxShadow: '0 0 40px rgba(99,102,241,0.1)'}}>
                                            <i data-lucide="upload-cloud" className="w-9 h-9 text-blue-400"></i>
                                            <div className="absolute -top-1.5 -right-1.5 w-6 h-6 rounded-full flex items-center justify-center text-[10px] text-green-300 font-black"
                                                style={{background:'linear-gradient(135deg,rgba(16,185,129,0.3),rgba(5,150,105,0.3))', border:'1px solid rgba(16,185,129,0.4)'}}>+</div>
                                        </div>
                                    </div>
                                    <h3 className="text-2xl font-bold mb-2 text-white">{t('upload_title')}</h3>
                                    <p className="text-slate-500 text-sm uppercase tracking-widest mb-3">{t('upload_formats')}</p>
                                    <div className="inline-flex gap-3 text-xs text-slate-500">
                                        <span className="px-3 py-1 rounded-full bg-white/5 border border-white/10">{t('upload_ocr_tip')}</span>
                                        <span className="px-3 py-1 rounded-full bg-white/5 border border-white/10">{t('upload_max', FILE_MAX_CHARS)}</span>
                                    </div>
                                </div>

                                <div className="relative flex items-center gap-4 text-slate-500">
                                    <div className="flex-1 h-px bg-white/5"></div>
                                    <span className="text-xs font-black uppercase tracking-widest">{t('or_paste')}</span>
                                    <div className="flex-1 h-px bg-white/5"></div>
                                </div>

                                {/* 文本输入区 */}
                                <div className="glass-card p-8">
                                    <textarea
                                        id="txtArea"
                                        value={contractText}
                                        onChange={e => {
                                            const v = e.target.value.substring(0, MAX_CHARACTERS);
                                            setContractText(v);
                                            // 自动分类检测（文字超过 200 字后触发）
                                            if (v.length > 200) {
                                                const detected = autoDetectCategory(v);
                                                setAutoDetected(detected !== selectedCategory ? detected : null);
                                            } else {
                                                setAutoDetected(null);
                                            }
                                        }}
                                        className="w-full h-64 bg-white/5 border border-white/10 rounded-2xl p-5 focus:ring-2 focus:ring-blue-500/30 focus:border-transparent text-base text-slate-200 placeholder:text-slate-500 resize-none scrollbar-thin leading-relaxed font-mono"
                                        placeholder={t('textarea_placeholder')}
                                        style={{ lineHeight: '1.8', whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}
                                    />

                                    {/* 字符条 */}
                                    <div className="mt-3 space-y-1">
                                        <div className="w-full h-1.5 bg-white/5 rounded-full overflow-hidden">
                                            <div
                                                className={`char-bar-fill h-full rounded-full ${getCharBarClass(currentLength)}`}
                                                style={{ width: `${charBarWidth}%` }}
                                            ></div>
                                        </div>
                                        <div className="flex justify-between text-xs">
                                            <span className="text-slate-500">{t('min_chars', MIN_CHARACTERS)}</span>
                                            <span className={currentLength > MAX_CHARACTERS ? 'text-red-400 font-bold' : currentLength < MIN_CHARACTERS ? 'text-slate-500' : 'text-green-400 font-bold'}>
                                                {t('chars_info', currentLength, MAX_CHARACTERS)}
                                                {currentLength < MIN_CHARACTERS && t('chars_need_more', MIN_CHARACTERS - currentLength)}
                                                {currentLength > MAX_CHARACTERS && t('chars_over')}
                                                {currentLength >= MIN_CHARACTERS && currentLength <= MAX_CHARACTERS && t('chars_ok')}
                                            </span>
                                        </div>
                                    </div>

                                    {/* 自动分类检测提示 */}
                                    {autoDetected && (
                                        <div className="auto-detect-bar mt-3 flex items-center justify-between gap-3">
                                            <div className="flex items-center gap-2 text-sm">
                                                <span className="text-amber-400">🤖</span>
                                                <span className="text-slate-300">检测到合同内容更匹配</span>
                                                <span className="font-black text-amber-400">【{autoDetected}】</span>
                                            </div>
                                            <button
                                                onClick={() => { setSelectedCategory(autoDetected); setAutoDetected(null); }}
                                                className="px-4 py-1.5 rounded-xl text-xs font-black text-amber-400 bg-amber-500/15 border border-amber-500/25 hover:bg-amber-500/25 transition-all">
                                                切换分类 →
                                            </button>
                                        </div>
                                    )}

                                    <button
                                        onClick={() => { setExtractedText(contractText); setStep('analyzing'); startPollingAI(contractText); }}
                                        disabled={!isTextValid}
                                        className={`w-full mt-6 py-5 rounded-3xl font-black text-xl transition-all ${isTextValid ? 'bg-gradient-to-r from-blue-600 to-violet-600 hover:from-blue-500 hover:to-violet-500 shadow-xl shadow-blue-900/30 hover:shadow-blue-800/40' : 'bg-slate-700 text-slate-500 cursor-not-allowed opacity-60'}`}
                                    >
                                        {isTextValid ? t('start_review') : t('input_first')}
                                    </button>
                                    {isTextValid && (
                                        <div className="flex items-center justify-center gap-2 mt-2 text-xs text-slate-600">
                                            <kbd className="kbd">Ctrl</kbd><span>+</span><kbd className="kbd">↵</kbd>
                                            <span>快捷启动分析</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* ══════════════════════════════════════════════════ */}
                        {/* 步骤 3: 分析中                                      */}
                        {/* ══════════════════════════════════════════════════ */}
                        {step === 'analyzing' && (
                            <div className="text-center py-24 glass-card max-w-3xl mx-auto animate-up p-12">
                                {/* 旋转环动画 */}
                                <div className="relative w-32 h-32 mx-auto mb-10">
                                    <div className="pulse-ring"></div>
                                    <div className="pulse-ring" style={{ animationDelay: '0.5s' }}></div>
                                    <div className="pulse-ring" style={{ animationDelay: '1s' }}></div>
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <div className="w-20 h-20 rounded-full bg-blue-600/20 border border-blue-500/30 flex items-center justify-center"
                                            style={{boxShadow: '0 0 40px rgba(59,130,246,0.2)'}}>
                                            <i data-lucide="scale" className="w-10 h-10 text-blue-400"></i>
                                        </div>
                                    </div>
                                </div>

                                <h2 className="text-2xl font-bold mb-1 gradient-text">{progress || '...'}</h2>
                                <p className="text-slate-500 text-sm mb-5">{t('analyzing_subtitle')}</p>

                                {/* 进度条 */}
                                <div className="w-full max-w-sm mx-auto h-1.5 bg-white/5 rounded-full overflow-hidden mb-6">
                                    <div className="h-full rounded-full progress-bar"
                                        style={{
                                            width: `${Math.max(5, progressStage * 25)}%`,
                                            background: 'linear-gradient(90deg, #3b82f6, #8b5cf6, #f472b6)',
                                            transition: 'width 0.8s ease-in-out'
                                        }}></div>
                                </div>

                                {ocrStatus && (
                                    <div className="inline-flex items-center gap-2 text-sm text-amber-400 mb-4 px-4 py-2 bg-amber-500/10 rounded-full border border-amber-500/20">
                                        <i data-lucide="cpu" className="w-4 h-4"></i> {ocrStatus}
                                    </div>
                                )}

                                <ProgressStepper />

                                {/* ★ v4.0: 辩论仲裁加载指示器 */}
                                {(progress || '').includes('辩论') || (progress || '').includes('仲裁') ? (
                                    <div className="mt-6 mx-auto max-w-sm">
                                        <div className="debate-summary-bar justify-center gap-3 mb-3">
                                            <div className="debate-thinking">
                                                <div className="dot"></div>
                                                <div className="dot"></div>
                                                <div className="dot"></div>
                                                <span style={{fontSize:'0.7rem'}}>三方辩论进行中</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center justify-center gap-3 text-xs">
                                            <span className="px-2 py-1 rounded-lg" style={{background:'rgba(59,130,246,0.1)',color:'#60a5fa',border:'1px solid rgba(59,130,246,0.2)'}}>⚖ 甲方律师</span>
                                            <span className="text-slate-700">vs</span>
                                            <span className="px-2 py-1 rounded-lg" style={{background:'rgba(239,68,68,0.1)',color:'#f87171',border:'1px solid rgba(239,68,68,0.2)'}}>⚖ 乙方律师</span>
                                            <span className="text-slate-700">→</span>
                                            <span className="px-2 py-1 rounded-lg" style={{background:'rgba(245,158,11,0.1)',color:'#d97706',border:'1px solid rgba(245,158,11,0.2)'}}>🔨 仲裁官</span>
                                        </div>
                                    </div>
                                ) : null}

                                {/* ── 快速预扫描结果（分析等待期间展示）── */}
                                {quickScanResult && (
                                    <div className="quick-scan-card mt-8 text-left max-w-lg mx-auto">
                                        <div className="flex items-center gap-2 mb-3">
                                            <div className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                                            <span className="text-xs font-black text-emerald-400 uppercase tracking-widest">快速预扫描完成</span>
                                            {quickScanResult._party_label && (
                                                <span className={`party-badge ml-1 ${quickScanResult._party_role === 'partyA' ? 'party-badge-a' : 'party-badge-b'}`}>
                                                    {quickScanResult._party_label}视角
                                                </span>
                                            )}
                                            {quickScanResult._law_doc_count > 0 && (
                                                <span className="text-xs text-slate-500 ml-auto">参考 {quickScanResult._law_doc_count} 条法规</span>
                                            )}
                                        </div>
                                        <div className="flex items-center gap-4 mb-3">
                                            <div className="text-3xl font-black" style={{ color: quickScanResult.quickScore >= 70 ? '#ef4444' : quickScanResult.quickScore >= 45 ? '#fbbf24' : '#10b981' }}>
                                                {quickScanResult.quickScore}
                                            </div>
                                            <div>
                                                <div className="font-black text-white text-sm">{quickScanResult.contractType}</div>
                                                <div className="text-xs text-slate-400">{quickScanResult.quickRiskLevel} 风险</div>
                                            </div>
                                        </div>
                                        {(quickScanResult.topThreats || []).map((t, i) => (
                                            <div key={i} className="flex items-start gap-2 text-xs text-slate-400 mb-1">
                                                <span className="text-red-400 font-black shrink-0 mt-0.5">⚠</span>
                                                <span>{t.title}</span>
                                            </div>
                                        ))}
                                        {quickScanResult.quickTip && (
                                            <div className="mt-2 pt-2 border-t border-white/5 text-xs text-emerald-400 italic">
                                                💡 {quickScanResult.quickTip}
                                            </div>
                                        )}
                                        <div className="text-xs text-slate-600 mt-2">完整深度分析仍在进行中...</div>
                                    </div>
                                )}

                                <button onClick={cancelAnalysis} className="mt-10 px-10 py-3.5 glass-card border-red-500/30 text-red-400 font-black hover:bg-red-500/10 transition-all mx-auto flex items-center gap-2 mx-auto">
                                    <i data-lucide="x-circle" className="w-4 h-4"></i> {t('cancel_btn')}
                                </button>
                            </div>
                        )}

                        {/* ══════════════════════════════════════════════════ */}
                        {/* 步骤 4: 分析结果                                    */}
                        {/* ══════════════════════════════════════════════════ */}
                        {step === 'results' && analysisResult && (
                            <div className="space-y-8 animate-up">

                                {/* 概览头部 */}
                                <div className="grid lg:grid-cols-4 gap-6">
                                    <div className="lg:col-span-3 glass-card p-10 flex flex-col md:flex-row items-center gap-10">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-4 flex-wrap">
                                                <div className="text-xs font-black uppercase tracking-widest text-blue-400 px-3 py-1 bg-blue-500/10 rounded-full border border-blue-500/20">{getCatName(selectedCategory)}</div>
                                                {/* ★ 甲方/乙方角色标识 */}
                                                {analysisResult._party_label && (
                                                    <div className={`party-badge ${analysisResult._party_role === 'partyA' ? 'party-badge-a' : 'party-badge-b'}`}
                                                        title={`本次分析以${analysisResult._party_label}视角进行`}>
                                                        <i data-lucide={analysisResult._party_role === 'partyA' ? 'building-2' : 'user'} className="w-3 h-3"></i>
                                                        {analysisResult._party_label}视角分析
                                                    </div>
                                                )}
                                                {analysisResult._cached && (
                                                    <div className="cache-hit-badge">
                                                        ⚡ 缓存极速返回
                                                        {analysisResult._cache_hits > 1 && <span className="opacity-60"> ×{analysisResult._cache_hits}</span>}
                                                    </div>
                                                )}
                                                {analysisResult._law_doc_count > 0 && (
                                                    <div className="law-source-badge">
                                                        <i data-lucide="book-open" className="w-3 h-3"></i>
                                                        基于 {analysisResult._law_doc_count} 条法规
                                                    </div>
                                                )}
                                                {/* ★ 增强 A: 多模型审查团 */}
                                                {analysisResult._models_used && analysisResult._models_used.length > 0 && (
                                                    <div className="model-panel-badge">
                                                        <i data-lucide="users" className="w-3 h-3"></i>
                                                        {t('multi_model_panel', analysisResult._models_used.length)}
                                                    </div>
                                                )}
                                                {/* ★ 增强 A v4.0: 辩论仲裁模式 */}
                                                {analysisResult._debate_enabled && analysisResult._debate_summary && (
                                                    <div className="debate-mode-badge"
                                                        title={`辩论 ${analysisResult._debate_summary.debated_count} 个议题：升级 ${analysisResult._debate_summary.upgrades}，降级 ${analysisResult._debate_summary.downgrades}，维持 ${analysisResult._debate_summary.maintained}`}>
                                                        <i data-lucide="scale" className="w-3 h-3"></i>
                                                        {t('debate_mode_badge')}
                                                        <span className="text-amber-600 ml-0.5">
                                                            {analysisResult._debate_summary.debated_count}题
                                                        </span>
                                                    </div>
                                                )}
                                                {/* ★ 增强 B: 知识库更新日期 */}
                                                {analysisResult._kb_updated_at && analysisResult._kb_updated_at !== '未知' && (
                                                    <div className="law-source-badge" title="知识库最后更新时间">
                                                        <i data-lucide="database" className="w-3 h-3"></i>
                                                        {t('kb_updated', analysisResult._kb_updated_at.slice(0,10))}
                                                    </div>
                                                )}
                                                {/* ★ 增强 B: 文档类型分布芯片 */}
                                                {analysisResult._doc_type_summary && Object.entries(analysisResult._doc_type_summary).map(([dtype, cnt]) => (
                                                    <span key={dtype} className={`doc-type-chip doc-type-${dtype}`}>{dtype} ×{cnt}</span>
                                                ))}
                                            </div>

                                            {/* ★ 增强 C: 高风险律师审查建议横幅 */}
                                            {analysisResult._lawyer_review_suggested && lawyerReviewStatus === 'idle' && (
                                                <div className="lawyer-review-banner mb-5">
                                                    <div className="banner-icon">
                                                        <i data-lucide="scale" className="w-5 h-5 text-amber-400"></i>
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-sm font-black text-amber-400">{t('lawyer_review_suggest', analysisResult.riskScore)}</div>
                                                        <div className="text-xs text-slate-400 mt-0.5">专业律师将为您提供人工审核，降低法律风险</div>
                                                    </div>
                                                    <button className="lawyer-review-btn" onClick={() => setShowLawyerModal(true)}>
                                                        <i data-lucide="user-check" className="w-4 h-4"></i>
                                                        {t('request_lawyer_review')}
                                                    </button>
                                                </div>
                                            )}
                                            {lawyerReviewStatus === 'requested' && (
                                                <div className="lawyer-review-banner mb-5" style={{borderColor:'rgba(16,185,129,0.25)',background:'rgba(16,185,129,0.04)'}}>
                                                    <div className="banner-icon" style={{background:'rgba(16,185,129,0.12)',borderColor:'rgba(16,185,129,0.25)'}}>
                                                        <i data-lucide="check-circle" className="w-5 h-5 text-emerald-400"></i>
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="text-sm font-black text-emerald-400">{t('lawyer_review_requested')}</div>
                                                        <div className="text-xs text-slate-400 mt-0.5">审查编号：{lawyerReviewId} · 可在「个人中心 → 审查记录」查看进度</div>
                                                    </div>
                                                </div>
                                            )}
                                            <h2 className="text-4xl font-black mb-3 text-white tracking-tighter">{analysisResult.contractType}</h2>
                                            <div className="flex items-center gap-3 text-slate-400 text-base mb-6">
                                                <i data-lucide="landmark" className="w-5 h-5 text-blue-500"></i>
                                                {analysisResult.jurisdiction}
                                            </div>
                                            <div className="p-6 bg-white/5 border border-white/5 rounded-3xl italic text-slate-300 text-lg leading-relaxed">
                                                " {analysisResult.summary} "
                                            </div>
                                        </div>
                                        <RiskMeter score={analysisResult.riskScore} />
                                    </div>
                                    <div className={`${getRiskColor(analysisResult.overallRisk)} p-10 rounded-[3rem] flex flex-col justify-center items-center shadow-2xl relative overflow-hidden group hover-lift`}>
                                        <div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                                        <span className="text-xs font-black uppercase tracking-[0.4em] mb-4 opacity-70">{t('overall_risk')}</span>
                                        <h3 className="text-4xl font-black text-center mb-4">{analysisResult.overallRisk.toUpperCase()}</h3>
                                        <div className="text-3xl font-black opacity-80">{analysisResult.issues.length}</div>
                                        <div className="text-xs opacity-60 mb-6">{t('risk_clauses_label')}</div>
                                        <div className="flex gap-2">
                                            <button onClick={downloadReport} className="px-5 py-2 bg-black/20 hover:bg-black/40 rounded-full text-xs font-black transition-all flex items-center gap-1.5">
                                                <i data-lucide="download" className="w-3.5 h-3.5"></i> {t('export_report')}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* 标签栏 */}
                                <div className="flex flex-wrap gap-3 glass-card p-4 w-max">
                                    {[
                                        { id: '合同总览', label: t('tab_overview'),    icon: 'file-text'    },
                                        { id: '风险细节', label: t('tab_risks'),       icon: 'shield-alert' },
                                        { id: '谈判建议', label: t('tab_negotiation'), icon: 'trending-up'  },
                                        { id: '修订合同', label: t('tab_revised'),     icon: 'file-check-2' },
                                        ...(analysisResult.caseAnalysis ? [{ id: '案例分析', label: t('tab_cases') || '案例分析', icon: 'landmark' }] : []),
                                        { id: '律师审查', label: t('tab_lawyer') || '律师审查', icon: 'user-check' },
                                        ...(analysisResult._debate_enabled ? [{ id: '辩论记录', label: t('tab_debate') || '辩论记录', icon: 'scale' }] : []),
                                    ].map(tab => (
                                        <button key={tab.id}
                                            onClick={() => { setActiveTab(tab.id); setTimeout(() => lucide.createIcons(), 50); }}
                                            className={`px-8 py-4 rounded-[1.25rem] font-bold flex items-center gap-3 transition-all ${activeTab === tab.id ? 'tab-btn-active' : 'hover:bg-white/5 text-slate-400'}`}>
                                            <i data-lucide={tab.icon} className="w-4 h-4"></i> {tab.label}
                                            {tab.id === '修订合同' && analysisResult.revisedContract && (
                                                <span className="ml-1 px-1.5 py-0.5 bg-green-500 text-white text-[9px] font-black rounded-full uppercase tracking-wider">NEW</span>
                                            )}
                                            {tab.id === '案例分析' && (
                                                <span className="ml-1 px-1.5 py-0.5 bg-amber-500 text-white text-[9px] font-black rounded-full">AI</span>
                                            )}
                                            {tab.id === '辩论记录' && (
                                                <span className="ml-1 px-1.5 py-0.5 text-[9px] font-black rounded-full text-amber-900"
                                                    style={{background:'linear-gradient(135deg,#f59e0b,#ef4444)'}}>⚖</span>
                                            )}
                                            {tab.id === '律师审查' && lawyerReviewStatus === 'requested' && (
                                                <span className="ml-1 w-2 h-2 bg-emerald-500 rounded-full inline-block"></span>
                                            )}
                                        </button>
                                    ))}
                                </div>

                                {/* ─── 合同总览 ─── */}
                                {activeTab === '合同总览' && (
                                    <div className="grid lg:grid-cols-3 gap-8 h-[820px]">
                                        <div className="lg:col-span-2 h-full overflow-hidden">
                                            <div className="text-view-box scrollbar-thin h-full overflow-y-auto text-sm">
                                                {renderHighlightedText()}
                                            </div>
                                        </div>
                                        <div className="h-full overflow-y-auto pr-2 scrollbar-thin space-y-5">
                                            <MiniDashboard />
                                            <div>
                                                <h3 className="text-base font-bold flex items-center gap-2 text-orange-400 px-2 mb-3">
                                                    <i data-lucide="list" className="w-4 h-4"></i>
                                                    {t('core_threats', analysisResult.issues.length)}
                                                </h3>
                                                <div className="space-y-3 pb-4">
                                                    {analysisResult.issues.map(iss => (
                                                        <div key={iss.id}
                                                            onClick={() => { setSelectedIssue(iss); setActiveTab('风险细节'); }}
                                                            className="p-5 glass-card border-white/5 hover:border-blue-500/50 transition-all cursor-pointer group hover-lift"
                                                        >
                                                            <div className="flex items-center gap-3 mb-1">
                                                                <div className={`w-2.5 h-2.5 rounded-full shrink-0 ${getRiskColor(iss.severity)}`}></div>
                                                                <span className="text-[10px] font-black uppercase text-slate-500">{iss.severity}</span>
                                                                {/* ★ 增强 A: 模型置信度小徽章 */}
                                                                {iss.confidence_score != null && (
                                                                    <span className={`confidence-badge ml-auto ${iss.confidence_score >= 0.7 ? 'confidence-high' : iss.confidence_score >= 0.4 ? 'confidence-medium' : 'confidence-low'}`}>
                                                                        {Math.round(iss.confidence_score * 100)}%
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <div className="font-bold text-sm text-slate-200 group-hover:text-blue-400 leading-snug">{iss.title}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* ─── 风险细节 ─── */}
                                {activeTab === '风险细节' && (
                                    <div className="grid lg:grid-cols-4 gap-8 h-[820px]">
                                        <div className="lg:col-span-1 glass-card p-5 space-y-3 overflow-y-auto scrollbar-thin">
                                            {analysisResult.issues.map(iss => (
                                                <div key={iss.id}
                                                    onClick={() => setSelectedIssue(iss)}
                                                    className={`p-4 rounded-2xl cursor-pointer transition-all border-l-[6px] ${selectedIssue?.id === iss.id ? getRiskColor(iss.severity) + ' border-transparent shadow-lg' : 'glass-card-light opacity-50 hover:opacity-100'}`}
                                                    style={{ borderColor: selectedIssue?.id === iss.id ? 'transparent' : getRiskHex(iss.severity) + '60' }}
                                                >
                                                    <div className="text-[11px] font-black uppercase mb-1 opacity-80">{iss.severity}</div>
                                                    <div className="font-bold text-sm leading-snug">{iss.title}</div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="lg:col-span-3 glass-card p-12 overflow-y-auto scrollbar-thin">
                                            {selectedIssue && (
                                                <div className="space-y-10 animate-fade">
                                                    <div className="flex items-center gap-6 flex-wrap">
                                                        <div className={`w-16 h-16 rounded-[1.5rem] flex items-center justify-center shrink-0 ${getRiskColor(selectedIssue.severity)}`}>
                                                            <i data-lucide="eye" className="w-8 h-8"></i>
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <h2 className="text-2xl font-black text-white leading-tight mb-2">{selectedIssue.title}</h2>
                                                            {/* ★ 增强 A: 置信度 + 模型共识徽章 */}
                                                            <div className="flex items-center gap-2 flex-wrap">
                                                                {selectedIssue.confidence_score != null && (
                                                                    <span className={`confidence-badge ${selectedIssue.confidence_score >= 0.7 ? 'confidence-high' : selectedIssue.confidence_score >= 0.4 ? 'confidence-medium' : 'confidence-low'}`}>
                                                                        <i data-lucide="shield-check" className="w-3 h-3"></i>
                                                                        {t('confidence_label')} {Math.round(selectedIssue.confidence_score * 100)}%
                                                                    </span>
                                                                )}
                                                                {selectedIssue.model_agreement && (
                                                                    <span className={`consensus-badge ${
                                                                        selectedIssue.model_agreement === '全部裁定' || selectedIssue.model_agreement === '全部一致' ? 'consensus-all' :
                                                                        selectedIssue.model_agreement === '部分争议' || selectedIssue.model_agreement === '多数认同' ? 'consensus-most' :
                                                                        'consensus-single'
                                                                    }`}>
                                                                        <i data-lucide={selectedIssue._debated ? 'scale' : 'users'} className="w-3 h-3"></i>
                                                                        {selectedIssue.model_agreement}
                                                                    </span>
                                                                )}
                                                                {/* ★ v4.0: 仲裁裁定调整徽章 */}
                                                                {selectedIssue._debated && selectedIssue._arbitrator_verdict && (
                                                                    <span className={`verdict-badge ${
                                                                        selectedIssue._arbitrator_verdict.severity_adjustment === '升级' ? 'verdict-upgraded' :
                                                                        selectedIssue._arbitrator_verdict.severity_adjustment === '降级' ? 'verdict-downgraded' :
                                                                        'verdict-maintained'
                                                                    }`}>
                                                                        {selectedIssue._arbitrator_verdict.severity_adjustment === '升级' ? '↑ 仲裁升级' :
                                                                         selectedIssue._arbitrator_verdict.severity_adjustment === '降级' ? '↓ 仲裁降级' :
                                                                         '= 仲裁维持'}
                                                                        {selectedIssue._original_severity && selectedIssue._original_severity !== selectedIssue.severity && (
                                                                            <span className="opacity-60 ml-1">{selectedIssue._original_severity}→{selectedIssue.severity}</span>
                                                                        )}
                                                                    </span>
                                                                )}
                                                                {selectedIssue.models_flagged && selectedIssue.models_flagged.length > 0 && (
                                                                    <span className="text-[10px] text-slate-600 font-mono">
                                                                        {selectedIssue._debated ? '⚖ ' : ''}by {selectedIssue.models_flagged.join(' · ')}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            {/* ★ v4.0: 仲裁调整原因（简短内嵌） */}
                                                            {selectedIssue._debated && selectedIssue._arbitrator_verdict?.adjustment_reason && (
                                                                <div className="mt-2 text-xs text-amber-500/80 italic">
                                                                    仲裁官：{selectedIssue._arbitrator_verdict.adjustment_reason}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* 原文 */}
                                                    <div className="p-8 bg-amber-500/20 rounded-[2rem] border border-amber-500/15">
                                                        <div className="flex items-center justify-between mb-4">
                                                            <span className="font-black text-amber-500 flex items-center gap-2 text-base">
                                                                <i data-lucide="quote" className="w-4 h-4"></i> {t('original_clause')}
                                                            </span>
                                                            {selectedIssue.clauseText && (
                                                                <button
                                                                    onClick={() => copyToClipboard(selectedIssue.clauseText, `clause-${selectedIssue.id}`)}
                                                                    className={`copy-micro ${copiedField === `clause-${selectedIssue.id}` ? 'copied' : ''}`}>
                                                                    {copiedField === `clause-${selectedIssue.id}` ? '✓ 已复制' : '复制原文'}
                                                                </button>
                                                            )}
                                                        </div>
                                                        <div className="text-slate-200 text-base leading-relaxed font-mono"
                                                            dangerouslySetInnerHTML={{ __html: (selectedIssue.clauseText||'').replace(/\n/g,'<br/>') }}/>
                                                    </div>

                                                    {/* 法律依据 */}
                                                    <div className="p-8 bg-blue-500/20 rounded-[2rem] border border-blue-500/15">
                                                        <div className="flex items-center justify-between mb-4">
                                                            <h4 className="font-black text-blue-400 flex items-center gap-2 text-base">
                                                                <i data-lucide="gavel" className="w-4 h-4"></i> {t('legal_basis')}
                                                            </h4>
                                                            {selectedIssue.lawReference && selectedIssue.lawReference !== '—' && (
                                                                <button
                                                                    onClick={() => copyToClipboard(selectedIssue.lawReference, `law-${selectedIssue.id}`)}
                                                                    className={`copy-micro ${copiedField === `law-${selectedIssue.id}` ? 'copied' : ''}`}>
                                                                    {copiedField === `law-${selectedIssue.id}` ? '✓ 已复制' : '复制法条'}
                                                                </button>
                                                            )}
                                                        </div>
                                                        <div className="text-slate-200 text-base leading-relaxed font-mono"
                                                            dangerouslySetInnerHTML={{ __html: (selectedIssue.lawReference||'根据相关法律法规').replace(/\n/g,'<br/>') }}/>
                                                    </div>

                                                    {/* 问题 & 建议 */}
                                                    <div className="grid md:grid-cols-2 gap-8">
                                                        <div className={`p-8 glass-card border-t-[8px] shadow-xl ${getBorderColor(selectedIssue.severity)}`}>
                                                            <h4 className="font-black text-red-400 mb-4 flex items-center gap-2 text-base">{t('problem_title')}</h4>
                                                            <div className="text-slate-300 text-base leading-relaxed"
                                                                dangerouslySetInnerHTML={{ __html: (selectedIssue.problem||'').replace(/\n/g,'<br/>') }}/>
                                                        </div>
                                                        <div className="p-8 glass-card border-t-[8px] border-green-500 shadow-xl">
                                                            <h4 className="font-black text-green-400 mb-4 flex items-center gap-2 text-base">{t('action_title')}</h4>
                                                            <ul className="space-y-2">
                                                                {(selectedIssue.whatToDo||[]).map((a, i) => (
                                                                    <li key={i} className="text-slate-300 text-sm flex items-start gap-2">
                                                                        <svg className="text-green-500 w-4 h-4 mt-0.5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
                                                                        <span>{a}</span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    </div>

                                                    {/* 修订建议 */}
                                                    <div className="p-10 bg-blue-500/5 rounded-[2.5rem] border border-blue-500/15">
                                                        <div className="flex items-center justify-between mb-4">
                                                            <h4 className="font-black text-blue-400 flex items-center gap-2 text-base">
                                                                <i data-lucide="pen-line" className="w-4 h-4"></i> {t('revision_suggestion')}
                                                            </h4>
                                                            {selectedIssue.alternative && selectedIssue.alternative !== '—' && (
                                                                <button
                                                                    onClick={() => copyToClipboard(selectedIssue.alternative, `alt-${selectedIssue.id}`)}
                                                                    className={`copy-micro ${copiedField === `alt-${selectedIssue.id}` ? 'copied' : ''}`}>
                                                                    {copiedField === `alt-${selectedIssue.id}` ? '✓ 已复制' : '复制条款'}
                                                                </button>
                                                            )}
                                                        </div>
                                                        <p className="text-slate-100 text-base font-serif italic leading-relaxed">{selectedIssue.alternative}</p>
                                                    </div>

                                                    {/* 通俗解释 */}
                                                    {(selectedIssue.plainLanguage||[]).length > 0 && (
                                                        <div className="p-8 bg-purple-500/5 rounded-[2rem] border border-purple-500/15">
                                                            <h4 className="font-black text-purple-400 mb-4 flex items-center gap-2 text-base">
                                                                <i data-lucide="message-circle" className="w-4 h-4"></i> {t('plain_explanation')}
                                                            </h4>
                                                            <ul className="space-y-2">
                                                                {selectedIssue.plainLanguage.map((p, i) => (
                                                                    <li key={i} className="text-slate-300 text-sm flex items-start gap-2">
                                                                        <span className="text-purple-400 font-black shrink-0">→</span>
                                                                        <span>{p}</span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {/* ─── 谈判建议 ─── */}
                                {activeTab === '谈判建议' && (
                                    <div className="h-[820px] overflow-y-auto scrollbar-thin pr-2 pb-10">
                                        <div className="space-y-10 max-w-5xl mx-auto">

                                            {/* 博弈全局观 */}
                                            <div className="glass-card p-14 border-blue-500/10 shadow-2xl relative overflow-hidden">
                                                <div className="absolute -top-40 -right-40 w-80 h-80 bg-blue-500/5 blur-[100px] rounded-full pointer-events-none"></div>
                                                <h3 className="text-2xl font-black text-blue-400 mb-8 flex items-center gap-4">
                                                    <i data-lucide="target" className="w-8 h-8"></i> {t('game_overview')}
                                                </h3>
                                                <p className="text-xl text-slate-100 leading-tight font-serif border-l-[10px] border-blue-500 pl-10">{analysisResult.negotiation.strategy}</p>
                                            </div>

                                            {/* 快速导航 */}
                                            <div className="glass-card p-6 flex flex-wrap gap-3">
                                                <button onClick={() => document.getElementById('talk-track-section').scrollIntoView({ behavior: 'smooth' })}
                                                    className="px-6 py-2.5 rounded-full text-sm font-black bg-purple-500/10 text-purple-400 hover:bg-purple-500/20 border border-purple-500/20 transition-all">
                                                    <i data-lucide="mic" className="w-4 h-4 inline-block mr-2"></i>{t('quick_nav_call')}
                                                </button>
                                                <button onClick={() => document.getElementById('email-section').scrollIntoView({ behavior: 'smooth' })}
                                                    className="px-6 py-2.5 rounded-full text-sm font-black bg-indigo-500/10 text-indigo-400 hover:bg-indigo-500/20 border border-indigo-500/20 transition-all">
                                                    <i data-lucide="mail" className="w-4 h-4 inline-block mr-2"></i>{t('quick_nav_email')}
                                                </button>
                                            </div>

                                            {/* 电话面谈脚本 */}
                                            <div id="talk-track-section" className="glass-card p-10 space-y-8 shadow-xl">
                                                <h3 className="text-xl font-bold text-orange-400 flex items-center gap-3">
                                                    <i data-lucide="mic" className="w-5 h-5"></i> {t('call_script')}
                                                </h3>
                                                <div className="space-y-6">
                                                    <div>
                                                        <span className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-3">{t('opening_label')}</span>
                                                        <p className="italic text-slate-100 text-xl font-serif leading-relaxed border-l-4 border-orange-500 pl-6">" {analysisResult.negotiation.talkTrack.opening} "</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-3">{t('key_reasons_label')}</span>
                                                        <ul className="space-y-4">
                                                            {(analysisResult.negotiation.talkTrack.reasons||[]).map((r, i) => (
                                                                <li key={i} className="text-slate-300 text-lg flex gap-4 leading-relaxed">
                                                                    <i data-lucide="chevron-right" className="text-orange-500 w-5 h-5 shrink-0 mt-1"></i>
                                                                    {r}
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 多风格策略 */}
                                            <div className="space-y-6">
                                                <h3 className="text-2xl font-bold text-white flex items-center gap-3">
                                                    <i data-lucide="layers" className="w-6 h-6"></i> {t('style_strategies')}
                                                </h3>
                                                {[
                                                    { key: 'aggressive',   label: t('style_aggressive'),   color: 'red',   },
                                                    { key: 'consultative', label: t('style_consultative'), color: 'blue',  },
                                                    { key: 'compromise',   label: t('style_compromise'),   color: 'green', },
                                                ].map(({ key, label, color }) => (
                                                    <div key={key} className={`w-full p-8 glass-card border-t-[6px] shadow-xl bg-${color}-500/5 flex gap-6`}
                                                        style={{ borderTopColor: `var(--tw-shadow-color, ${color === 'red' ? '#ef4444' : color === 'blue' ? '#3b82f6' : '#10b981'})` }}>
                                                        <div className="w-40 shrink-0 flex flex-col gap-3">
                                                            <span className={`text-sm font-black text-${color}-400 uppercase tracking-widest`}>{label}</span>
                                                            <button
                                                                onClick={async () => { await navigator.clipboard.writeText(analysisResult.negotiation.styles[key]); setCopyTip(t('copied_btn')); setCopyTipType(key); setTimeout(() => setCopyTip(''), 2000); }}
                                                                className={`px-3 py-1.5 bg-${color}-500/15 text-${color}-400 rounded-full text-xs font-black hover:bg-${color}-500 hover:text-white transition-all`}
                                                            >
                                                                {copyTipType === key && copyTip ? copyTip : t('copy_btn')}
                                                            </button>
                                                        </div>
                                                        <div className="flex-1 text-slate-200 text-base leading-relaxed"
                                                            dangerouslySetInnerHTML={{ __html: parseMarkdownToHtml(analysisResult.negotiation.styles[key] || '', key) }}>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* 书面邮件 */}
                                            <div id="email-section" className="glass-card p-10 shadow-2xl">
                                                <div className="flex justify-between items-center mb-6">
                                                    <h3 className="text-xl font-bold text-indigo-300 flex items-center gap-3">
                                                        <i data-lucide="mail" className="w-5 h-5"></i> {t('email_section')}
                                                    </h3>
                                                    <button
                                                        onClick={async () => { await navigator.clipboard.writeText(analysisResult.negotiation.email); setCopyTip(t('copied_btn')); setCopyTipType('email'); setTimeout(() => setCopyTip(''), 2000); }}
                                                        className="px-4 py-1.5 bg-indigo-500/15 text-indigo-400 rounded-full text-sm font-black hover:bg-indigo-500 hover:text-white transition-all"
                                                    >
                                                        {copyTipType === 'email' && copyTip ? copyTip : t('copy_full')}
                                                    </button>
                                                </div>
                                                <div className="bg-black/2 p-8 rounded-[1.5rem] text-base leading-relaxed text-slate-300 font-mono border border-white/5">
                                                    <pre className="whitespace-pre-wrap">{analysisResult.negotiation.email}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* ─── 修订合同 ─── */}
                                {activeTab === '修订合同' && (
                                    <div className="space-y-6 animate-fade">

                                        {/* 修订摘要 */}
                                        <div className="glass-card p-8 border-green-500/20 relative overflow-hidden">
                                            <div className="absolute -top-20 -right-20 w-60 h-60 bg-green-500/5 blur-[80px] rounded-full pointer-events-none"></div>
                                            <div className="flex items-start gap-5">
                                                <div className="w-14 h-14 rounded-2xl bg-green-500/20 border border-green-500/30 flex items-center justify-center shrink-0">
                                                    <i data-lucide="file-check-2" className="w-7 h-7 text-green-400"></i>
                                                </div>
                                                <div className="flex-1">
                                                    <h3 className="text-xl font-black text-green-500 mb-2">{t('revised_title')}</h3>
                                                    <p className="text-slate-300 text-base leading-relaxed">{analysisResult.revisionSummary || t('revised_desc')}</p>
                                                </div>
                                                <div className="flex gap-3 shrink-0">
                                                    <button
                                                        onClick={async () => { await navigator.clipboard.writeText(analysisResult.revisedContract||''); setCopyTip(t('copied_btn')); setCopyTipType('revised'); setTimeout(() => setCopyTip(''), 2000); }}
                                                        className="px-5 py-2 bg-green-500/15 text-green-500 rounded-full text-sm font-black hover:bg-green-500 hover:text-white transition-all"
                                                    >
                                                        {copyTipType === 'revised' && copyTip ? copyTip : t('copy_full2')}
                                                    </button>
                                                    <button
                                                        onClick={downloadRevisedContract}
                                                        className="px-5 py-2 bg-blue-500/15 text-blue-400 rounded-full text-sm font-black hover:bg-blue-500 hover:text-white transition-all"
                                                    >
                                                        {t('download_txt')}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* 子标签：合同 / 修订说明 */}
                                        <div className="flex gap-3">
                                            <button
                                                onClick={() => setRevisionView('contract')}
                                                className={`px-6 py-2.5 rounded-xl text-sm font-bold transition-all ${
                                                    revisionView === 'contract' 
                                                        ? 'bg-green-500/30 text-green-500 border border-green-500/50'   // 加深绿色
                                                        : 'text-slate-400 hover:bg-white/40'
                                                }`}
                                            >
                                                <i data-lucide="file-text" className="w-4 h-4 inline-block mr-2"></i>
                                                {t('revised_full_tab')}
                                            </button>

                                            {(analysisResult.revisionNotes||[]).length > 0 && (
                                                <button
                                                    onClick={() => setRevisionView('notes')}
                                                    className={`px-6 py-2.5 rounded-xl text-sm font-bold transition-all ${
                                                        revisionView === 'notes' 
                                                            ? 'bg-green-500/30 text-green-500 border border-green-500/50'   // 与合同按钮一致（绿色）
                                                            : 'text-slate-400 hover:bg-white/40'
                                                    }`}
                                                >
                                                    <i data-lucide="list-checks" className="w-4 h-4 inline-block mr-2"></i>
                                                    {t('revision_notes', analysisResult.revisionNotes.length)}
                                                </button>
                                            )}
                                        </div>

                                        {revisionView === 'contract' && (
                                            <div 
                                                className="revised-contract-box scrollbar-thin overflow-y-auto bg-white/60 text-slate-900 p-6 rounded-2xl"  // 浅白背景 + 深色文字
                                                style={{ maxHeight: '700px' }}
                                            >
                                                {analysisResult.revisedContract ? (
                                                    <div dangerouslySetInnerHTML={{ __html: renderRevisedContract(analysisResult.revisedContract) }} />
                                                ) : (
                                                    <div className="text-slate-500 italic text-center py-10">{t('no_revision')}</div>
                                                )}
                                            </div>
                                        )}

                                        {revisionView === 'notes' && (
                                            <div className="space-y-4 max-h-[700px] overflow-y-auto scrollbar-thin pr-2">
                                                {(analysisResult.revisionNotes||[]).map((note, i) => (
                                                    <div key={i} className="revision-note-card">
                                                        <div className="flex items-start gap-3">
                                                            <div className="w-6 h-6 rounded-full bg-green-500/30 border border-green-500/60 flex items-center justify-center text-[10px] font-black text-green-500 shrink-0">
                                                                {i+1}
                                                            </div>
                                                            <div>
                                                                <div className="text-green-650 font-bold text-sm mb-1">
                                                                    {note.clauseRef || t('revision_item_label', i)}
                                                                </div>
                                                                <div className="text-slate-300 text-sm leading-relaxed">
                                                                    {note.change}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* ─── ★ 增强 B: 案例分析 ─── */}
                                {activeTab === '案例分析' && (
                                    <div className="space-y-6 animate-fade">
                                        {analysisResult.caseAnalysis ? (
                                            <>
                                                {/* 整体司法风险 */}
                                                {analysisResult.caseAnalysis.caseInsight && (
                                                    <div className="glass-card p-8 border-amber-500/20 relative overflow-hidden">
                                                        <div className="absolute -top-20 -right-20 w-60 h-60 bg-amber-500/4 blur-[80px] rounded-full pointer-events-none"></div>
                                                        <div className="flex items-start gap-5">
                                                            <div className="w-14 h-14 rounded-2xl bg-amber-500/20 border border-amber-500/30 flex items-center justify-center shrink-0">
                                                                <i data-lucide="landmark" className="w-7 h-7 text-amber-400"></i>
                                                            </div>
                                                            <div>
                                                                <h3 className="text-xl font-black text-amber-400 mb-2">整体司法风险</h3>
                                                                <p className="text-slate-300 text-base leading-relaxed">{analysisResult.caseAnalysis.caseInsight}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* 相似案例列表 */}
                                                {(analysisResult.caseAnalysis.similarCases || []).length > 0 && (
                                                    <div>
                                                        <h3 className="text-lg font-black text-white mb-4 flex items-center gap-2">
                                                            <i data-lucide="search" className="w-5 h-5 text-amber-400"></i>
                                                            相似典型案例 ({analysisResult.caseAnalysis.similarCases.length})
                                                        </h3>
                                                        <div className="space-y-4">
                                                            {(analysisResult.caseAnalysis.similarCases || []).map((c, i) => (
                                                                <div key={i} className="case-card">
                                                                    <div className="flex items-start gap-4">
                                                                        <div className="w-10 h-10 rounded-2xl bg-amber-500/15 border border-amber-500/25 flex items-center justify-center shrink-0 text-sm font-black text-amber-400">{i+1}</div>
                                                                        <div className="flex-1 min-w-0">
                                                                            <div className="flex items-center gap-2 flex-wrap mb-2">
                                                                                <span className="font-black text-white text-base">{c.caseName || c.case_name}</span>
                                                                                {(c.similarity || c.相似度) && (
                                                                                    <span className={`text-sm font-black case-similarity-${(c.similarity || c.相似度)}`}>
                                                                                        相似度：{c.similarity || c.相似度}
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                            {(c.summary || c.案情摘要) && (
                                                                                <p className="text-slate-400 text-sm leading-relaxed mb-3">{c.summary || c.案情摘要}</p>
                                                                            )}
                                                                            <div className="grid md:grid-cols-2 gap-3">
                                                                                {(c.outcome || c.裁判结果) && (
                                                                                    <div className="p-3 bg-white/3 rounded-xl border border-white/5">
                                                                                        <div className="text-xs font-black text-amber-400 mb-1">⚖️ 裁判结果</div>
                                                                                        <div className="text-sm text-slate-300">{c.outcome || c.裁判结果}</div>
                                                                                    </div>
                                                                                )}
                                                                                {(c.advice || c.借鉴建议) && (
                                                                                    <div className="p-3 bg-white/3 rounded-xl border border-white/5">
                                                                                        <div className="text-xs font-black text-green-400 mb-1">💡 借鉴建议</div>
                                                                                        <div className="text-sm text-slate-300">{c.advice || c.借鉴建议}</div>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* 预测裁判结果 */}
                                                {analysisResult.caseAnalysis.predictedOutcome && (
                                                    <div className="glass-card p-8 border-purple-500/20">
                                                        <h3 className="text-lg font-black text-purple-400 mb-4 flex items-center gap-2">
                                                            <i data-lucide="trending-up" className="w-5 h-5"></i>
                                                            基于案例的裁判结果预测
                                                        </h3>
                                                        <p className="text-slate-300 text-base leading-relaxed">{analysisResult.caseAnalysis.predictedOutcome}</p>
                                                    </div>
                                                )}

                                                {/* 案例维度建议 */}
                                                {analysisResult.caseAnalysis.caseBasedAdvice && (
                                                    <div className="glass-card p-8 border-emerald-500/20">
                                                        <h3 className="text-lg font-black text-emerald-400 mb-4 flex items-center gap-2">
                                                            <i data-lucide="lightbulb" className="w-5 h-5"></i>
                                                            案例维度综合建议
                                                        </h3>
                                                        <p className="text-slate-300 text-base leading-relaxed">{analysisResult.caseAnalysis.caseBasedAdvice}</p>
                                                    </div>
                                                )}
                                            </>
                                        ) : (
                                            <div className="glass-card p-16 text-center">
                                                <div className="empty-illus mx-auto mb-4">🏛️</div>
                                                <p className="text-slate-500 text-base">暂无相关典型案例数据</p>
                                                <p className="text-slate-600 text-sm mt-2">知识库中尚未收录本类别的典型案例，或本合同暂无高度相似案例</p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* ─── ★ 增强 C: 律师审查 ─── */}
                                {activeTab === '律师审查' && (
                                    <div className="space-y-6 animate-fade">
                                        {lawyerReviewStatus === 'idle' ? (
                                            <div className="glass-card p-12 text-center space-y-6">
                                                <div className="w-20 h-20 rounded-3xl bg-amber-500/15 border border-amber-500/25 flex items-center justify-center mx-auto">
                                                    <i data-lucide="scale" className="w-10 h-10 text-amber-400"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-2xl font-black text-white mb-3">律师专业审查</h3>
                                                    <p className="text-slate-400 text-base max-w-lg mx-auto leading-relaxed">
                                                        提交申请后，平台将为您匹配专业律师进行人工审核，律师将对 AI 分析结论进行验证、修订或推翻，并出具专业法律意见。
                                                    </p>
                                                </div>
                                                {analysisResult.riskScore >= 75 && (
                                                    <div className="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-bold text-amber-400" style={{background:'rgba(251,191,36,0.08)',border:'1px solid rgba(251,191,36,0.2)'}}>
                                                        <i data-lucide="alert-triangle" className="w-4 h-4"></i>
                                                        风险分 {analysisResult.riskScore}，建议申请律师审查
                                                    </div>
                                                )}
                                                <button
                                                    className="lawyer-review-btn mx-auto text-base px-8 py-4"
                                                    onClick={() => {
                                                        if (!currentUser) { setShowLogin(true); return; }
                                                        setShowLawyerModal(true);
                                                    }}
                                                >
                                                    <i data-lucide="user-check" className="w-5 h-5"></i>
                                                    申请律师审查
                                                </button>
                                                {!currentUser && <p className="text-xs text-slate-600">请先登录后申请</p>}
                                            </div>
                                        ) : lawyerReviewStatus === 'requesting' ? (
                                            <div className="glass-card p-12 text-center">
                                                <div className="w-14 h-14 rounded-full border-4 border-amber-500/30 border-t-amber-400 animate-spin mx-auto mb-4"></div>
                                                <p className="text-slate-300 font-bold">正在为您匹配专业律师...</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                <div className="review-status-card review-status-pending">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-12 h-12 rounded-2xl bg-emerald-500/15 border border-emerald-500/25 flex items-center justify-center">
                                                            <i data-lucide="check-circle" className="w-6 h-6 text-emerald-400"></i>
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="font-black text-emerald-400 text-lg mb-1">审查申请已提交</div>
                                                            <div className="text-slate-400 text-sm">审查编号：<span className="font-mono text-slate-300">{lawyerReviewId}</span></div>
                                                            <div className="text-slate-500 text-xs mt-1">律师将在 24 小时内接单，审查完成后您将收到通知</div>
                                                        </div>
                                                        <div className="text-xs px-3 py-1.5 rounded-xl font-bold text-indigo-300" style={{background:'rgba(99,102,241,0.1)',border:'1px solid rgba(99,102,241,0.2)'}}>
                                                            ⏳ 待接单
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="glass-card p-6 space-y-3">
                                                    <h4 className="font-black text-white flex items-center gap-2">
                                                        <i data-lucide="info" className="w-4 h-4 text-blue-400"></i>审查流程说明
                                                    </h4>
                                                    {[
                                                        { step: 1, label: '律师接单', desc: '平台根据合同类型自动匹配专业律师' },
                                                        { step: 2, label: '人工审阅', desc: '律师仔细审阅合同内容与 AI 分析结论' },
                                                        { step: 3, label: '出具意见', desc: '律师提交专业法律意见，可认可、修订或推翻 AI 结论' },
                                                        { step: 4, label: '结果交付', desc: '您将在「个人中心 → 律师审查记录」查看完整报告' },
                                                    ].map(s => (
                                                        <div key={s.step} className="flex items-start gap-3">
                                                            <div className="w-6 h-6 rounded-full bg-indigo-500/20 border border-indigo-500/30 flex items-center justify-center text-[10px] font-black text-indigo-400 shrink-0 mt-0.5">{s.step}</div>
                                                            <div>
                                                                <span className="font-bold text-sm text-white">{s.label}</span>
                                                                <span className="text-slate-500 text-sm ml-2">{s.desc}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* ══════════════════════════════════════════════════ */}
                                {/* ★ 增强 A v4.0: 辩论仲裁记录 Tab                   */}
                                {/* ══════════════════════════════════════════════════ */}
                                {activeTab === '辩论记录' && (
                                    <div className="space-y-8 animate-fade">

                                        {/* 辩论摘要统计栏 */}
                                        {analysisResult._debate_summary && (
                                            <div className="debate-summary-bar">
                                                <div className="flex items-center gap-2 mr-2">
                                                    <i data-lucide="scale" className="w-5 h-5 text-amber-400"></i>
                                                    <span className="text-sm font-black text-amber-400">辩论仲裁摘要</span>
                                                </div>
                                                <div className="w-px h-8 bg-white/10 mx-1"></div>
                                                {[
                                                    { n: analysisResult._debate_summary.debated_count,  lbl: '已辩议题',  cls: 'debated-count' },
                                                    { n: analysisResult._debate_summary.upgrades,       lbl: '风险升级',  cls: 'upgrade-count' },
                                                    { n: analysisResult._debate_summary.downgrades,     lbl: '风险降级',  cls: 'downgrade-count' },
                                                    { n: analysisResult._debate_summary.maintained,     lbl: '评级维持',  cls: 'maintain-count' },
                                                    { n: analysisResult._debate_summary.skipped_count,  lbl: '保留初稿',  cls: 'maintain-count' },
                                                ].map(stat => (
                                                    <div key={stat.lbl} className="debate-stat">
                                                        <span className={`debate-stat-n ${stat.cls}`}>{stat.n ?? 0}</span>
                                                        <span className="debate-stat-lbl">{stat.lbl}</span>
                                                    </div>
                                                ))}
                                                <div className="ml-auto text-right">
                                                    <div className="text-xs text-slate-600">辩论庭组成</div>
                                                    <div className="text-xs text-slate-400 font-mono mt-0.5">
                                                        {analysisResult._debate_summary.roles?.counsel_a}
                                                        <span className="text-slate-600 mx-1">vs</span>
                                                        {analysisResult._debate_summary.roles?.counsel_b}
                                                        <span className="text-slate-600 mx-1">→</span>
                                                        {analysisResult._debate_summary.roles?.arbitrator}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* 三方角色说明卡 */}
                                        <div className="grid grid-cols-3 gap-4">
                                            {[
                                                { role: 'counsel_a', label: '甲方律师', desc: '为合同签署方辩护，寻找有利法律解释，质疑风险结论', color: '#60a5fa', bg: 'rgba(59,130,246,0.07)', border: 'rgba(59,130,246,0.2)', icon: 'briefcase' },
                                                { role: 'counsel_b', label: '乙方律师', desc: '代表对手方，强化风险论据，援引不利法条与判例',      color: '#f87171', bg: 'rgba(239,68,68,0.07)',   border: 'rgba(239,68,68,0.2)',   icon: 'gavel' },
                                                { role: 'arbitrator', label: '仲裁官',  desc: '中立裁判双方论点，输出最终裁定并修正风险等级',        color: '#fbbf24', bg: 'rgba(245,158,11,0.07)', border: 'rgba(245,158,11,0.2)', icon: 'scale' },
                                            ].map(r => (
                                                <div key={r.role} className="glass-card p-5 text-center" style={{borderColor: r.border, background: r.bg}}>
                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center mx-auto mb-3"
                                                        style={{background: r.bg, border: `1px solid ${r.border}`}}>
                                                        <i data-lucide={r.icon} className="w-5 h-5" style={{color: r.color}}></i>
                                                    </div>
                                                    <div className="font-black text-sm mb-1" style={{color: r.color}}>{r.label}</div>
                                                    <div className="text-xs text-slate-500 leading-relaxed">{r.desc}</div>
                                                    {analysisResult._debate_summary?.roles?.[r.role] && (
                                                        <div className="mt-2 text-[10px] font-mono px-2 py-0.5 rounded-full inline-block"
                                                            style={{background:'rgba(255,255,255,0.7)', color:'#475569', border:'1px solid rgba(0,0,0,0.09)'}}>
                                                            {analysisResult._debate_summary.roles[r.role]}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>

                                        {/* 各议题辩论详情 */}
                                        {analysisResult.issues?.filter(iss => iss._debated).map(iss => (
                                            <div key={iss.id} className="debate-panel">
                                                {/* 议题标题行 */}
                                                <div className="debate-panel-header cursor-pointer"
                                                    onClick={() => setDebateExpandedIssue(debateExpandedIssue === iss.id ? null : iss.id)}>
                                                    <div className={`w-2.5 h-2.5 rounded-full shrink-0 ${getRiskColor(iss.severity)}`}></div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center gap-2 flex-wrap">
                                                            <span className="font-black text-sm text-white">{iss.title}</span>
                                                            <span className={`verdict-badge ${
                                                                iss._arbitrator_verdict?.severity_adjustment === '升级' ? 'verdict-upgraded' :
                                                                iss._arbitrator_verdict?.severity_adjustment === '降级' ? 'verdict-downgraded' :
                                                                'verdict-maintained'
                                                            }`}>
                                                                {iss._arbitrator_verdict?.severity_adjustment === '升级' ? '↑ 升级' :
                                                                 iss._arbitrator_verdict?.severity_adjustment === '降级' ? '↓ 降级' : '= 维持'}
                                                            </span>
                                                            {iss._original_severity && iss._original_severity !== iss.severity && (
                                                                <span className="text-[10px] text-slate-500">
                                                                    {iss._original_severity} → <span className="font-black text-white">{iss.severity}</span>
                                                                </span>
                                                            )}
                                                            <span className={`confidence-badge ml-auto ${iss.confidence_score >= 0.7 ? 'confidence-high' : iss.confidence_score >= 0.4 ? 'confidence-medium' : 'confidence-low'}`}>
                                                                {Math.round((iss.confidence_score || 0) * 100)}%
                                                            </span>
                                                        </div>
                                                        {iss._arbitrator_verdict?.final_reasoning && (
                                                            <div className="text-xs text-slate-500 mt-0.5 truncate">
                                                                仲裁摘要：{iss._arbitrator_verdict.final_reasoning.slice(0, 80)}...
                                                            </div>
                                                        )}
                                                    </div>
                                                    <i data-lucide={debateExpandedIssue === iss.id ? 'chevron-up' : 'chevron-down'}
                                                        className="w-4 h-4 text-slate-600 shrink-0 ml-2"></i>
                                                </div>

                                                {/* 展开详情 */}
                                                {debateExpandedIssue === iss.id && iss._debate_rounds && (
                                                    <div className="p-5 space-y-5">
                                                        {/* 轮次切换 */}
                                                        {iss._debate_rounds.length > 1 && (
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs text-slate-600 font-bold">辩论轮次：</span>
                                                                {iss._debate_rounds.map(r => (
                                                                    <button key={r.round}
                                                                        className={`round-tab ${(debateActiveRound[iss.id] || 1) === r.round ? 'active' : ''}`}
                                                                        onClick={() => setDebateActiveRound(prev => ({...prev, [iss.id]: r.round}))}>
                                                                        第 {r.round} 轮
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        )}

                                                        {/* 甲乙双方论述（双栏布局） */}
                                                        {(() => {
                                                            const round = iss._debate_rounds.find(r => r.round === (debateActiveRound[iss.id] || 1)) || iss._debate_rounds[0];
                                                            return (
                                                                <div className="grid md:grid-cols-2 gap-4">
                                                                    <div className="debate-col">
                                                                        <div className="bubble-counsel-a debate-bubble">
                                                                            <div className="role-label role-label-a">
                                                                                <i data-lucide="briefcase" className="w-3 h-3"></i>
                                                                                甲方律师
                                                                                {analysisResult._debate_summary?.roles?.counsel_a && (
                                                                                    <span className="text-slate-600 normal-case ml-1">
                                                                                        ({analysisResult._debate_summary.roles.counsel_a})
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                            <div className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">
                                                                                {round.counsel_a_arg}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="debate-col">
                                                                        <div className="bubble-counsel-b debate-bubble">
                                                                            <div className="role-label role-label-b">
                                                                                <i data-lucide="gavel" className="w-3 h-3"></i>
                                                                                乙方律师
                                                                                {analysisResult._debate_summary?.roles?.counsel_b && (
                                                                                    <span className="text-slate-600 normal-case ml-1">
                                                                                        ({analysisResult._debate_summary.roles.counsel_b})
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                            <div className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">
                                                                                {round.counsel_b_arg}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}

                                                        {/* 仲裁官裁定 */}
                                                        {iss._arbitrator_verdict && (
                                                            <div className="verdict-card">
                                                                <div className="flex items-center gap-2 mb-4">
                                                                    <div className="w-8 h-8 rounded-xl bg-amber-500/15 border border-amber-500/25 flex items-center justify-center">
                                                                        <i data-lucide="scale" className="w-4 h-4 text-amber-400"></i>
                                                                    </div>
                                                                    <div>
                                                                        <div className="role-label role-label-arb" style={{marginBottom:0}}>
                                                                            仲裁官裁定
                                                                            {iss._arbitrator_verdict.model && (
                                                                                <span className="text-slate-600 normal-case ml-1">
                                                                                    ({iss._arbitrator_verdict.model})
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                    <span className={`verdict-badge ml-auto ${
                                                                        iss._arbitrator_verdict.severity_adjustment === '升级' ? 'verdict-upgraded' :
                                                                        iss._arbitrator_verdict.severity_adjustment === '降级' ? 'verdict-downgraded' :
                                                                        'verdict-maintained'
                                                                    }`}>
                                                                        {iss._arbitrator_verdict.upheld_severity} ·
                                                                        {iss._arbitrator_verdict.severity_adjustment === '升级' ? ' ↑ 风险升级' :
                                                                         iss._arbitrator_verdict.severity_adjustment === '降级' ? ' ↓ 风险降级' :
                                                                         ' = 评级维持'}
                                                                    </span>
                                                                </div>

                                                                {/* 裁定理由 */}
                                                                {iss._arbitrator_verdict.final_reasoning && (
                                                                    <div className="bubble-arbitrator debate-bubble mb-4">
                                                                        <div className="text-slate-200 text-sm leading-relaxed">
                                                                            {iss._arbitrator_verdict.final_reasoning}
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* 认可 vs 驳回 论点 */}
                                                                <div className="grid md:grid-cols-2 gap-3 mb-4">
                                                                    {iss._arbitrator_verdict.key_points_upheld?.length > 0 && (
                                                                        <div>
                                                                            <div className="text-xs font-black text-emerald-400 mb-2 flex items-center gap-1">
                                                                                <i data-lucide="check-circle-2" className="w-3 h-3"></i>
                                                                                仲裁认可论点
                                                                            </div>
                                                                            {iss._arbitrator_verdict.key_points_upheld.map((pt, i) => (
                                                                                <div key={i} className="verdict-point-upheld flex items-start gap-1.5 mb-1">
                                                                                    <span className="shrink-0 mt-0.5">✓</span>
                                                                                    <span>{pt}</span>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                    {iss._arbitrator_verdict.key_points_rejected?.length > 0 && (
                                                                        <div>
                                                                            <div className="text-xs font-black text-red-400 mb-2 flex items-center gap-1">
                                                                                <i data-lucide="x-circle" className="w-3 h-3"></i>
                                                                                仲裁驳回论点
                                                                            </div>
                                                                            {iss._arbitrator_verdict.key_points_rejected.map((pt, i) => (
                                                                                <div key={i} className="verdict-point-rejected flex items-start gap-1.5 mb-1">
                                                                                    <span className="shrink-0 mt-0.5">✗</span>
                                                                                    <span>{pt}</span>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>

                                                                {/* 仲裁后行动建议 */}
                                                                {iss._arbitrator_verdict.consensus_whatToDo?.length > 0 && (
                                                                    <div>
                                                                        <div className="text-xs font-black text-indigo-400 mb-2 flex items-center gap-1">
                                                                            <i data-lucide="zap" className="w-3 h-3"></i>
                                                                            仲裁后行动建议
                                                                        </div>
                                                                        {iss._arbitrator_verdict.consensus_whatToDo.map((action, i) => (
                                                                            <div key={i} className="flex items-start gap-2 mb-1.5 text-sm text-slate-300">
                                                                                <span className="text-indigo-400 font-black shrink-0">{i+1}.</span>
                                                                                <span>{action}</span>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        ))}

                                        {/* 未辩论议题列表 */}
                                        {analysisResult.issues?.some(iss => !iss._debated) && (
                                            <div>
                                                <h4 className="text-xs font-black text-slate-500 uppercase tracking-widest mb-3">其余议题（保留并行初稿，未进入辩论庭）</h4>
                                                <div className="space-y-2">
                                                    {analysisResult.issues.filter(iss => !iss._debated).map(iss => (
                                                        <div key={iss.id} className="flex items-center gap-3 glass-card p-4 opacity-60">
                                                            <div className={`w-2 h-2 rounded-full ${getRiskColor(iss.severity)}`}></div>
                                                            <span className="text-sm text-slate-400 flex-1">{iss.title}</span>
                                                            <span className="text-[10px] text-slate-600 font-bold">{iss.severity}</span>
                                                            <span className="text-[10px] text-slate-700">并行初稿</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* 辩论未启用提示 */}
                                        {!analysisResult.issues?.some(iss => iss._debated) && (
                                            <div className="glass-card p-12 text-center space-y-4">
                                                <div className="w-16 h-16 rounded-3xl bg-slate-700/40 flex items-center justify-center mx-auto">
                                                    <i data-lucide="scale" className="w-8 h-8 text-slate-500"></i>
                                                </div>
                                                <h3 className="text-xl font-black text-slate-400">辩论模式未启用</h3>
                                                <p className="text-slate-600 text-sm max-w-sm mx-auto leading-relaxed">
                                                    本次分析使用了并行快思考模式。<br/>
                                                    在服务器端设置 <code className="text-indigo-400">ENABLE_DEBATE_MODE=true</code> 以开启三方辩论仲裁，
                                                    对高危风险点进行 System 2 深度校验。
                                                </p>
                                                <div className="flex items-center justify-center gap-4 mt-4 text-xs text-slate-600">
                                                    <span className="flex items-center gap-1"><span style={{color:'#60a5fa'}}>⚖</span> 甲方律师 · 挑战风险</span>
                                                    <span>vs</span>
                                                    <span className="flex items-center gap-1"><span style={{color:'#f87171'}}>⚖</span> 乙方律师 · 强化论据</span>
                                                    <span>→</span>
                                                    <span className="flex items-center gap-1"><span style={{color:'#fbbf24'}}>🔨</span> 仲裁官 · 最终裁定</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* 重新开始 */}
                                <div className="mt-16 text-center pb-32 space-y-4">
                                    <button onClick={() => {
                                        if (pollingRef.current) clearInterval(pollingRef.current);
                                        setStep('categorySelect');
                                        setSelectedCategory(null);
                                        setContractText('');
                                        setExtractedText('');
                                        setAnalysisResult(null);
                                        setActiveTab('合同总览');
                                        setSelectedIssue(null);
                                        setFileInfo(null);
                                        setProgress('');
                                        setProgressStage(0);
                                        setExpandedCat([]);
                                        setLawyerReviewStatus('idle');   // ★ 重置律师状态
                                        setLawyerReviewId(null);
                                        setLawyerNotes('');
                                    }}
                                        className="px-20 py-5 rounded-2xl font-black text-xl hover:scale-105 active:scale-95 transition-all"
                                        style={{background:'white', color:'#0f172a', boxShadow:'0 20px 60px rgba(255,255,255,0.12), 0 4px 16px rgba(0,0,0,0.3)'}}>
                                        {t('restart_btn')}
                                    </button>
                                    <p className="text-xs text-slate-600">审查结果已保存至账号 &nbsp;<span className="kbd">Esc</span> 关闭弹窗</p>
                                </div>
                            </div>
                        )}

                        {/* 页脚 */}
                        {/* 页脚 - 使用 Inter 字体 */}
                        <footer className="mt-auto py-8" style={{borderTop:'1px solid rgba(0,0,0,0.08)', marginTop:'7rem'}}>
                            <div className="flex flex-col md:flex-row items-center justify-between gap-3 text-xs font-medium uppercase tracking-[0.3em]"
                                style={{
                                    color: 'rgba(71,85,105,0.5)',
                                    fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif"
                                }}>
                                <div className="flex items-center gap-3">
                                    <div className="w-5 h-5 rounded-lg flex items-center justify-center" style={{background:'linear-gradient(135deg,#3b82f6,#8b5cf6)', boxShadow:'0 0 10px rgba(99,102,241,0.3)'}}>
                                        <i data-lucide="scale" className="w-3 h-3 text-white/80"></i>  {/* 图标变浅 */}
                                    </div>
                                    <span style={{color:'rgba(51,65,85,0.5)'}}>对簿AI · ContractClarity</span>  {/* 文字变浅 */}
                                </div>
                                <div className="flex items-center gap-4" style={{color:'rgba(51,65,85,0.4)'}}>
                                    <span>© 2026 Mole Lab</span>
                                    <span style={{color:'rgba(51,65,85,0.25)'}}>|</span>
                                    <span>Multi-Model · Case DB · Expert Review</span>
                                </div>
                            </div>
                        </footer>
                    </div>

                    {/* ★ 增强 C: 律师审查申请弹窗 */}
                    {showLawyerModal && analysisResult && (
                        <div className="lawyer-modal-overlay" onClick={e => { if (e.target === e.currentTarget) setShowLawyerModal(false); }}>
                            <div className="lawyer-modal">
                                <div className="px-8 pt-8 pb-6 text-center relative" style={{background:'linear-gradient(135deg,rgba(245,158,11,0.08),rgba(234,88,12,0.08))',borderBottom:'1px solid rgba(255,255,255,0.05)'}}>
                                    <button onClick={() => setShowLawyerModal(false)} className="absolute top-4 right-4 w-8 h-8 rounded-full flex items-center justify-center text-slate-500 hover:text-white hover:bg-white/10 transition-all">
                                        <i data-lucide="x" className="w-4 h-4"></i>
                                    </button>
                                    <div className="w-14 h-14 rounded-2xl bg-amber-500/20 border border-amber-500/30 flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="scale" className="w-7 h-7 text-amber-400"></i>
                                    </div>
                                    <h3 className="text-2xl font-black text-white">申请律师专业审查</h3>
                                    <p className="text-slate-500 text-sm mt-1">律师将对 AI 分析结论进行人工验证</p>
                                </div>
                                <div className="px-8 py-6">
                                    <div className="p-4 rounded-2xl mb-5" style={{background:'rgba(0,0,0,0.03)',border:'1px solid rgba(0,0,0,0.08)'}}>
                                        {[
                                            ['合同类型', analysisResult.contractType || getCatName(selectedCategory)],
                                            ['风险评分', `${analysisResult.riskScore}/100`],
                                            ['风险条款', `${analysisResult.issues?.length || 0} 处`],
                                            ...(analysisResult._models_used?.length > 0 ? [['AI 审查团', analysisResult._models_used.join('、')]] : []),
                                        ].map(([k, v], i) => (
                                            <div key={i} className={`flex items-center justify-between text-sm ${i > 0 ? 'mt-2' : ''}`}>
                                                <span className="text-slate-400">{k}</span>
                                                <span className={`font-bold ${k === '风险评分' && analysisResult.riskScore >= 75 ? 'text-red-400' : 'text-white'}`}>{v}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <label className="block text-sm font-black text-slate-300 mb-2">重点关注内容（选填）</label>
                                    <textarea
                                        value={lawyerNotes}
                                        onChange={e => setLawyerNotes(e.target.value)}
                                        className="w-full h-24 bg-white/5 border border-white/10 rounded-2xl p-4 text-sm text-slate-200 placeholder:text-slate-600 resize-none focus:outline-none focus:border-amber-500/40 transition-all"
                                        placeholder="请填写希望律师重点关注的条款或疑问，例如：第3条违约金是否合理、竞业限制条款是否有效等..."
                                        maxLength={500}
                                    />
                                    <div className="text-right text-xs text-slate-600 mt-1 mb-5">{lawyerNotes.length}/500</div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setShowLawyerModal(false)}
                                            className="flex-1 py-3.5 rounded-2xl font-bold text-sm text-slate-400 hover:text-slate-200 transition-all"
                                            style={{background:'rgba(255,255,255,0.7)',border:'1px solid rgba(0,0,0,0.09)'}}>
                                            取消
                                        </button>
                                        <button onClick={requestLawyerReview} disabled={lawyerReviewStatus === 'requesting'}
                                            className="flex-[2] lawyer-review-btn justify-center py-3.5 text-sm rounded-2xl">
                                            <i data-lucide="user-check" className="w-4 h-4"></i>
                                            {lawyerReviewStatus === 'requesting' ? '提交中...' : '确认申请律师审查'}
                                        </button>
                                    </div>
                                    <p className="text-center text-xs text-slate-600 mt-3">律师将在 24 小时内接单处理</p>
                                </div>
                            </div>
                        </div>
                    )}
                </React.Fragment>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
